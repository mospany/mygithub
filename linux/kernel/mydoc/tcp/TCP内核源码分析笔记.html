<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>TCP内核源码分析笔记</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="TCP内核源码分析笔记"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2014-10-15T11:03+0800"/>
<meta name="author" content="mosp"/>
<meta name="description" content=""/>
<meta name="keywords" content="linux, kernel, tcp, 读书笔记， 网络管理"/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="/home/mosp/.emacs.d/style/style.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">TCP内核源码分析笔记</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 术语</a>
<ul>
<li><a href="#sec-1-1">1.1 ABC</a></li>
<li><a href="#sec-1-2">1.2 SACK</a></li>
<li><a href="#sec-1-3">1.3 D-SACK</a></li>
<li><a href="#sec-1-4">1.4 FACK</a></li>
<li><a href="#sec-1-5">1.5 F-RTO</a></li>
<li><a href="#sec-1-6">1.6 nagle算法</a></li>
<li><a href="#sec-1-7">1.7 cork算法</a></li>
<li><a href="#sec-1-8">1.8 template</a></li>
</ul>
</li>
<li><a href="#sec-2">2 tcp_v4_connect()</a></li>
<li><a href="#sec-3">3 sys_accept()</a>
<ul>
<li><a href="#sec-3-1">3.1 tcp_accept()</a></li>
</ul>
</li>
<li><a href="#sec-4">4 三次握手</a>
<ul>
<li><a href="#sec-4-1">4.1 客户端发送SYN段</a></li>
<li><a href="#sec-4-2">4.2 服务端接收到SYN段后，发送SYN/ACK处理</a></li>
<li><a href="#sec-4-3">4.3 客户端回复确认ACK段</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1 tcp_rcv_synsent_state_process()</a></li>
</ul>
</li>
<li><a href="#sec-4-4">4.4 服务端收到ACK段</a></li>
</ul>
</li>
<li><a href="#sec-5">5 数据传输</a>
<ul>
<li><a href="#sec-5-1">5.1 客户端请求数据</a>
<ul>
<li><a href="#sec-5-1-1">5.1.1 send()</a></li>
<li><a href="#sec-5-1-2">5.1.2 sendto()</a></li>
<li><a href="#sec-5-1-3">5.1.3 __sys_sendmsg()</a></li>
<li><a href="#sec-5-1-4">5.1.4 tcp_sendmsg():</a></li>
</ul>
</li>
<li><a href="#sec-5-2">5.2 服务端响应请求</a></li>
</ul>
</li>
<li><a href="#sec-6">6 第25章 传输控制块</a>
<ul>
<li><a href="#sec-6-1">6.1 25.4 传输控制块的内存管理</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1 25.4.4 接收缓存的分配与释放</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-7">7 第29章 拥塞控制</a>
<ul>
<li><a href="#sec-7-1">7.1 拥塞状态</a></li>
<li><a href="#sec-7-2">7.2 cwnd初始值</a></li>
</ul>
</li>
<li><a href="#sec-8">8 第30章 TCP的输出</a>
<ul>
<li><a href="#sec-8-1">8.1 tcp_sendmsg()</a>
<ul>
<li><a href="#sec-8-1-1">8.1.1 tcp_write_xmit()</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 术语</h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> ABC</h3>
<div class="outline-text-3" id="text-1-1">

<ul>
<li>英文全称：Appropriate Byte Count<br/>
</li>
<li>中文全称: 适当字节计数<br/>
</li>
<li>功能描述: ABC是一种针对于部分确认应答的更慢地增加拥塞窗口(cwnd)的方法。<br/>
     可能的值为：<br/>
<ul>
<li>0: 每一个应答增加拥塞窗口一次(无ABC)<br/>
</li>
<li>1: 每一个最大传输段应答增加拥塞窗口一次<br/>
</li>
<li>2：允许增加拥塞控制窗口两次，如果应答是为了补偿延时应答的针对两个段的应答。<br/>
</li>
</ul>

</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> SACK</h3>
<div class="outline-text-3" id="text-1-2">

<ul>
<li>英文全称: Selective Acknowledgment.<br/>
</li>
<li>中文全称: 选择性确认<br/>
</li>
<li>功能描述: SACK是TCP选项，它使得接收方能告诉发送方哪些报文段丢失，哪些报文段重传了，哪些报文段已经提前收到等信息。<br/>
     根据这些信息TCP就可以只重传哪些真正丢失的报文段。需要注意的是只有收到失序的分组时才会可能会发送SACK，TCP的ACK还<br/>
     是建立在累积确认的基础上的。也就是说如果收到的报文段与期望收到的报文段的序号相同就会发送累积的ACK，SACK只是针对<br/>
     失序到达的报文段的。<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> D-SACK</h3>
<div class="outline-text-3" id="text-1-3">

<ul>
<li>英文全称: duplicate-Selective Acknowledgment.<br/>
</li>
<li>中文全称: 重复的SACK<br/>
</li>
<li>功能描述: RFC2883中对SACK进行了扩展。SACK中的信息描述的是收到的报文段，这些报文段可能是正常接收的，也可能是重复接收的，<br/>
     通过对SACK进行扩展，D-SACK可以在SACK选项中描述它重复收到的报文段。但是需要注意的是D-SACK只用于报告接收端收到的最后一<br/>
     个报文与已经接收了的报文的重复部分<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> FACK</h3>
<div class="outline-text-3" id="text-1-4">

<ul>
<li>英文全称: Forward Acknowledgment<br/>
</li>
<li>中文全称: 提前确认<br/>
</li>
<li>功能描述: FACK算法采取激进策略，将所有SACK的未确认区间当做丢失段。虽然这种策略通常带来更佳的网络性能，但是过于激进，因为SACK未确认的区间段可能只是发送了重排，而并非丢失<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> F-RTO</h3>
<div class="outline-text-3" id="text-1-5">

<ul>
<li>英文全称: Forward RTO Recovery<br/>
</li>
<li>中文全称: 虚假超时<br/>
</li>
<li>功能描述: F-RTO的基本思想是判断RTO是否正常，从而决定是否执行拥塞避免算法。方法是观察RTO之后的两个ACK。如果ACK不是冗余ACK，并且确认的包不是重传<br/>
     的，会认为RTO是虚假的就不执行拥塞避免算法。<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> nagle算法</h3>
<div class="outline-text-3" id="text-1-6">

<ul>
<li>功能描述: nagle算法主要目的是减少网络流量，当你发送的数据包太小时，TCP并不立即发送该数据包，而是缓存起来直到数据包到达一定大小后才发送。<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> cork算法</h3>
<div class="outline-text-3" id="text-1-7">

<ul>
<li>功能描述: CORK算法的初衷：提高网络利用率，理想情况下，完全避免发送小包，仅仅发送满包以及不得不发的小包。<br/>
</li>
</ul>


<p>     <br/>
</p>
<p>     <br/>
</p></div>

</div>

<div id="outline-container-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> template</h3>
<div class="outline-text-3" id="text-1-8">

<ul>
<li>英文全称:<br/>
</li>
<li>中文全称:<br/>
</li>
<li>功能描述:<br/>
</li>
</ul>


<p>     <br/>
</p>
<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> tcp_v4_connect()</h2>
<div class="outline-text-2" id="text-2">

<ul>
<li>描述: 建立与服务器连接，发送SYN段<br/>
</li>
<li>返回值: 0或错误码<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_v4_connect</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">uaddr</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">addr_len</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #8b6508;">.....</span><span style="color: #008000;">&#12288;</span>     
<span class="linenr"> 4:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#30446;&#30340;&#22320;&#22336;&#21644;&#30446;&#26631;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 5:  </span>    inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">dport</span> <span style="color: #8b6508;">=</span> usin<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sin_port</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>    inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">daddr</span> <span style="color: #8b6508;">=</span> daddr<span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>    <span style="color: #8b6508;">....</span>     
<span class="linenr"> 8:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;MSS&#19978;&#38480; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">536</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>
<span class="linenr">11:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Socket identity is still unknown (sport may be zero).</span>
<span class="linenr">12:  </span><span style="color: #b22222;">     * However we set state to SYN-SENT and not releasing socket</span>
<span class="linenr">13:  </span><span style="color: #b22222;">     * lock select source port, enter ourselves into the hash tables and</span>
<span class="linenr">14:  </span><span style="color: #b22222;">     * complete initialization after this.</span>
<span class="linenr">15:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">16:  </span>    <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_SYN_SENT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#29366;&#24577; </span><span style="color: #b22222;">*/</span>
<span class="linenr">17:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_v4_hash_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23558;&#20256;&#36755;&#25511;&#21046;&#28155;&#21152;&#21040;ehash&#25955;&#21015;&#34920;&#20013;&#65292;&#24182;&#21160;&#24577;&#20998;&#37197;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr">18:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span>
<span class="linenr">19:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">failure</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    <span style="color: #8b6508;">....</span>
<span class="linenr">21:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36824;&#26410;&#35745;&#31639;&#21021;&#22987;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">22:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#21452;&#26041;&#22320;&#22336;&#12289;&#31471;&#21475;&#35745;&#31639;&#21021;&#22987;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">23:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">secure_tcp_sequence_number</span><span style="color: #cd2626;">(</span>inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">saddr</span><span style="color: #8b6508;">,</span>
<span class="linenr">24:  </span>                               inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">daddr</span><span style="color: #8b6508;">,</span>
<span class="linenr">25:  </span>                               inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sport</span><span style="color: #8b6508;">,</span>
<span class="linenr">26:  </span>                               usin<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sin_port</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>
<span class="linenr">28:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#21021;&#22987;&#24207;&#21495;&#21644;&#24403;&#21069;&#26102;&#38388;&#65292;&#38543;&#26426;&#31639;&#19968;&#20010;&#21021;&#22987;id </span><span style="color: #b22222;">*/</span>
<span class="linenr">29:  </span>    inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">id</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span> <span style="color: #8b6508;">^</span> jiffies<span style="color: #8b6508;">;</span>
<span class="linenr">30:  </span>
<span class="linenr">31:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">32:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">33:  </span>    rt <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">34:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span>
<span class="linenr">35:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">failure</span><span style="color: #8b6508;">;</span>
<span class="linenr">36:  </span>
<span class="linenr">37:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">38:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> sys_accept()</h2>
<div class="outline-text-2" id="text-3">

<ul>
<li>描述: 调用tcp_accept(), 并把它返回的newsk进行连接描述符分配后返回给用户空间。<br/>
</li>
<li>返回值: 连接描述符<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span>asmlinkage <span style="color: #228b22;">long</span> <span style="color: #0000ff; font-size: 120%;">sys_accept</span><span style="color: #cd2626;">(</span><span style="color: #228b22;">int</span> <span style="color: #a0522d;">fd</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">upeer_sockaddr</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*</span>upeer_addrlen<span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">socket</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sock</span><span style="color: #8b6508;">,</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">newsock</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>    <span style="color: #8b6508;">.....</span>     
<span class="linenr"> 5:  </span>    sock <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sockfd_lookup</span><span style="color: #cd2626;">(</span>fd<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>err<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#24471;&#20390;&#21548;&#31471;&#21475;&#30340;socket </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>    <span style="color: #8b6508;">.....</span>    
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>newsock <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_alloc</span><span style="color: #cd2626;">()))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#19968;&#20010;&#26032;&#30340;&#22871;&#25509;&#21475;&#65292;&#29992;&#26469;&#22788;&#29702;&#19982;&#23458;&#25143;&#31471;&#30340;&#36830;&#25509; </span><span style="color: #b22222;">*/</span> 
<span class="linenr"> 8:  </span>    <span style="color: #8b6508;">.....</span>     
<span class="linenr"> 9:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35843;&#29992;&#20256;&#36755;&#23618;&#30340;accept&#65292;&#23545;TCP&#26469;&#35828;&#65292;&#26159;inet_accept </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>    err <span style="color: #8b6508;">=</span> sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> newsock<span style="color: #8b6508;">,</span> sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">f_flags</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">11:  </span>    <span style="color: #8b6508;">....</span>    
<span class="linenr">12:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>upeer_sockaddr<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35843;&#29992;&#32773;&#38656;&#35201;&#33719;&#21462;&#23545;&#26041;&#22871;&#25509;&#21475;&#22320;&#22336;&#21644;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr">13:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35843;&#29992;&#20256;&#36755;&#23618;&#22238;&#35843;&#33719;&#24471;&#23545;&#26041;&#30340;&#22320;&#22336;&#21644;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr">14:  </span>        <span style="color: #a020f0;">if</span><span style="color: #cd2626;">(</span>newsock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">getname</span><span style="color: #cd2626;">(</span>newsock<span style="color: #8b6508;">,</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>address<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>len<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">2</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&lt;</span><span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">15:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">16:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#22797;&#21046;&#21040;&#29992;&#25143;&#24577; </span><span style="color: #b22222;">*/</span>
<span class="linenr">17:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">move_addr_to_user</span><span style="color: #cd2626;">(</span>address<span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span> upeer_sockaddr<span style="color: #8b6508;">,</span> upeer_addrlen<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">19:  </span>    <span style="color: #8b6508;">.....</span>     
<span class="linenr">20:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_map_fd</span><span style="color: #cd2626;">(</span>newsock<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">&lt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20026;&#26032;&#36830;&#25509;&#20998;&#37197;&#25991;&#20214;&#25551;&#36848;&#31526; </span><span style="color: #b22222;">*/</span>
<span class="linenr">21:  </span>
<span class="linenr">22:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p>  <br/>
</p>
</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> tcp_accept()</h3>
<div class="outline-text-3" id="text-3-1">

<p>  <b>[注]</b>: 在内核2.6.32以后对应函数为inet_csk_accept().<br/>
</p><ul>
<li>描述: 通过在规定时间内，判断tcp_sock-&gt;accept_queue队列非空，代表有新的连接进入．<br/>
</li>
<li>返回值: (struct sock *)newsk;<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #0000ff; font-size: 120%;">tcp_accept</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flags</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">err</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #8b6508;">....</span>
<span class="linenr"> 4:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Find already established connection </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">accept&#38431;&#21015;&#20026;&#31354;&#65292;&#35828;&#26126;&#36824;&#27809;&#26377;&#25910;&#21040;&#26032;&#36830;&#25509; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>        <span style="color: #228b22;">long</span> <span style="color: #a0522d;">timeo</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_rcvtimeo</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flags <span style="color: #8b6508;">&amp;</span> O_NONBLOCK<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22871;&#21475;&#26159;&#38750;&#38459;&#22622;&#30340;&#65292;&#25110;&#32773;&#22312;&#19968;&#23450;&#26102;&#38388;&#20869;&#27809;&#26377;&#26032;&#36830;&#25509;&#65292;&#21017;&#36820;&#22238; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!timeo<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36229;&#26102;&#26102;&#38388;&#21040;&#65292;&#27809;&#26377;&#26032;&#36830;&#25509;&#65292;&#36864;&#20986; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>
<span class="linenr">11:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36816;&#34892;&#21040;&#36825;&#37324;&#65292;&#35828;&#26126;&#26377;&#26032;&#36830;&#25509;&#21040;&#26469;&#65292;&#21017;&#31561;&#24453;&#26032;&#30340;&#20256;&#36755;&#25511;&#21046;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr">12:  </span>        error <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">wait_for_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> timeo<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>error<span style="color: #cd2626;">)</span>
<span class="linenr">14:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">16:  </span>
<span class="linenr">17:  </span>    req <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue</span> <span style="color: #8b6508;">=</span> req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">dl_next</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">)</span>
<span class="linenr">19:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue_tail</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>
<span class="linenr">21:  </span>    newsk <span style="color: #8b6508;">=</span> req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">;</span>
<span class="linenr">22:  </span>    <span style="color: #008000; font-weight: bold;">sk_acceptq_removed</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>    <span style="color: #008000; font-weight: bold;">tcp_openreq_fastfree</span><span style="color: #cd2626;">(</span>req<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">24:  </span>    <span style="color: #8b6508;">....</span>
<span class="linenr">25:  </span>
<span class="linenr">26:  </span>    <span style="color: #a020f0;">return</span> newsk<span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 三次握手</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> 客户端发送SYN段</h3>
<div class="outline-text-3" id="text-4-1">

<ul>
<li>由tcp_v4_connect()-&gt;tcp_connect()-&gt;tcp_transmit_skb()发送，并置为TCP_SYN_SENT.<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26500;&#36896;&#24182;&#21457;&#36865;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 2:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_connect</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 3:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">buff</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span>    <span style="color: #008000; font-weight: bold;">tcp_connect_init</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#20256;&#36755;&#25511;&#21046;&#22359;&#20013;&#19982;&#36830;&#25509;&#30456;&#20851;&#30340;&#25104;&#21592; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 8:  </span>
<span class="linenr"> 9:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20026;SYN&#27573;&#20998;&#37197;&#25253;&#25991;&#24182;&#36827;&#34892;&#21021;&#22987;&#21270; </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>    buff <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">alloc_skb</span><span style="color: #cd2626;">(</span>MAX_TCP_HEADER <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">15</span><span style="color: #8b6508;">,</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_allocation</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">11:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">unlikely</span><span style="color: #cd2626;">(</span>buff <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">))</span>
<span class="linenr">12:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span>ENOBUFS<span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>
<span class="linenr">14:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Reserve space for headers. </span><span style="color: #b22222;">*/</span>
<span class="linenr">15:  </span>    <span style="color: #008000; font-weight: bold;">skb_reserve</span><span style="color: #cd2626;">(</span>buff<span style="color: #8b6508;">,</span> MAX_TCP_HEADER<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>
<span class="linenr">17:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span> <span style="color: #8b6508;">=</span> TCPCB_FLAG_SYN<span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>    <span style="color: #008000; font-weight: bold;">TCP_ECN_send_syn</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">19:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tso_segs</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>    <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tso_size</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">22:  </span>    buff<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">csum</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">++;</span>
<span class="linenr">24:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">25:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">26:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pushed_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>    <span style="color: #008000; font-weight: bold;">tcp_ca_init</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>
<span class="linenr">29:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Send it off. </span><span style="color: #b22222;">*/</span>
<span class="linenr">30:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">when</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_stamp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">when</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>
<span class="linenr">33:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23558;&#25253;&#25991;&#28155;&#21152;&#21040;&#21457;&#36865;&#38431;&#21015;&#19978; </span><span style="color: #b22222;">*/</span>
<span class="linenr">34:  </span>    <span style="color: #008000; font-weight: bold;">__skb_queue_tail</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_write_queue</span><span style="color: #8b6508;">,</span> buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">35:  </span>    <span style="color: #008000; font-weight: bold;">sk_charge_skb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">36:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span> <span style="color: #8b6508;">+=</span> <span style="color: #008000; font-weight: bold;">tcp_skb_pcount</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">37:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">38:  </span>    <span style="color: #008000; font-weight: bold;">tcp_transmit_skb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">skb_clone</span><span style="color: #cd2626;">(</span>buff<span style="color: #8b6508;">,</span> GFP_KERNEL<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">39:  </span>    <span style="color: #008000; font-weight: bold;">TCP_INC_STATS</span><span style="color: #cd2626;">(</span>TCP_MIB_ACTIVEOPENS<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">40:  </span>
<span class="linenr">41:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Timer for repeating the SYN until an answer. </span><span style="color: #b22222;">*/</span>
<span class="linenr">42:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21551;&#21160;&#37325;&#20256;&#23450;&#26102;&#22120; </span><span style="color: #b22222;">*/</span>
<span class="linenr">43:  </span>    <span style="color: #008000; font-weight: bold;">tcp_reset_xmit_timer</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_TIME_RETRANS<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rto</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">44:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">45:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">46:  </span>
</pre>

    </div>
</li>
</ul>


<p>     <br/>
</p></div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> 服务端接收到SYN段后，发送SYN/ACK处理</h3>
<div class="outline-text-3" id="text-4-2">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_state_process()-&gt;tcp_v4_conn_request()-&gt;tcp_v4_send_synack().<br/>
</li>
<li>tcp_v4_send_synack()<br/>
<ul>
<li>tcp_make_synack(sk, dst, req); <i>* 根据路由、传输控制块、连接请求块中的构建SYN+ACK段 *</i><br/>
</li>
<li>ip_build_and_send_pkt(); <i>* 生成IP数据报并发送出去 *</i><br/>

<p><br/>
</p>
<p><br/>
	</p>
<div class="figure">
<p><img src="tcp_synack.png"  alt="tcp_synack.png" /></p>
<p>图: 服务端接收到SYN段后，发送SYN/ACK处理流程。</p>
</div>
<p><br/>
</p>
<p><br/>
</p></li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21521;&#23458;&#25143;&#31471;&#21457;&#36865;SYN+ACK&#25253;&#25991; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 2:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_v4_send_synack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">open_request</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">req</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 3:  </span>                  <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">dst_entry</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">dst</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span> <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span> <span style="color: #a0522d;">skb</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">First, grab a route. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26597;&#25214;&#21040;&#23458;&#25143;&#31471;&#30340;&#36335;&#30001; </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!dst <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #cd2626;">(</span>dst <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_v4_route_req</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> req<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">)</span>
<span class="linenr">11:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>
<span class="linenr">13:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#36335;&#30001;&#12289;&#20256;&#36755;&#25511;&#21046;&#22359;&#12289;&#36830;&#25509;&#35831;&#27714;&#22359;&#20013;&#30340;&#26500;&#24314;SYN+ACK&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">14:  </span>    skb <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_make_synack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> dst<span style="color: #8b6508;">,</span> req<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>
<span class="linenr">16:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29983;&#25104;SYN+ACK&#27573;&#25104;&#21151; </span><span style="color: #b22222;">*/</span>
<span class="linenr">17:  </span>        <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">th</span> <span style="color: #8b6508;">=</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">h</span><span style="color: #8b6508;">.</span><span style="color: #008000;">th</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>
<span class="linenr">19:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29983;&#25104;&#26657;&#39564;&#30721; </span><span style="color: #b22222;">*/</span>
<span class="linenr">20:  </span>        th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">check</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_v4_check</span><span style="color: #cd2626;">(</span>th<span style="color: #8b6508;">,</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #8b6508;">,</span>
<span class="linenr">21:  </span>                     req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">loc_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">22:  </span>                     req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rmt_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">23:  </span>                     <span style="color: #008000; font-weight: bold;">csum_partial</span><span style="color: #cd2626;">((</span><span style="color: #228b22;">char</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>th<span style="color: #8b6508;">,</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #8b6508;">,</span>
<span class="linenr">24:  </span>                              skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">csum</span><span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">25:  </span>
<span class="linenr">26:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29983;&#25104;IP&#25968;&#25454;&#25253;&#24182;&#21457;&#36865;&#20986;&#21435; </span><span style="color: #b22222;">*/</span>
<span class="linenr">27:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ip_build_and_send_pkt</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> sk<span style="color: #8b6508;">,</span> req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">loc_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">28:  </span>                        req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rmt_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">29:  </span>                        req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">opt</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">30:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err <span style="color: #8b6508;">==</span> NET_XMIT_CN<span style="color: #cd2626;">)</span>
<span class="linenr">31:  </span>            err <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">33:  </span>
<span class="linenr">34:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">35:  </span>    <span style="color: #008000; font-weight: bold;">dst_release</span><span style="color: #cd2626;">(</span>dst<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">36:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">37:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">38:  </span>
</pre>

    </div>
</li>
</ul>


<p>       <br/>
</p></div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> 客户端回复确认ACK段</h3>
<div class="outline-text-3" id="text-4-3">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_state_process().当前客户端处于TCP_SYN_SENT状态。<br/>
</li>
<li>tcp_rcv_synsent_state_process(); <i>* tcp_rcv_synsent_state_process处理SYN_SENT状态下接收到的TCP段 *</i><br/>
<ul>
<li>tcp_ack(); <i>* 处理接收到的ack报文 *</i><br/>
</li>
<li>tcp_send_ack(); <i>* 在主动连接时，向服务器端发送ACK完成连接，并更新窗口 *</i><br/>
<ul>
<li>alloc_skb(); <i>* 构造ack段 *</i><br/>
</li>
<li>tcp_transmit_skb(); <i>* 将ack段发出 *</i><br/>
</li>
</ul>

</li>
<li>tcp_urg(sk, skb, th); <i>* 处理完第二次握手后，还需要处理带外数据 *</i><br/>
</li>
<li>tcp_data_snd_check(sk); <i>* 检测是否有数据需要发送 *</i><br/>
<ul>
<li>检查sk-&gt;sk_send_head队列上是否有待发送的数据。<br/>
</li>
<li>tcp_write_xmit(); <i>* 将TCP发送队列上的段发送出去 *</i><br/>
</li>
</ul>

</li>
</ul>

</li>
<li>代码关键路径:<br/>
</li>
</ul>


</div>

<div id="outline-container-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> tcp_rcv_synsent_state_process()</h4>
<div class="outline-text-4" id="text-4-3-1">


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;SYN_SENT&#29366;&#24577;&#19979;&#22788;&#29702;&#25509;&#25910;&#21040;&#30340;&#27573;&#65292;&#20294;&#26159;&#19981;&#22788;&#29702;&#24102;&#22806;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">  2:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_rcv_synsent_state_process</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>                   <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">th</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">unsigned</span> <span style="color: #a0522d;">len</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>  <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">  6:  </span>  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">saved_clamp</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span><span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>
<span class="linenr">  8:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35299;&#26512;TCP&#36873;&#39033;&#24182;&#20445;&#23384;&#21040;&#20256;&#36755;&#25511;&#21046;&#22359;&#20013; </span><span style="color: #b22222;">*/</span>
<span class="linenr">  9:  </span>  <span style="color: #008000; font-weight: bold;">tcp_parse_options</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 10:  </span>
<span class="linenr"> 11:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;ACK&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 12:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr"> 13:  </span><span style="color: #b22222;">       * "If the state is SYN-SENT then</span>
<span class="linenr"> 14:  </span><span style="color: #b22222;">       *    first check the ACK bit</span>
<span class="linenr"> 15:  </span><span style="color: #b22222;">       *      If the ACK bit is set</span>
<span class="linenr"> 16:  </span><span style="color: #b22222;">       *    If SEG.ACK =&lt; ISS, or SEG.ACK &gt; SND.NXT, send</span>
<span class="linenr"> 17:  </span><span style="color: #b22222;">       *        a reset (unless the RST bit is set, if so drop</span>
<span class="linenr"> 18:  </span><span style="color: #b22222;">       *        the segment and return)"</span>
<span class="linenr"> 19:  </span><span style="color: #b22222;">       *</span>
<span class="linenr"> 20:  </span><span style="color: #b22222;">       *  We do not send data with SYN, so that RFC-correct</span>
<span class="linenr"> 21:  </span><span style="color: #b22222;">       *  test reduces to:</span>
<span class="linenr"> 22:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 23:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span> <span style="color: #8b6508;">!=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 24:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">reset_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 25:  </span>
<span class="linenr"> 26:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_tsecr</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 27:  </span>          !<span style="color: #008000; font-weight: bold;">between</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_tsecr</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_stamp</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 28:  </span>               tcp_time_stamp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 29:  </span>          <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span>LINUX_MIB_PAWSACTIVEREJECTED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 30:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">reset_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 31:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 32:  </span>
<span class="linenr"> 33:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Now ACK is acceptable.</span>
<span class="linenr"> 34:  </span><span style="color: #b22222;">       *</span>
<span class="linenr"> 35:  </span><span style="color: #b22222;">       * "If the RST bit is set</span>
<span class="linenr"> 36:  </span><span style="color: #b22222;">       *    If the ACK was acceptable then signal the user "error:</span>
<span class="linenr"> 37:  </span><span style="color: #b22222;">       *    connection reset", drop the segment, enter CLOSED state,</span>
<span class="linenr"> 38:  </span><span style="color: #b22222;">       *    delete TCB, and return."</span>
<span class="linenr"> 39:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 40:  </span>
<span class="linenr"> 41:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25910;&#21040;ACK+RST&#27573;&#65292;&#38656;&#35201;tcp_reset&#35774;&#32622;&#38169;&#35823;&#30721;&#65292;&#24182;&#20851;&#38381;&#22871;&#25509;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 42:  </span>          <span style="color: #008000; font-weight: bold;">tcp_reset</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 43:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 44:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 45:  </span>
<span class="linenr"> 46:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr"> 47:  </span><span style="color: #b22222;">       *   "fifth, if neither of the SYN or RST bits is set then</span>
<span class="linenr"> 48:  </span><span style="color: #b22222;">       *    drop the segment and return."</span>
<span class="linenr"> 49:  </span><span style="color: #b22222;">       *</span>
<span class="linenr"> 50:  </span><span style="color: #b22222;">       *    See note below!</span>
<span class="linenr"> 51:  </span><span style="color: #b22222;">       *                                        --ANK(990513)</span>
<span class="linenr"> 52:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 53:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">syn</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;SYN_SENT&#29366;&#24577;&#19979;&#25509;&#25910;&#21040;&#30340;&#27573;&#24517;&#39035;&#23384;&#22312;SYN&#26631;&#24535;&#65292;&#21542;&#21017;&#35828;&#26126;&#25509;&#25910;&#21040;&#30340;&#27573;&#26080;&#25928;&#65292;&#20002;&#24323;&#35813;&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 54:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 55:  </span>
<span class="linenr"> 56:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr"> 57:  </span><span style="color: #b22222;">       *   "If the SYN bit is on ...</span>
<span class="linenr"> 58:  </span><span style="color: #b22222;">       *    are acceptable then ...</span>
<span class="linenr"> 59:  </span><span style="color: #b22222;">       *    (our SYN has been ACKed), change the connection</span>
<span class="linenr"> 60:  </span><span style="color: #b22222;">       *    state to ESTABLISHED..."</span>
<span class="linenr"> 61:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 62:  </span>
<span class="linenr"> 63:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#39318;&#37096;&#26631;&#24535;&#20013;&#33719;&#21462;&#26174;&#31034;&#25317;&#22622;&#36890;&#30693;&#30340;&#29305;&#24615; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 64:  </span>      <span style="color: #008000; font-weight: bold;">TCP_ECN_rcv_synack</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> th<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 65:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ecn_flags</span><span style="color: #8b6508;">&amp;</span>TCP_ECN_OK<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#25903;&#25345;ECN&#65292;&#21017;&#35774;&#32622;&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 66:  </span>          sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_no_largesend</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 67:  </span>
<span class="linenr"> 68:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#19982;&#31383;&#21475;&#30456;&#20851;&#30340;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 69:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wl1</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 70:  </span>      <span style="color: #008000; font-weight: bold;">tcp_ack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> FLAG_SLOWPATH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 71:  </span>
<span class="linenr"> 72:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Ok.. it's good. Set up sequence numbers and</span>
<span class="linenr"> 73:  </span><span style="color: #b22222;">       * move to established.</span>
<span class="linenr"> 74:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 75:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 76:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_wup</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 77:  </span>
<span class="linenr"> 78:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">RFC1323: The window in SYN &amp; SYN/ACK segments is</span>
<span class="linenr"> 79:  </span><span style="color: #b22222;">       * never scaled.</span>
<span class="linenr"> 80:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 81:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ntohs</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 82:  </span>      <span style="color: #008000; font-weight: bold;">tcp_init_wl</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span><span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 83:  </span>
<span class="linenr"> 84:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">wscale_ok</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 85:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">snd_wscale</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_wscale</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 86:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window_clamp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">min</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window_clamp</span><span style="color: #8b6508;">,</span> 65535U<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 87:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 88:  </span>
<span class="linenr"> 89:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#26159;&#21542;&#25903;&#25345;&#26102;&#38388;&#25139;&#36873;&#39033;&#26469;&#35774;&#32622;&#20256;&#36755;&#25511;&#21046;&#22359;&#30340;&#30456;&#20851;&#23383;&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 90:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">tstamp_ok</span>       <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 91:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span>
<span class="linenr"> 92:  </span>              <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr"> 93:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">advmss</span>      <span style="color: #8b6508;">-=</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr"> 94:  </span>          <span style="color: #008000; font-weight: bold;">tcp_store_ts_recent</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 95:  </span>      <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 96:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 97:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 98:  </span>
<span class="linenr"> 99:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;PMTU&#12289;MSS&#31561;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr">100:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">sack_ok</span> <span style="color: #8b6508;">&amp;&amp;</span> sysctl_tcp_fack<span style="color: #cd2626;">)</span>
<span class="linenr">101:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">sack_ok</span> <span style="color: #8b6508;">|=</span> <span style="color: #ff0000;">2</span><span style="color: #8b6508;">;</span>
<span class="linenr">102:  </span>
<span class="linenr">103:  </span>      <span style="color: #008000; font-weight: bold;">tcp_sync_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pmtu_cookie</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">104:  </span>      <span style="color: #008000; font-weight: bold;">tcp_initialize_rcv_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">105:  </span>
<span class="linenr">106:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Remember, tcp_poll() does not lock socket!</span>
<span class="linenr">107:  </span><span style="color: #b22222;">       * Change state from SYN-SENT only after copied_seq</span>
<span class="linenr">108:  </span><span style="color: #b22222;">       * is initialized. </span><span style="color: #b22222;">*/</span>
<span class="linenr">109:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">copied_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span><span style="color: #8b6508;">;</span>
<span class="linenr">110:  </span>      <span style="color: #008000; font-weight: bold;">mb</span><span style="color: #cd2626;">()</span><span style="color: #8b6508;">;</span>
<span class="linenr">111:  </span>      <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_ESTABLISHED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">112:  </span>
<span class="linenr">113:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Make sure socket is routed, for correct metrics.  </span><span style="color: #b22222;">*/</span>
<span class="linenr">114:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af_specific</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rebuild_header</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">115:  </span>
<span class="linenr">116:  </span>      <span style="color: #008000; font-weight: bold;">tcp_init_metrics</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">117:  </span>
<span class="linenr">118:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Prevent spurious tcp_cwnd_restart() on first data</span>
<span class="linenr">119:  </span><span style="color: #b22222;">       * packet.</span>
<span class="linenr">120:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">121:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lsndtime</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">122:  </span>
<span class="linenr">123:  </span>      <span style="color: #008000; font-weight: bold;">tcp_init_buffer_space</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">124:  </span>
<span class="linenr">125:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#21551;&#29992;&#20102;&#36830;&#25509;&#20445;&#27963;&#65292;&#21017;&#21551;&#29992;&#36830;&#25509;&#20445;&#27963;&#23450;&#26102;&#22120; </span><span style="color: #b22222;">*/</span>
<span class="linenr">126:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_flag</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> SOCK_KEEPOPEN<span style="color: #cd2626;">))</span>
<span class="linenr">127:  </span>          <span style="color: #008000; font-weight: bold;">tcp_reset_keepalive_timer</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">keepalive_time_when</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">128:  </span>
<span class="linenr">129:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">snd_wscale</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#39318;&#37096;&#39044;&#27979; </span><span style="color: #b22222;">*/</span>
<span class="linenr">130:  </span>          <span style="color: #008000; font-weight: bold;">__tcp_fast_path_on</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">131:  </span>      <span style="color: #a020f0;">else</span>
<span class="linenr">132:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pred_flags</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">133:  </span>
<span class="linenr">134:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">sock_flag</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> SOCK_DEAD<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22871;&#21475;&#19981;&#22788;&#20110;SOCK_DEAD&#29366;&#24577;&#65292;&#21017;&#21796;&#37266;&#31561;&#24453;&#35813;&#22871;&#25509;&#21475;&#30340;&#36827;&#31243; </span><span style="color: #b22222;">*/</span>
<span class="linenr">135:  </span>          sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state_change</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">136:  </span>          <span style="color: #008000; font-weight: bold;">sk_wake_async</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">,</span> POLL_OUT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">137:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr">138:  </span>
<span class="linenr">139:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36830;&#25509;&#24314;&#31435;&#23436;&#25104;&#65292;&#26681;&#25454;&#24773;&#20917;&#36827;&#20837;&#24310;&#26102;&#30830;&#35748;&#27169;&#24335; </span><span style="color: #b22222;">*/</span>
<span class="linenr">140:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_write_pending</span> <span style="color: #8b6508;">||</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">defer_accept</span> <span style="color: #8b6508;">||</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">pingpong</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">141:  </span>          <span style="color: #b22222;">/* </span><span style="color: #b22222;">Save one ACK. Data will be ready after</span>
<span class="linenr">142:  </span><span style="color: #b22222;">           * several ticks, if write_pending is set.</span>
<span class="linenr">143:  </span><span style="color: #b22222;">           *</span>
<span class="linenr">144:  </span><span style="color: #b22222;">           * It may be deleted, but with this feature tcpdumps</span>
<span class="linenr">145:  </span><span style="color: #b22222;">           * look so _wonderfully_ clever, that I was not able</span>
<span class="linenr">146:  </span><span style="color: #b22222;">           * to stand against the temptation 8)     --ANK</span>
<span class="linenr">147:  </span><span style="color: #b22222;">           </span><span style="color: #b22222;">*/</span>
<span class="linenr">148:  </span>          <span style="color: #008000; font-weight: bold;">tcp_schedule_ack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">149:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">lrcvtime</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">150:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">ato</span>  <span style="color: #8b6508;">=</span> TCP_ATO_MIN<span style="color: #8b6508;">;</span>
<span class="linenr">151:  </span>          <span style="color: #008000; font-weight: bold;">tcp_incr_quickack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">152:  </span>          <span style="color: #008000; font-weight: bold;">tcp_enter_quickack_mode</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">153:  </span>          <span style="color: #008000; font-weight: bold;">tcp_reset_xmit_timer</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_TIME_DACK<span style="color: #8b6508;">,</span> TCP_DELACK_MAX<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">154:  </span>
<span class="linenr">155:  </span><span style="color: #008b8b;">discard</span><span style="color: #8b6508;">:</span>
<span class="linenr">156:  </span>          <span style="color: #008000; font-weight: bold;">__kfree_skb</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">157:  </span>          <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">158:  </span>      <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#19981;&#38656;&#35201;&#24310;&#26102;&#30830;&#35748;&#65292;&#31435;&#21363;&#21457;&#36865;ACK&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">159:  </span>          <span style="color: #008000; font-weight: bold;">tcp_send_ack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">160:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr">161:  </span>      <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">162:  </span>  <span style="color: #cd2626;">}</span>
<span class="linenr">163:  </span>
<span class="linenr">164:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">No ACK in the segment </span><span style="color: #b22222;">*/</span>
<span class="linenr">165:  </span>
<span class="linenr">166:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25910;&#21040;RST&#27573;&#65292;&#21017;&#20002;&#24323;&#20256;&#36755;&#25511;&#21046;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr">167:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr">168:  </span><span style="color: #b22222;">       * "If the RST bit is set</span>
<span class="linenr">169:  </span><span style="color: #b22222;">       *</span>
<span class="linenr">170:  </span><span style="color: #b22222;">       *      Otherwise (no ACK) drop the segment and return."</span>
<span class="linenr">171:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">172:  </span>
<span class="linenr">173:  </span>      <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr">174:  </span>  <span style="color: #cd2626;">}</span>
<span class="linenr">175:  </span>
<span class="linenr">176:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">PAWS check. </span><span style="color: #b22222;">*/</span>
<span class="linenr">177:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">PAWS&#26816;&#27979;&#22833;&#25928;&#65292;&#20063;&#20002;&#24323;&#20256;&#36755;&#25511;&#21046;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr">178:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">ts_recent_stamp</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">tcp_paws_check</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">))</span>
<span class="linenr">179:  </span>      <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr">180:  </span>
<span class="linenr">181:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;SYN_SENT&#29366;&#24577;&#19979;&#25910;&#21040;&#20102;SYN&#27573;&#24182;&#19988;&#27809;&#26377;ACK&#65292;&#35828;&#26126;&#26159;&#20004;&#31471;&#21516;&#26102;&#25171;&#24320; </span><span style="color: #b22222;">*/</span>
<span class="linenr">182:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">syn</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">183:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">We see SYN without ACK. It is attempt of</span>
<span class="linenr">184:  </span><span style="color: #b22222;">       * simultaneous connect with crossed SYNs.</span>
<span class="linenr">185:  </span><span style="color: #b22222;">       * Particularly, it can be connect to self.</span>
<span class="linenr">186:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">187:  </span>      <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_SYN_RECV<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#29366;&#24577;&#20026;TCP_SYN_RECV </span><span style="color: #b22222;">*/</span>
<span class="linenr">188:  </span>
<span class="linenr">189:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#26102;&#38388;&#25139;&#30456;&#20851;&#30340;&#23383;&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">190:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">tstamp_ok</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">191:  </span>          <span style="color: #008000; font-weight: bold;">tcp_store_ts_recent</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">192:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span>
<span class="linenr">193:  </span>              <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr">194:  </span>      <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">195:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">196:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr">197:  </span>
<span class="linenr">198:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#31383;&#21475;&#30456;&#20851;&#30340;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr">199:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">200:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_wup</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">201:  </span>
<span class="linenr">202:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">RFC1323: The window in SYN &amp; SYN/ACK segments is</span>
<span class="linenr">203:  </span><span style="color: #b22222;">       * never scaled.</span>
<span class="linenr">204:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">205:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span>    <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ntohs</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">206:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wl1</span>    <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">207:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">max_window</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span><span style="color: #8b6508;">;</span>
<span class="linenr">208:  </span>
<span class="linenr">209:  </span>      <span style="color: #008000; font-weight: bold;">TCP_ECN_rcv_syn</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> th<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#39318;&#37096;&#26631;&#24535;&#20013;&#33719;&#21462;&#26174;&#24335;&#25317;&#22622;&#36890;&#30693;&#30340;&#29305;&#24615;&#12290; </span><span style="color: #b22222;">*/</span>
<span class="linenr">210:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ecn_flags</span><span style="color: #8b6508;">&amp;</span>TCP_ECN_OK<span style="color: #cd2626;">)</span>
<span class="linenr">211:  </span>          sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_no_largesend</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">212:  </span>
<span class="linenr">213:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;MSS&#30456;&#20851;&#30340;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr">214:  </span>      <span style="color: #008000; font-weight: bold;">tcp_sync_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pmtu_cookie</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">215:  </span>      <span style="color: #008000; font-weight: bold;">tcp_initialize_rcv_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">216:  </span>
<span class="linenr">217:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21521;&#23545;&#31471;&#21457;&#36865;SYN+ACK&#27573;&#65292;&#24182;&#20002;&#24323;&#25509;&#25910;&#21040;&#30340;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">218:  </span>      <span style="color: #008000; font-weight: bold;">tcp_send_synack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">219:  </span><span style="color: #483d8b;">#if</span> <span style="color: #ff0000;">0</span>
<span class="linenr">220:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Note, we could accept data and URG from this segment.</span>
<span class="linenr">221:  </span><span style="color: #b22222;">       * There are no obstacles to make this.</span>
<span class="linenr">222:  </span><span style="color: #b22222;">       *</span>
<span class="linenr">223:  </span><span style="color: #b22222;">       * However, if we ignore data in ACKless segments sometimes,</span>
<span class="linenr">224:  </span><span style="color: #b22222;">       * we have no reasons to accept it sometimes.</span>
<span class="linenr">225:  </span><span style="color: #b22222;">       * Also, seems the code doing it in step6 of tcp_rcv_state_process</span>
<span class="linenr">226:  </span><span style="color: #b22222;">       * is not flawless. So, discard packet for sanity.</span>
<span class="linenr">227:  </span><span style="color: #b22222;">       * Uncomment this return to process the data.</span>
<span class="linenr">228:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">229:  </span>      <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">230:  </span><span style="color: #483d8b;">#else</span>
<span class="linenr">231:  </span>      <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr">232:  </span><span style="color: #483d8b;">#endif</span>
<span class="linenr">233:  </span>  <span style="color: #cd2626;">}</span>
<span class="linenr">234:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">"fifth, if neither of the SYN or RST bits is set then</span>
<span class="linenr">235:  </span><span style="color: #b22222;">   * drop the segment and return."</span>
<span class="linenr">236:  </span><span style="color: #b22222;">   </span><span style="color: #b22222;">*/</span>
<span class="linenr">237:  </span>
<span class="linenr">238:  </span><span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">:</span>
<span class="linenr">239:  </span>  <span style="color: #008000; font-weight: bold;">tcp_clear_options</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">240:  </span>  tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span> <span style="color: #8b6508;">=</span> saved_clamp<span style="color: #8b6508;">;</span>
<span class="linenr">241:  </span>  <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr">242:  </span>
<span class="linenr">243:  </span><span style="color: #008b8b;">reset_and_undo</span><span style="color: #8b6508;">:</span>
<span class="linenr">244:  </span>  <span style="color: #008000; font-weight: bold;">tcp_clear_options</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">245:  </span>  tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span> <span style="color: #8b6508;">=</span> saved_clamp<span style="color: #8b6508;">;</span>
<span class="linenr">246:  </span>  <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">247:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">248:  </span>
</pre>

    </div>

<p>         <br/>
</p></div>
</div>

</div>

<div id="outline-container-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> 服务端收到ACK段</h3>
<div class="outline-text-3" id="text-4-4">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_state_process().当前服务端处于TCP_SYN_RECV状态变为TCP_ESTABLISHED状态。<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38500;&#20102;ESTABLISHED&#21644;TIME_WAIT&#29366;&#24577;&#22806;&#65292;&#20854;&#20182;&#29366;&#24577;&#19979;&#30340;TCP&#27573;&#22788;&#29702;&#37117;&#30001;&#26412;&#20989;&#25968;&#23454;&#29616; </span><span style="color: #b22222;">*/</span> 
<span class="linenr">  2:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_rcv_state_process</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>              <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">th</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">unsigned</span> <span style="color: #a0522d;">len</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">  6:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">queued</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>
<span class="linenr">  8:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">  9:  </span>
<span class="linenr"> 10:  </span>    <span style="color: #a020f0;">switch</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 11:  </span>    <span style="color: #8b6508;">.....</span>
<span class="linenr"> 12:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">SYN_RECV&#29366;&#24577;&#30340;&#22788;&#29702; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 13:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_fast_parse_options</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> th<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35299;&#26512;TCP&#36873;&#39033;&#65292;&#22914;&#26524;&#39318;&#37096;&#20013;&#23384;&#22312;&#26102;&#38388;&#25139;&#36873;&#39033; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 14:  </span>        <span style="color: #008000; font-weight: bold;">tcp_paws_discard</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">PAWS&#26816;&#27979;&#22833;&#36133;&#65292;&#21017;&#20002;&#24323;&#25253;&#25991; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 15:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#26159;RST&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 16:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;DACK&#32473;&#23545;&#31471;&#65292;&#35828;&#26126;&#25509;&#25910;&#21040;&#30340;TCP&#27573;&#24050;&#32463;&#22788;&#29702;&#36807; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 17:  </span>            <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span>LINUX_MIB_PAWSESTABREJECTED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 18:  </span>            <span style="color: #008000; font-weight: bold;">tcp_send_dupack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 19:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 20:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr"> 21:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">Reset is accepted even if it did not pass PAWS. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 22:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 23:  </span>
<span class="linenr"> 24:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 1: check sequence number </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 25:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">tcp_sequence</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">TCP&#27573;&#24207;&#21495;&#26080;&#25928; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 26:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;TCP&#27573;&#26080;RST&#26631;&#24535;&#65292;&#21017;&#21457;&#36865;DACK&#32473;&#23545;&#26041; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 27:  </span>            <span style="color: #008000; font-weight: bold;">tcp_send_dupack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 28:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 29:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 30:  </span>
<span class="linenr"> 31:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 2: check RST bit </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 32:  </span>    <span style="color: #a020f0;">if</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;RST&#26631;&#24535;&#65292;&#21017;&#37325;&#32622;&#36830;&#25509; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 33:  </span>        <span style="color: #008000; font-weight: bold;">tcp_reset</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 34:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 35:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 36:  </span>
<span class="linenr"> 37:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;&#24517;&#35201;&#65292;&#21017;&#26356;&#26032;&#26102;&#38388;&#25139; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 38:  </span>    <span style="color: #008000; font-weight: bold;">tcp_replace_ts_recent</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 39:  </span>
<span class="linenr"> 40:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 3: check security and precedence [ignored] </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 41:  </span>
<span class="linenr"> 42:  </span>    <span style="color: #b22222;">/*  </span><span style="color: #b22222;">step 4:</span>
<span class="linenr"> 43:  </span><span style="color: #b22222;">     *</span>
<span class="linenr"> 44:  </span><span style="color: #b22222;">     *  Check for a SYN in window.</span>
<span class="linenr"> 45:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 46:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">syn</span> <span style="color: #8b6508;">&amp;&amp;</span> !<span style="color: #008000; font-weight: bold;">before</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;SYN&#26631;&#24535;&#24182;&#19988;&#24207;&#21495;&#22312;&#25509;&#25910;&#31383;&#21475;&#20869; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 47:  </span>        <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span>LINUX_MIB_TCPABORTONSYN<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 48:  </span>        <span style="color: #008000; font-weight: bold;">tcp_reset</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22797;&#20301;&#36830;&#25509; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 49:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 50:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 51:  </span>
<span class="linenr"> 52:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 5: check the ACK field </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 53:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;ACK&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 54:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26816;&#26597;ACK&#26159;&#21542;&#20026;&#27491;&#24120;&#30340;&#31532;&#19977;&#27425;&#25569;&#25163; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 55:  </span>        <span style="color: #228b22;">int</span> <span style="color: #a0522d;">acceptable</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_ack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> FLAG_SLOWPATH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 56:  </span>
<span class="linenr"> 57:  </span>        <span style="color: #a020f0;">switch</span><span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 58:  </span>        <span style="color: #a020f0;">case</span> TCP_SYN_RECV<span style="color: #8b6508;">:</span>
<span class="linenr"> 59:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>acceptable<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 60:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">copied_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 61:  </span>                <span style="color: #008000; font-weight: bold;">mb</span><span style="color: #cd2626;">()</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 62:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#27491;&#24120;&#30340;&#31532;&#19977;&#27425;&#25569;&#25163;&#65292;&#35774;&#32622;&#36830;&#25509;&#29366;&#24577;&#20026;TCP_ESTABLISHED </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 63:  </span>                <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_ESTABLISHED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 64:  </span>                sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state_change</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 65:  </span>
<span class="linenr"> 66:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Note, that this wakeup is only for marginal</span>
<span class="linenr"> 67:  </span><span style="color: #b22222;">                 * crossed SYN case. Passively open sockets</span>
<span class="linenr"> 68:  </span><span style="color: #b22222;">                 * are not waked up, because sk-&gt;sk_sleep ==</span>
<span class="linenr"> 69:  </span><span style="color: #b22222;">                 * NULL and sk-&gt;sk_socket == NULL.</span>
<span class="linenr"> 70:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 71:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_socket</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29366;&#24577;&#24050;&#32463;&#27491;&#24120;&#65292;&#21796;&#37266;&#37027;&#20123;&#31561;&#24453;&#30340;&#32447;&#31243; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 72:  </span>                    <span style="color: #008000; font-weight: bold;">sk_wake_async</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span><span style="color: #ff0000;">0</span><span style="color: #8b6508;">,</span>POLL_OUT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 73:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr"> 74:  </span>
<span class="linenr"> 75:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#20256;&#36755;&#25511;&#21046;&#22359;&#65292;&#22914;&#26524;&#23384;&#22312;&#26102;&#38388;&#25139;&#36873;&#39033;&#65292;&#21516;&#26102;&#24179;&#28369;RTT&#20026;0&#65292;&#21017;&#38656;&#35745;&#31639;&#37325;&#20256;&#36229;&#26102;&#26102;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 76:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 77:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ntohs</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&lt;&lt;</span>
<span class="linenr"> 78:  </span>                          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">snd_wscale</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 79:  </span>                <span style="color: #008000; font-weight: bold;">tcp_init_wl</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 80:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 81:  </span>
<span class="linenr"> 82:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">tcp_ack considers this ACK as duplicate</span>
<span class="linenr"> 83:  </span><span style="color: #b22222;">                 * and does not calculate rtt.</span>
<span class="linenr"> 84:  </span><span style="color: #b22222;">                 * Fix it at least with timestamps.</span>
<span class="linenr"> 85:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 86:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_tsecr</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 87:  </span>                    !tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">srtt</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 88:  </span>                    <span style="color: #008000; font-weight: bold;">tcp_ack_saw_tstamp</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 89:  </span>
<span class="linenr"> 90:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">tstamp_ok</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 91:  </span>                    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">advmss</span> <span style="color: #8b6508;">-=</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr"> 92:  </span>
<span class="linenr"> 93:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Make sure socket is routed, for</span>
<span class="linenr"> 94:  </span><span style="color: #b22222;">                 * correct metrics.</span>
<span class="linenr"> 95:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 96:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24314;&#31435;&#36335;&#30001;&#65292;&#21021;&#22987;&#21270;&#25317;&#22622;&#25511;&#21046;&#27169;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 97:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af_specific</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rebuild_header</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 98:  </span>
<span class="linenr"> 99:  </span>                <span style="color: #008000; font-weight: bold;">tcp_init_metrics</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">100:  </span>
<span class="linenr">101:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Prevent spurious tcp_cwnd_restart() on</span>
<span class="linenr">102:  </span><span style="color: #b22222;">                 * first data packet.</span>
<span class="linenr">103:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr">104:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lsndtime</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#26368;&#36817;&#19968;&#27425;&#21457;&#36865;&#25968;&#25454;&#21253;&#30340;&#26102;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">105:  </span>
<span class="linenr">106:  </span>                <span style="color: #008000; font-weight: bold;">tcp_initialize_rcv_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">107:  </span>                <span style="color: #008000; font-weight: bold;">tcp_init_buffer_space</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">108:  </span>                <span style="color: #008000; font-weight: bold;">tcp_fast_path_on</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35745;&#31639;&#26377;&#20851;TCP&#39318;&#37096;&#39044;&#27979;&#30340;&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr">109:  </span>            <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">110:  </span>                <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">111:  </span>            <span style="color: #cd2626;">}</span>
<span class="linenr">112:  </span>            <span style="color: #a020f0;">break</span><span style="color: #8b6508;">;</span>
<span class="linenr">113:  </span>        <span style="color: #8b6508;">.....</span>
<span class="linenr">114:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">115:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span>
<span class="linenr">116:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr">117:  </span>    <span style="color: #8b6508;">.....</span>
<span class="linenr">118:  </span>
<span class="linenr">119:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 6: check the URG bit </span><span style="color: #b22222;">*/</span>
<span class="linenr">120:  </span>    <span style="color: #008000; font-weight: bold;">tcp_urg</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> th<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26816;&#27979;&#24102;&#22806;&#25968;&#25454;&#20301; </span><span style="color: #b22222;">*/</span>
<span class="linenr">121:  </span>
<span class="linenr">122:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">tcp_data could move socket to TIME-WAIT </span><span style="color: #b22222;">*/</span>
<span class="linenr">123:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span> <span style="color: #8b6508;">!=</span> TCP_CLOSE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;tcp_data&#38656;&#35201;&#21457;&#36865;&#25968;&#25454;&#21644;ACK&#21017;&#22312;&#36825;&#37324;&#22788;&#29702; </span><span style="color: #b22222;">*/</span>
<span class="linenr">124:  </span>        <span style="color: #008000; font-weight: bold;">tcp_data_snd_check</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">125:  </span>        <span style="color: #008000; font-weight: bold;">tcp_ack_snd_check</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">126:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">127:  </span>
<span class="linenr">128:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!queued<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#27573;&#27809;&#26377;&#21152;&#20837;&#38431;&#21015;&#65292;&#25110;&#32773;&#21069;&#38754;&#30340;&#27969;&#31243;&#38656;&#35201;&#37322;&#25918;&#25253;&#25991;&#65292;&#21017;&#37322;&#25918;&#23427; </span><span style="color: #b22222;">*/</span>
<span class="linenr">129:  </span><span style="color: #008b8b;">discard</span><span style="color: #8b6508;">:</span>
<span class="linenr">130:  </span>        <span style="color: #008000; font-weight: bold;">__kfree_skb</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">131:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">132:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">133:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 数据传输</h2>
<div class="outline-text-2" id="text-5">


</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> 客户端请求数据</h3>
<div class="outline-text-3" id="text-5-1">

<ul>
<li>由send() -&gt; sendto() -&gt; tcp_sendmsg().当前服务端处于TCP_ESTABLISHED状态。<br/>
</li>
</ul>


</div>

<div id="outline-container-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"><span class="section-number-4">5.1.1</span> send()</h4>
<div class="outline-text-4" id="text-5-1-1">

<p>     send() 直接调用了sendto().<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #b22222;">/*</span>
<span class="linenr">2:  </span><span style="color: #b22222;"> *  Send a datagram down a socket.</span>
<span class="linenr">3:  </span><span style="color: #b22222;"> </span><span style="color: #b22222;">*/</span>
<span class="linenr">4:  </span>
<span class="linenr">5:  </span><span style="color: #0000ff; font-size: 120%;">SYSCALL_DEFINE4</span><span style="color: #cd2626;">(</span>send<span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span><span style="color: #8b6508;">,</span> fd<span style="color: #8b6508;">,</span> <span style="color: #228b22;">void</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*,</span> buff<span style="color: #8b6508;">,</span> <span style="color: #228b22;">size_t</span><span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span>
<span class="linenr">6:  </span>        <span style="color: #228b22;">unsigned</span><span style="color: #8b6508;">,</span> flags<span style="color: #cd2626;">)</span>
<span class="linenr">7:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">8:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #008000; font-weight: bold;">sys_sendto</span><span style="color: #cd2626;">(</span>fd<span style="color: #8b6508;">,</span> buff<span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">9:  </span><span style="color: #cd2626;">}</span>
</pre>


</p>
<p>    <br/>
</p></div>

</div>

<div id="outline-container-5-1-2" class="outline-4">
<h4 id="sec-5-1-2"><span class="section-number-4">5.1.2</span> sendto()</h4>
<div class="outline-text-4" id="text-5-1-2">


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/*</span>
<span class="linenr"> 2:  </span><span style="color: #b22222;"> *  Send a datagram to a given address. We move the address into kernel</span>
<span class="linenr"> 3:  </span><span style="color: #b22222;"> *  space and check the user space data area is readable before invoking</span>
<span class="linenr"> 4:  </span><span style="color: #b22222;"> *  the protocol.</span>
<span class="linenr"> 5:  </span><span style="color: #b22222;"> </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span><span style="color: #0000ff; font-size: 120%;">SYSCALL_DEFINE6</span><span style="color: #cd2626;">(</span>sendto<span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span><span style="color: #8b6508;">,</span> fd<span style="color: #8b6508;">,</span> <span style="color: #228b22;">void</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*,</span> buff<span style="color: #8b6508;">,</span> <span style="color: #228b22;">size_t</span><span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span>
<span class="linenr"> 8:  </span>        <span style="color: #228b22;">unsigned</span><span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*,</span> addr<span style="color: #8b6508;">,</span>
<span class="linenr"> 9:  </span>        <span style="color: #228b22;">int</span><span style="color: #8b6508;">,</span> addr_len<span style="color: #cd2626;">)</span>
<span class="linenr">10:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">11:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">socket</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sock</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr_storage</span> <span style="color: #a0522d;">address</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span><span style="color: #8b6508;">;</span>
<span class="linenr">14:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #a0522d;">msg</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span> <span style="color: #a0522d;">iov</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">fput_needed</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>
<span class="linenr">18:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>len <span style="color: #8b6508;">&gt;</span> INT_MAX<span style="color: #cd2626;">)</span>
<span class="linenr">19:  </span>        len <span style="color: #8b6508;">=</span> INT_MAX<span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    sock <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sockfd_lookup_light</span><span style="color: #cd2626;">(</span>fd<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>err<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>fput_needed<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!sock<span style="color: #cd2626;">)</span>
<span class="linenr">22:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>
<span class="linenr">24:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#20986;&#29992;&#25143;&#31354;&#38388;&#30340;buff&#30452;&#25509;&#36171;&#32473;&#20102;iov.iov_base, iov.iov_len = len </span><span style="color: #b22222;">*/</span>     
<span class="linenr">25:  </span>    iov<span style="color: #8b6508;">.</span><span style="color: #008000;">iov_base</span> <span style="color: #8b6508;">=</span> buff<span style="color: #8b6508;">;</span>
<span class="linenr">26:  </span>    iov<span style="color: #8b6508;">.</span><span style="color: #008000;">iov_len</span> <span style="color: #8b6508;">=</span> len<span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_name</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_iov</span> <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">&amp;</span>iov<span style="color: #8b6508;">;</span>
<span class="linenr">29:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">30:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_control</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_controllen</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_namelen</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">33:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>addr<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">34:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">move_addr_to_kernel</span><span style="color: #cd2626;">(</span>addr<span style="color: #8b6508;">,</span> addr_len<span style="color: #8b6508;">,</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">35:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err <span style="color: #8b6508;">&lt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr">36:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_put</span><span style="color: #8b6508;">;</span>
<span class="linenr">37:  </span>        msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_name</span> <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #8b6508;">;</span>
<span class="linenr">38:  </span>        msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_namelen</span> <span style="color: #8b6508;">=</span> addr_len<span style="color: #8b6508;">;</span>
<span class="linenr">39:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">40:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">f_flags</span> <span style="color: #8b6508;">&amp;</span> O_NONBLOCK<span style="color: #cd2626;">)</span>
<span class="linenr">41:  </span>        flags <span style="color: #8b6508;">|=</span> MSG_DONTWAIT<span style="color: #8b6508;">;</span>
<span class="linenr">42:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_flags</span> <span style="color: #8b6508;">=</span> flags<span style="color: #8b6508;">;</span>
<span class="linenr">43:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sendmsg</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>msg<span style="color: #8b6508;">,</span> len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">44:  </span>
<span class="linenr">45:  </span><span style="color: #008b8b;">out_put</span><span style="color: #8b6508;">:</span>
<span class="linenr">46:  </span>    <span style="color: #008000; font-weight: bold;">fput_light</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #8b6508;">,</span> fput_needed<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">47:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">48:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">49:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>

</div>

</div>

<div id="outline-container-5-1-3" class="outline-4">
<h4 id="sec-5-1-3"><span class="section-number-4">5.1.3</span> __sys_sendmsg()</h4>
<div class="outline-text-4" id="text-5-1-3">

<p>    关键路径：　<br/>
    － 通过copy_from_user把用户的struct msghdr拷贝到内核的msg_sys。<br/>
    － 也通过verify_iovec()把用户buff中的内容拷贝到内核的iovstack中。<br/>
    － 最后调用sock_sendmsg().<br/>
</p>
<p>    <br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">__sys_sendmsg</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">socket</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sock</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg</span><span style="color: #8b6508;">,</span>
<span class="linenr">  2:  </span>             <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg_sys</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">unsigned</span> <span style="color: #a0522d;">flags</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>             <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">used_address</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">used_address</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">compat_msghdr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg_compat</span> <span style="color: #8b6508;">=</span>
<span class="linenr">  6:  </span>        <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">compat_msghdr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>msg<span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr_storage</span> <span style="color: #a0522d;">address</span><span style="color: #8b6508;">;</span>
<span class="linenr">  8:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span> <span style="color: #a0522d;">iovstack</span><span style="color: #cd2626;">[</span>UIO_FASTIOV<span style="color: #cd2626;">]</span><span style="color: #8b6508;">,</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">iov</span> <span style="color: #8b6508;">=</span> iovstack<span style="color: #8b6508;">;</span>
<span class="linenr">  9:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">char</span> <span style="color: #a0522d;">ctl</span><span style="color: #cd2626;">[</span><span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">cmsghdr</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">20</span><span style="color: #cd2626;">]</span>
<span class="linenr"> 10:  </span>        <span style="color: #a020f0;">__attribute__</span> <span style="color: #cd2626;">((</span><span style="color: #008000; font-weight: bold;">aligned</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #228b22;">__kernel_size_t</span><span style="color: #cd2626;">))))</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 11:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">20 is size of ipv6_pktinfo </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 12:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">char</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">ctl_buf</span> <span style="color: #8b6508;">=</span> ctl<span style="color: #8b6508;">;</span>
<span class="linenr"> 13:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">ctl_len</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">iov_size</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">total_len</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 14:  </span>
<span class="linenr"> 15:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 16:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>MSG_CMSG_COMPAT <span style="color: #8b6508;">&amp;</span> flags<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 17:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">get_compat_msghdr</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> msg_compat<span style="color: #cd2626;">))</span>
<span class="linenr"> 18:  </span>            <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 19:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 20:  </span>    <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">copy_from_user</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> msg<span style="color: #8b6508;">,</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span><span style="color: #cd2626;">)))</span>
<span class="linenr"> 21:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 22:  </span>
<span class="linenr"> 23:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">do not move before msg_sys is valid </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 24:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EMSGSIZE<span style="color: #8b6508;">;</span>
<span class="linenr"> 25:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">&gt;</span> UIO_MAXIOV<span style="color: #cd2626;">)</span>
<span class="linenr"> 26:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 27:  </span>
<span class="linenr"> 28:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Check whether to allocate the iovec area </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 29:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>ENOMEM<span style="color: #8b6508;">;</span>
<span class="linenr"> 30:  </span>    iov_size <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">*</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 31:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">&gt;</span> UIO_FASTIOV<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 32:  </span>        iov <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_kmalloc</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> iov_size<span style="color: #8b6508;">,</span> GFP_KERNEL<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 33:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!iov<span style="color: #cd2626;">)</span>
<span class="linenr"> 34:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 35:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 36:  </span>
<span class="linenr"> 37:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">This will also move the address data into kernel space </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 38:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>MSG_CMSG_COMPAT <span style="color: #8b6508;">&amp;</span> flags<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 39:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">verify_compat_iovec</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> iov<span style="color: #8b6508;">,</span>
<span class="linenr"> 40:  </span>                      <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #8b6508;">,</span>
<span class="linenr"> 41:  </span>                      VERIFY_READ<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 42:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span>
<span class="linenr"> 43:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">verify_iovec</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> iov<span style="color: #8b6508;">,</span>
<span class="linenr"> 44:  </span>                   <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #8b6508;">,</span>
<span class="linenr"> 45:  </span>                   VERIFY_READ<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 46:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err <span style="color: #8b6508;">&lt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 47:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 48:  </span>    total_len <span style="color: #8b6508;">=</span> err<span style="color: #8b6508;">;</span>
<span class="linenr"> 49:  </span>
<span class="linenr"> 50:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>ENOBUFS<span style="color: #8b6508;">;</span>
<span class="linenr"> 51:  </span>
<span class="linenr"> 52:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_controllen</span> <span style="color: #8b6508;">&gt;</span> INT_MAX<span style="color: #cd2626;">)</span>
<span class="linenr"> 53:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 54:  </span>    ctl_len <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_controllen</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 55:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>MSG_CMSG_COMPAT <span style="color: #8b6508;">&amp;</span> flags<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> ctl_len<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 56:  </span>        err <span style="color: #8b6508;">=</span>
<span class="linenr"> 57:  </span>            <span style="color: #008000; font-weight: bold;">cmsghdr_from_user_compat_to_kern</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> ctl<span style="color: #8b6508;">,</span>
<span class="linenr"> 58:  </span>                             <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span>ctl<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 59:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span>
<span class="linenr"> 60:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 61:  </span>        ctl_buf <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_control</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 62:  </span>        ctl_len <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_controllen</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 63:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_len<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 64:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_len <span style="color: #8b6508;">&gt;</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span>ctl<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 65:  </span>            ctl_buf <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_kmalloc</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> ctl_len<span style="color: #8b6508;">,</span> GFP_KERNEL<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 66:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_buf <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 67:  </span>                <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 68:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr"> 69:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 70:  </span>        <span style="color: #b22222;">/*</span>
<span class="linenr"> 71:  </span><span style="color: #b22222;">         * Careful! Before this, msg_sys-&gt;msg_control contains a user pointer.</span>
<span class="linenr"> 72:  </span><span style="color: #b22222;">         * Afterwards, it will be a kernel pointer. Thus the compiler-assisted</span>
<span class="linenr"> 73:  </span><span style="color: #b22222;">         * checking falls down on this.</span>
<span class="linenr"> 74:  </span><span style="color: #b22222;">         </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 75:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">copy_from_user</span><span style="color: #cd2626;">(</span>ctl_buf<span style="color: #8b6508;">,</span> <span style="color: #cd2626;">(</span><span style="color: #228b22;">void</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_control</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 76:  </span>                   ctl_len<span style="color: #cd2626;">))</span>
<span class="linenr"> 77:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freectl</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 78:  </span>        msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_control</span> <span style="color: #8b6508;">=</span> ctl_buf<span style="color: #8b6508;">;</span>
<span class="linenr"> 79:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 80:  </span>    msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_flags</span> <span style="color: #8b6508;">=</span> flags<span style="color: #8b6508;">;</span>
<span class="linenr"> 81:  </span>
<span class="linenr"> 82:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">f_flags</span> <span style="color: #8b6508;">&amp;</span> O_NONBLOCK<span style="color: #cd2626;">)</span>
<span class="linenr"> 83:  </span>        msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_flags</span> <span style="color: #8b6508;">|=</span> MSG_DONTWAIT<span style="color: #8b6508;">;</span>
<span class="linenr"> 84:  </span>    <span style="color: #b22222;">/*</span>
<span class="linenr"> 85:  </span><span style="color: #b22222;">     * If this is sendmmsg() and current destination address is same as</span>
<span class="linenr"> 86:  </span><span style="color: #b22222;">     * previously succeeded address, omit asking LSM's decision.</span>
<span class="linenr"> 87:  </span><span style="color: #b22222;">     * used_address-&gt;name_len is initialized to UINT_MAX so that the first</span>
<span class="linenr"> 88:  </span><span style="color: #b22222;">     * destination address never matches.</span>
<span class="linenr"> 89:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 90:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>used_address <span style="color: #8b6508;">&amp;&amp;</span> used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span> <span style="color: #8b6508;">==</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_namelen</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 91:  </span>        !<span style="color: #008000; font-weight: bold;">memcmp</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name</span><span style="color: #8b6508;">,</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_name</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 92:  </span>            used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 93:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sendmsg_nosec</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> msg_sys<span style="color: #8b6508;">,</span> total_len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 94:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freectl</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 95:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 96:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sendmsg</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> msg_sys<span style="color: #8b6508;">,</span> total_len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 97:  </span>    <span style="color: #b22222;">/*</span>
<span class="linenr"> 98:  </span><span style="color: #b22222;">     * If this is sendmmsg() and sending to current destination address was</span>
<span class="linenr"> 99:  </span><span style="color: #b22222;">     * successful, remember it.</span>
<span class="linenr">100:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">101:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>used_address <span style="color: #8b6508;">&amp;&amp;</span> err <span style="color: #8b6508;">&gt;=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">102:  </span>        used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span> <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_namelen</span><span style="color: #8b6508;">;</span>
<span class="linenr">103:  </span>        <span style="color: #008000; font-weight: bold;">memcpy</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name</span><span style="color: #8b6508;">,</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_name</span><span style="color: #8b6508;">,</span>
<span class="linenr">104:  </span>               used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">105:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">106:  </span>
<span class="linenr">107:  </span><span style="color: #008b8b;">out_freectl</span><span style="color: #8b6508;">:</span>
<span class="linenr">108:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_buf <span style="color: #8b6508;">!=</span> ctl<span style="color: #cd2626;">)</span>
<span class="linenr">109:  </span>        <span style="color: #008000; font-weight: bold;">sock_kfree_s</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> ctl_buf<span style="color: #8b6508;">,</span> ctl_len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">110:  </span><span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">:</span>
<span class="linenr">111:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>iov <span style="color: #8b6508;">!=</span> iovstack<span style="color: #cd2626;">)</span>
<span class="linenr">112:  </span>        <span style="color: #008000; font-weight: bold;">sock_kfree_s</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> iov<span style="color: #8b6508;">,</span> iov_size<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">113:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">114:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">115:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">116:  </span>
</pre>

    </div>
</p>
<p>     <br/>
</p></div>

</div>

<div id="outline-container-5-1-4" class="outline-4">
<h4 id="sec-5-1-4"><span class="section-number-4">5.1.4</span> tcp_sendmsg():</h4>
<div class="outline-text-4" id="text-5-1-4">


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">sendmsg&#31995;&#32479;&#35843;&#29992;&#22312;TCP&#23618;&#30340;&#23454;&#29616; </span><span style="color: #b22222;">*/</span>
<span class="linenr">  2:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_sendmsg</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">kiocb</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">iocb</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>        <span style="color: #228b22;">size_t</span> <span style="color: #a0522d;">size</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">iov</span><span style="color: #8b6508;">;</span>
<span class="linenr">  6:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">;</span>
<span class="linenr">  8:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">iovlen</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">flags</span><span style="color: #8b6508;">;</span>
<span class="linenr">  9:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">mss_now</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 10:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">copied</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 11:  </span>    <span style="color: #228b22;">long</span> <span style="color: #a0522d;">timeo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 12:  </span>
<span class="linenr"> 13:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#21462;&#22871;&#25509;&#21475;&#30340;&#38145; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 14:  </span>    <span style="color: #008000; font-weight: bold;">lock_sock</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 15:  </span>    <span style="color: #008000; font-weight: bold;">TCP_CHECK_TIMER</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 16:  </span>
<span class="linenr"> 17:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#26631;&#24535;&#35745;&#31639;&#38459;&#22622;&#36229;&#26102;&#26102;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 18:  </span>    flags <span style="color: #8b6508;">=</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_flags</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 19:  </span>    timeo <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sndtimeo</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flags <span style="color: #8b6508;">&amp;</span> MSG_DONTWAIT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 20:  </span>
<span class="linenr"> 21:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Wait for a connection to finish. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 22:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span><span style="color: #ff0000;">1</span> <span style="color: #8b6508;">&lt;&lt;</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;</span> <span style="color: #8b6508;">~</span><span style="color: #cd2626;">(</span>TCPF_ESTABLISHED <span style="color: #8b6508;">|</span> TCPF_CLOSE_WAIT<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21482;&#26377;&#36825;&#20004;&#31181;&#29366;&#24577;&#25165;&#33021;&#21457;&#36865;&#28040;&#24687; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 23:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_wait_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>timeo<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">!=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20854;&#23427;&#29366;&#24577;&#19979;&#31561;&#24453;&#36830;&#25509;&#27491;&#30830;&#24314;&#31435;&#65292;&#36229;&#26102;&#21017;&#36827;&#34892;&#38169;&#35823;&#22788;&#29702; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 24:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_err</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 25:  </span>
<span class="linenr"> 26:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">This should be in poll </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 27:  </span>    <span style="color: #008000; font-weight: bold;">clear_bit</span><span style="color: #cd2626;">(</span>SOCK_ASYNC_NOSPACE<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_socket</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 28:  </span>
<span class="linenr"> 29:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#24471;&#26377;&#25928;&#30340;MSS&#65292;&#22914;&#26524;&#25903;&#25345;OOB&#65292;&#21017;&#19981;&#33021;&#25903;&#25345;TSO&#65292;MSS&#21017;&#24212;&#24403;&#26159;&#27604;&#36739;&#23567;&#30340;&#20540; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 30:  </span>    mss_now <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> !<span style="color: #cd2626;">(</span>flags<span style="color: #8b6508;">&amp;</span>MSG_OOB<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 31:  </span>
<span class="linenr"> 32:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Ok commence sending. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 33:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#21462;&#24453;&#21457;&#36865;&#25968;&#25454;&#22359;&#25968;&#21450;&#25968;&#25454;&#22359;&#25351;&#38024; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 34:  </span>    iovlen <span style="color: #8b6508;">=</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 35:  </span>    iov <span style="color: #8b6508;">=</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 36:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">copied&#34920;&#31034;&#20174;&#29992;&#25143;&#25968;&#25454;&#22359;&#22797;&#21046;&#21040;skb&#20013;&#30340;&#23383;&#33410;&#25968;&#12290; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 37:  </span>    copied <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 38:  </span>
<span class="linenr"> 39:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EPIPE<span style="color: #8b6508;">;</span>
<span class="linenr"> 40:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22871;&#25509;&#21475;&#23384;&#22312;&#38169;&#35823;&#65292;&#21017;&#19981;&#20801;&#35768;&#21457;&#36865;&#25968;&#25454;&#65292;&#36820;&#22238;EPIPE&#38169;&#35823; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 41:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_err</span> <span style="color: #8b6508;">||</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_shutdown</span> <span style="color: #8b6508;">&amp;</span> SEND_SHUTDOWN<span style="color: #cd2626;">))</span>
<span class="linenr"> 42:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 43:  </span>
<span class="linenr"> 44:  </span>    <span style="color: #a020f0;">while</span> <span style="color: #cd2626;">(</span><span style="color: #8b6508;">--</span>iovlen <span style="color: #8b6508;">&gt;=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;&#25152;&#26377;&#24453;&#21457;&#36865;&#25968;&#25454;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 45:  </span>        <span style="color: #228b22;">int</span> <span style="color: #a0522d;">seglen</span> <span style="color: #8b6508;">=</span> iov<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">iov_len</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 46:  </span>        <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">char</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*</span>from <span style="color: #8b6508;">=</span> iov<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">iov_base</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 47:  </span>
<span class="linenr"> 48:  </span>        iov<span style="color: #8b6508;">++;</span>
<span class="linenr"> 49:  </span>
<span class="linenr"> 50:  </span>        <span style="color: #a020f0;">while</span> <span style="color: #cd2626;">(</span>seglen <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;&#21333;&#20010;&#25968;&#25454;&#22359;&#20013;&#30340;&#25152;&#26377;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 51:  </span>            <span style="color: #228b22;">int</span> <span style="color: #a0522d;">copy</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 52:  </span>
<span class="linenr"> 53:  </span>            skb <span style="color: #8b6508;">=</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_write_queue</span><span style="color: #8b6508;">.</span><span style="color: #008000;">prev</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 54:  </span>
<span class="linenr"> 55:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span> <span style="color: #8b6508;">||</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;&#38431;&#21015;&#20026;&#31354;&#65292;&#21069;&#38754;&#21462;&#24471;&#30340;skb&#26080;&#25928; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 56:  </span>                <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">=</span> mss_now <span style="color: #8b6508;">-</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&lt;=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;skb&#26377;&#25928;&#65292;&#20294;&#26159;&#23427;&#24050;&#32463;&#27809;&#26377;&#22810;&#20313;&#30340;&#31354;&#38388;&#22797;&#21046;&#26032;&#25968;&#25454;&#20102; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 57:  </span>
<span class="linenr"> 58:  </span><span style="color: #008b8b;">new_segment</span><span style="color: #8b6508;">:</span>
<span class="linenr"> 59:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Allocate new segment. If the interface is SG,</span>
<span class="linenr"> 60:  </span><span style="color: #b22222;">                 * allocate skb fitting to single page.</span>
<span class="linenr"> 61:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 62:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">sk_stream_memory_free</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;&#38431;&#21015;&#20013;&#25968;&#25454;&#38271;&#24230;&#36798;&#21040;&#21457;&#36865;&#32531;&#20914;&#21306;&#30340;&#19978;&#38480;&#65292;&#31561;&#24453;&#32531;&#20914;&#21306; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 63:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">wait_for_sndbuf</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 64:  </span>
<span class="linenr"> 65:  </span>                skb <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_alloc_pskb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">select_size</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 66:  </span>                               <span style="color: #ff0000;">0</span><span style="color: #8b6508;">,</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_allocation</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#26032;&#30340;skb </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 67:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!skb<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#22833;&#36133;&#65292;&#35828;&#26126;&#31995;&#32479;&#20869;&#23384;&#19981;&#36275;&#65292;&#31561;&#24453; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 68:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">wait_for_memory</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 69:  </span>
<span class="linenr"> 70:  </span>                <span style="color: #b22222;">/*</span>
<span class="linenr"> 71:  </span><span style="color: #b22222;">                 * Check whether we can use HW checksum.</span>
<span class="linenr"> 72:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 73:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_route_caps</span> <span style="color: #8b6508;">&amp;</span>
<span class="linenr"> 74:  </span>                    <span style="color: #cd2626;">(</span>NETIF_F_IP_CSUM <span style="color: #8b6508;">|</span> NETIF_F_NO_CSUM <span style="color: #8b6508;">|</span>
<span class="linenr"> 75:  </span>                     NETIF_F_HW_CSUM<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#36335;&#30001;&#32593;&#32476;&#35774;&#22791;&#30340;&#29305;&#24615;&#65292;&#30830;&#23450;&#26159;&#21542;&#30001;&#30828;&#20214;&#25191;&#34892;&#26657;&#39564;&#21644; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 76:  </span>                    skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ip_summed</span> <span style="color: #8b6508;">=</span> CHECKSUM_HW<span style="color: #8b6508;">;</span>
<span class="linenr"> 77:  </span>
<span class="linenr"> 78:  </span>                <span style="color: #008000; font-weight: bold;">skb_entail</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23558;SKB&#28155;&#21152;&#21040;&#21457;&#36865;&#38431;&#21015;&#23614;&#37096; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 79:  </span>                copy <span style="color: #8b6508;">=</span> mss_now<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26412;&#27425;&#38656;&#35201;&#22797;&#21046;&#30340;&#25968;&#25454;&#37327;&#26159;MSS </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 80:  </span>            <span style="color: #cd2626;">}</span>
<span class="linenr"> 81:  </span>
<span class="linenr"> 82:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Try to append data to the end of skb. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 83:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">&gt;</span> seglen<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35201;&#22797;&#21046;&#30340;&#25968;&#25454;&#19981;&#33021;&#22823;&#20110;&#24403;&#21069;&#27573;&#30340;&#38271;&#24230; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 84:  </span>                copy <span style="color: #8b6508;">=</span> seglen<span style="color: #8b6508;">;</span>
<span class="linenr"> 85:  </span>
<span class="linenr"> 86:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Where to copy to? </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 87:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">skb_tailroom</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">skb&#32447;&#24615;&#23384;&#20648;&#21306;&#24213;&#37096;&#36824;&#26377;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 88:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">We have some space in skb head. Superb! </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 89:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">&gt;</span> <span style="color: #008000; font-weight: bold;">skb_tailroom</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26412;&#27425;&#21482;&#22797;&#21046;skb&#23384;&#20648;&#21306;&#24213;&#37096;&#21097;&#20313;&#31354;&#38388;&#22823;&#23567;&#30340;&#25968;&#25454;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 90:  </span>                    copy <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_tailroom</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 91:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#29992;&#25143;&#31354;&#38388;&#22797;&#21046;&#25351;&#23450;&#38271;&#24230;&#30340;&#25968;&#25454;&#21040;skb&#20013;&#65292;&#22914;&#26524;&#22833;&#36133;&#65292;&#21017;&#36864;&#20986; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 92:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_add_data</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> from<span style="color: #8b6508;">,</span> copy<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">!=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 93:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_fault</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 94:  </span>            <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#32447;&#24615;&#23384;&#20648;&#21306;&#24213;&#37096;&#24050;&#32463;&#27809;&#26377;&#31354;&#38388;&#20102;&#65292;&#22797;&#21046;&#21040;&#20998;&#25955;/&#32858;&#38598;&#23384;&#20648;&#21306;&#20013; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 95:  </span>                <span style="color: #228b22;">int</span> <span style="color: #a0522d;">merge</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26159;&#21542;&#22312;&#39029;&#20013;&#28155;&#21152;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 96:  </span>                <span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">nr_frags</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#25955;/&#32858;&#38598;&#29255;&#26029;&#25968; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 97:  </span>                <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">page</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#29255;&#39029;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 98:  </span>                <span style="color: #228b22;">int</span> <span style="color: #a0522d;">off</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_OFF</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#29255;&#20869;&#30340;&#20559;&#31227; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 99:  </span>
<span class="linenr">100:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">skb_can_coalesce</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> i<span style="color: #8b6508;">,</span> page<span style="color: #8b6508;">,</span> off<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">101:  </span>                    off <span style="color: #8b6508;">!=</span> PAGE_SIZE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24403;&#21069;&#20998;&#29255;&#36824;&#33021;&#28155;&#21152;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">102:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">We can extend the last page</span>
<span class="linenr">103:  </span><span style="color: #b22222;">                     * fragment. </span><span style="color: #b22222;">*/</span>
<span class="linenr">104:  </span>                    merge <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">105:  </span>                <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>i <span style="color: #8b6508;">==</span> MAX_SKB_FRAGS <span style="color: #8b6508;">||</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30446;&#21069;skb&#20013;&#30340;&#39029;&#19981;&#33021;&#28155;&#21152;&#25968;&#25454;&#65292;&#36825;&#37324;&#21028;&#26029;&#26159;&#21542;&#33021;&#20877;&#20998;&#37197;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">106:  </span>                       <span style="color: #cd2626;">(</span>!i <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">107:  </span>                       !<span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_route_caps</span> <span style="color: #8b6508;">&amp;</span> NETIF_F_SG<span style="color: #cd2626;">)))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#32593;&#21345;&#19981;&#25903;&#25345;S/G&#65292;&#19981;&#33021;&#20998;&#29255; </span><span style="color: #b22222;">*/</span>
<span class="linenr">108:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Need to add new fragment and cannot</span>
<span class="linenr">109:  </span><span style="color: #b22222;">                     * do this because interface is non-SG,</span>
<span class="linenr">110:  </span><span style="color: #b22222;">                     * or because all the page slots are</span>
<span class="linenr">111:  </span><span style="color: #b22222;">                     * busy. </span><span style="color: #b22222;">*/</span>
<span class="linenr">112:  </span>                    <span style="color: #008000; font-weight: bold;">tcp_mark_push</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">SKB&#21487;&#20197;&#25552;&#20132;&#20102; </span><span style="color: #b22222;">*/</span>
<span class="linenr">113:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">new_segment</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37325;&#26032;&#20998;&#37197;skb </span><span style="color: #b22222;">*/</span>
<span class="linenr">114:  </span>                <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#39029;&#25968;&#37327;&#26410;&#36798;&#21040;&#19978;&#38480;&#65292;&#21028;&#26029;&#24403;&#21069;&#39029;&#26159;&#21542;&#36824;&#26377;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">115:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">If page is cached, align</span>
<span class="linenr">116:  </span><span style="color: #b22222;">                     * offset to L1 cache boundary</span>
<span class="linenr">117:  </span><span style="color: #b22222;">                     </span><span style="color: #b22222;">*/</span>
<span class="linenr">118:  </span>                    off <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span>off <span style="color: #8b6508;">+</span> L1_CACHE_BYTES <span style="color: #8b6508;">-</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;</span>
<span class="linenr">119:  </span>                          <span style="color: #8b6508;">~</span><span style="color: #cd2626;">(</span>L1_CACHE_BYTES <span style="color: #8b6508;">-</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">120:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>off <span style="color: #8b6508;">==</span> PAGE_SIZE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26368;&#21518;&#19968;&#20010;&#20998;&#39029;&#25968;&#25454;&#24050;&#32463;&#28385;&#65292;&#38656;&#35201;&#20998;&#37197;&#26032;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">121:  </span>                        <span style="color: #008000; font-weight: bold;">put_page</span><span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">122:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> page <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">123:  </span>                    <span style="color: #cd2626;">}</span>
<span class="linenr">124:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">125:  </span>
<span class="linenr">126:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!page<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38656;&#35201;&#20998;&#37197;&#26032;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">127:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Allocate new cache page. </span><span style="color: #b22222;">*/</span>
<span class="linenr">128:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>page <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_alloc_page</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#26032;&#39029;&#65292;&#22914;&#26524;&#20869;&#23384;&#19981;&#36275;&#21017;&#31561;&#24453;&#20869;&#23384; </span><span style="color: #b22222;">*/</span>
<span class="linenr">129:  </span>                        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">wait_for_memory</span><span style="color: #8b6508;">;</span>
<span class="linenr">130:  </span>                    off <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">131:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">132:  </span>
<span class="linenr">133:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">&gt;</span> PAGE_SIZE <span style="color: #8b6508;">-</span> off<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24453;&#22797;&#21046;&#30340;&#25968;&#25454;&#19981;&#33021;&#22823;&#20110;&#39029;&#20013;&#21097;&#20313;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">134:  </span>                    copy <span style="color: #8b6508;">=</span> PAGE_SIZE <span style="color: #8b6508;">-</span> off<span style="color: #8b6508;">;</span>
<span class="linenr">135:  </span>
<span class="linenr">136:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Time to copy data. We are close to</span>
<span class="linenr">137:  </span><span style="color: #b22222;">                 * the end! </span><span style="color: #b22222;">*/</span>
<span class="linenr">138:  </span>                err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_copy_to_page</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> from<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> page<span style="color: #8b6508;">,</span>
<span class="linenr">139:  </span>                               off<span style="color: #8b6508;">,</span> copy<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#29992;&#25143;&#24577;&#22797;&#21046;&#25968;&#25454;&#21040;&#39029;&#20013; </span><span style="color: #b22222;">*/</span>
<span class="linenr">140:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22797;&#21046;&#22833;&#36133;&#20102; </span><span style="color: #b22222;">*/</span>
<span class="linenr">141:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">If this page was new, give it to the</span>
<span class="linenr">142:  </span><span style="color: #b22222;">                     * socket so it does not get leaked.</span>
<span class="linenr">143:  </span><span style="color: #b22222;">                     </span><span style="color: #b22222;">*/</span>
<span class="linenr">144:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26159;&#26032;&#20998;&#37197;&#30340;&#39029;&#65292;&#21017;&#23558;&#39029;&#35760;&#24405;&#21040;skb&#20013;&#65292;&#20379;&#20170;&#21518;&#20351;&#29992; </span><span style="color: #b22222;">*/</span>
<span class="linenr">145:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> page<span style="color: #8b6508;">;</span>
<span class="linenr">146:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_OFF</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">147:  </span>                    <span style="color: #cd2626;">}</span>
<span class="linenr">148:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">;</span>
<span class="linenr">149:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">150:  </span>
<span class="linenr">151:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Update the skb. </span><span style="color: #b22222;">*/</span>
<span class="linenr">152:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;skb&#30340;&#20998;&#27573;&#20449;&#24687; </span><span style="color: #b22222;">*/</span>
<span class="linenr">153:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>merge<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;&#26368;&#21518;&#19968;&#20010;&#39029;&#20013;&#36861;&#21152;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">154:  </span>                    <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frags</span><span style="color: #cd2626;">[</span>i <span style="color: #8b6508;">-</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span><span style="color: #8b6508;">.</span><span style="color: #008000;">size</span> <span style="color: #8b6508;">+=</span>
<span class="linenr">155:  </span>                                    copy<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#26368;&#21518;&#19968;&#39029;&#30340;&#25968;&#25454;&#38271;&#24230; </span><span style="color: #b22222;">*/</span>
<span class="linenr">156:  </span>                <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26032;&#20998;&#37197;&#30340;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">157:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;skb&#20013;&#20998;&#29255;&#20449;&#24687; </span><span style="color: #b22222;">*/</span>
<span class="linenr">158:  </span>                    <span style="color: #008000; font-weight: bold;">skb_fill_page_desc</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> i<span style="color: #8b6508;">,</span> page<span style="color: #8b6508;">,</span> off<span style="color: #8b6508;">,</span> copy<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">159:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr">160:  </span>                        <span style="color: #008000; font-weight: bold;">get_page</span><span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">161:  </span>                    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>off <span style="color: #8b6508;">+</span> copy <span style="color: #8b6508;">&lt;</span> PAGE_SIZE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">162:  </span>                        <span style="color: #008000; font-weight: bold;">get_page</span><span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">163:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> page<span style="color: #8b6508;">;</span>
<span class="linenr">164:  </span>                    <span style="color: #cd2626;">}</span>
<span class="linenr">165:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">166:  </span>
<span class="linenr">167:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#39029;&#20869;&#20559;&#31227; </span><span style="color: #b22222;">*/</span>
<span class="linenr">168:  </span>                <span style="color: #008000; font-weight: bold;">TCP_OFF</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> off <span style="color: #8b6508;">+</span> copy<span style="color: #8b6508;">;</span>
<span class="linenr">169:  </span>            <span style="color: #cd2626;">}</span>
<span class="linenr">170:  </span>
<span class="linenr">171:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!copied<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#27809;&#26377;&#22797;&#21046;&#25968;&#25454;&#65292;&#21017;&#21462;&#28040;PSH&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr">172:  </span>                <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span> <span style="color: #8b6508;">&amp;=</span> <span style="color: #8b6508;">~</span>TCPCB_FLAG_PSH<span style="color: #8b6508;">;</span>
<span class="linenr">173:  </span>
<span class="linenr">174:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span> <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#21457;&#36865;&#38431;&#21015;&#26368;&#21518;&#19968;&#20010;&#21253;&#30340;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">175:  </span>            <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span> <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;skb&#30340;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">176:  </span>            <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tso_segs</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">177:  </span>
<span class="linenr">178:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#25968;&#25454;&#22797;&#21046;&#30340;&#25351;&#38024; </span><span style="color: #b22222;">*/</span>
<span class="linenr">179:  </span>            from <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span>
<span class="linenr">180:  </span>            copied <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span>
<span class="linenr">181:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#25152;&#26377;&#25968;&#25454;&#24050;&#32463;&#22797;&#21046;&#23436;&#27605;&#21017;&#36864;&#20986; </span><span style="color: #b22222;">*/</span>
<span class="linenr">182:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>seglen <span style="color: #8b6508;">-=</span> copy<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">==</span> <span style="color: #ff0000;">0</span> <span style="color: #8b6508;">&amp;&amp;</span> iovlen <span style="color: #8b6508;">==</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr">183:  </span>                <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">184:  </span>
<span class="linenr">185:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#24403;&#21069;skb&#20013;&#30340;&#25968;&#25454;&#23567;&#20110;mss&#65292;&#35828;&#26126;&#21487;&#20197;&#24448;&#37324;&#38754;&#32487;&#32493;&#22797;&#21046;&#25968;&#25454;&#12290;&#25110;&#32773;&#21457;&#36865;&#30340;&#26159;OOB&#25968;&#25454;&#65292;&#21017;&#20063;&#36339;&#36807;&#21457;&#36865;&#36807;&#31243;&#65292;&#32487;&#32493;&#22797;&#21046;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">186:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span> <span style="color: #8b6508;">!=</span> mss_now <span style="color: #8b6508;">||</span> <span style="color: #cd2626;">(</span>flags <span style="color: #8b6508;">&amp;</span> MSG_OOB<span style="color: #cd2626;">))</span>
<span class="linenr">187:  </span>                <span style="color: #a020f0;">continue</span><span style="color: #8b6508;">;</span>
<span class="linenr">188:  </span>
<span class="linenr">189:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">forced_push</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24517;&#39035;&#31435;&#21363;&#21457;&#36865;&#25968;&#25454;&#65292;&#21363;&#19978;&#27425;&#21457;&#36865;&#21518;&#20135;&#29983;&#30340;&#25968;&#25454;&#24050;&#32463;&#36229;&#36807;&#36890;&#21578;&#31383;&#21475;&#20540;&#30340;&#19968;&#21322; </span><span style="color: #b22222;">*/</span>
<span class="linenr">190:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;PSH&#26631;&#24535;&#21518;&#21457;&#36865;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">191:  </span>                <span style="color: #008000; font-weight: bold;">tcp_mark_push</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">192:  </span>                <span style="color: #008000; font-weight: bold;">__tcp_push_pending_frames</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> mss_now<span style="color: #8b6508;">,</span> TCP_NAGLE_PUSH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">193:  </span>            <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>skb <span style="color: #8b6508;">==</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#34429;&#28982;&#19981;&#26159;&#24517;&#39035;&#21457;&#36865;&#25968;&#25454;&#65292;&#20294;&#26159;&#21457;&#36865;&#38431;&#21015;&#19978;&#21482;&#23384;&#22312;&#24403;&#21069;&#27573;&#65292;&#20063;&#23558;&#20854;&#21457;&#36865;&#20986;&#21435; </span><span style="color: #b22222;">*/</span>
<span class="linenr">194:  </span>                <span style="color: #008000; font-weight: bold;">tcp_push_one</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> mss_now<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">195:  </span>            <span style="color: #a020f0;">continue</span><span style="color: #8b6508;">;</span>
<span class="linenr">196:  </span>
<span class="linenr">197:  </span><span style="color: #008b8b;">wait_for_sndbuf</span><span style="color: #8b6508;">:</span>
<span class="linenr">198:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30001;&#20110;&#21457;&#36865;&#38431;&#21015;&#28385;&#30340;&#21407;&#22240;&#23548;&#33268;&#31561;&#24453; </span><span style="color: #b22222;">*/</span>
<span class="linenr">199:  </span>            <span style="color: #008000; font-weight: bold;">set_bit</span><span style="color: #cd2626;">(</span>SOCK_NOSPACE<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_socket</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">200:  </span><span style="color: #008b8b;">wait_for_memory</span><span style="color: #8b6508;">:</span>
<span class="linenr">201:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copied<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#34429;&#28982;&#27809;&#26377;&#20869;&#23384;&#20102;&#65292;&#20294;&#26159;&#26412;&#27425;&#35843;&#29992;&#22797;&#21046;&#20102;&#25968;&#25454;&#21040;&#32531;&#20914;&#21306;&#65292;&#35843;&#29992;tcp_push&#23558;&#20854;&#21457;&#36865;&#20986;&#21435; </span><span style="color: #b22222;">*/</span>
<span class="linenr">202:  </span>                <span style="color: #008000; font-weight: bold;">tcp_push</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> flags <span style="color: #8b6508;">&amp;</span> <span style="color: #8b6508;">~</span>MSG_MORE<span style="color: #8b6508;">,</span> mss_now<span style="color: #8b6508;">,</span> TCP_NAGLE_PUSH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">203:  </span>
<span class="linenr">204:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#31561;&#24453;&#20869;&#23384;&#21487;&#29992; </span><span style="color: #b22222;">*/</span>
<span class="linenr">205:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_wait_memory</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>timeo<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">!=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr">206:  </span>                <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30830;&#23454;&#27809;&#26377;&#20869;&#23384;&#20102;&#65292;&#36229;&#26102;&#21518;&#36820;&#22238;&#22833;&#36133; </span><span style="color: #b22222;">*/</span>
<span class="linenr">207:  </span>
<span class="linenr">208:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30561;&#30496;&#21518;&#65292;MSS&#21487;&#33021;&#21457;&#29983;&#20102;&#21464;&#21270;&#65292;&#37325;&#26032;&#35745;&#31639; </span><span style="color: #b22222;">*/</span>
<span class="linenr">209:  </span>            mss_now <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> !<span style="color: #cd2626;">(</span>flags<span style="color: #8b6508;">&amp;</span>MSG_OOB<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">210:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">211:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">212:  </span>
<span class="linenr">213:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">214:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copied<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#29992;&#25143;&#24577;&#22797;&#21046;&#20102;&#25968;&#25454;&#65292;&#21457;&#36865;&#23427; </span><span style="color: #b22222;">*/</span>
<span class="linenr">215:  </span>        <span style="color: #008000; font-weight: bold;">tcp_push</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> mss_now<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">nonagle</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">216:  </span>    <span style="color: #008000; font-weight: bold;">TCP_CHECK_TIMER</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">217:  </span>    <span style="color: #008000; font-weight: bold;">release_sock</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37322;&#25918;&#38145;&#20197;&#21518;&#36820;&#22238; </span><span style="color: #b22222;">*/</span>
<span class="linenr">218:  </span>    <span style="color: #a020f0;">return</span> copied<span style="color: #8b6508;">;</span>
<span class="linenr">219:  </span>
<span class="linenr">220:  </span><span style="color: #008b8b;">do_fault</span><span style="color: #8b6508;">:</span>
<span class="linenr">221:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22797;&#21046;&#25968;&#25454;&#22833;&#36133;&#20102;&#65292;&#22914;&#26524;skb&#38271;&#24230;&#20026;0&#65292;&#35828;&#26126;&#26159;&#26032;&#20998;&#37197;&#30340;&#65292;&#37322;&#25918;&#23427; </span><span style="color: #b22222;">*/</span>
<span class="linenr">222:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span> <span style="color: #8b6508;">==</span> skb<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;skb&#26159;&#21457;&#36865;&#38431;&#21015;&#22836;&#65292;&#21017;&#28165;&#31354;&#38431;&#21015;&#22836; </span><span style="color: #b22222;">*/</span>
<span class="linenr">223:  </span>            sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">224:  </span>        <span style="color: #008000; font-weight: bold;">__skb_unlink</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">list</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">225:  </span>        <span style="color: #008000; font-weight: bold;">sk_stream_free_skb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37322;&#25918;skb </span><span style="color: #b22222;">*/</span>
<span class="linenr">226:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">227:  </span>
<span class="linenr">228:  </span><span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">:</span>
<span class="linenr">229:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copied<span style="color: #cd2626;">)</span>
<span class="linenr">230:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">231:  </span><span style="color: #008b8b;">out_err</span><span style="color: #8b6508;">:</span>
<span class="linenr">232:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_error</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> err<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">233:  </span>    <span style="color: #008000; font-weight: bold;">TCP_CHECK_TIMER</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">234:  </span>    <span style="color: #008000; font-weight: bold;">release_sock</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">235:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">236:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>


<p>    <br/>
</p>
<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> 服务端响应请求</h3>
<div class="outline-text-3" id="text-5-2">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_established().当前服务端处于TCP_ESTABLISHED状态。<br/>
</li>
<li>代码关键路径:<br/>
</li>
</ul>


<p>     <br/>
</p></div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> 第25章 传输控制块</h2>
<div class="outline-text-2" id="text-6">


</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> 25.4 传输控制块的内存管理</h3>
<div class="outline-text-3" id="text-6-1">


</div>

<div id="outline-container-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> 25.4.4 接收缓存的分配与释放</h4>
<div class="outline-text-4" id="text-6-1-1">

<p>    书上说到设置该skb的sk宿主时TCP使用sk_stream_set_owner_r(),而到内核kernel-2.6.32中，<br/>
    TCP和UDP统一使用skb_set_owner_r().<br/>
</p>
<p><br/>
</p></div>
</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> 第29章 拥塞控制</h2>
<div class="outline-text-2" id="text-7">


</div>

<div id="outline-container-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> 拥塞状态</h3>
<div class="outline-text-3" id="text-7-1">

<ol>
<li>TCP_CA_Open <br/>
    这个状态是也就是初始状态，我们可以看到在tcp_create_openreq_child(这个函数的意思可以看我前面的blog)中，<br/>
    当我们new一个新的socket之后就会设置这个socket的状态为TCP_CA_Open。这个也可以说是fast path。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_Disorder <br/>
    当发送者检测到重复的ack或者sack就进入这个状态。在这个状态，拥塞窗口不会被调整，但是这个状态下的话，<br/>
    每一次新的输入数据包都会触发一个新的端的传输。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_CWR <br/>
    这个状态叫做 (Congestion Window Reduced),顾名思义，也就是当拥塞窗口减小的时候会进入这个状态。<br/>
    比如当发送者收到一个ECN，此时就需要减小窗口。这个状态能够被Recovery or Loss 所打断。当接收到一个拥塞提醒的时候，<br/>
    发送者是每接收到一个ack，就减小拥塞窗口一个段，直到窗口大小减半。因此可以这么说当发送者正在减小窗口并且没有任何重传段的时候，<br/>
    就会处于CWR状态。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_Recovery <br/>
    当足够数量的(一般是3个)的连续的重复ack到达发送端，则发送端立即重传第一个没有被ack的数据段，然后进入这个状态。<br/>
    处于这个状态的时候，发送者也是和CWR状态类似，每次接收到ack后减小窗口。在这个状态，拥塞窗口不会增长，发送者要么重传标记lost的段，<br/>
    要么传输新的段。当发送者进入这个状态时的没有被ack的段全部ack之后就离开这个状态。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_Loss <br/>
    当RTO超时后，发送者就进入这个状态。此时所有的没有被ack的段都标记为loss，然后降低窗口大小为1,然后进入慢开始阶段。<br/>
    loss状态不能被其他状态所中断。而这个状态的退出只有当进入loss时，所有的被标记为loss的段都得到ack后，才会再次返回open状态。<br/>
</li>
</ol>

</div>

</div>

<div id="outline-container-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> cwnd初始值</h3>
<div class="outline-text-3" id="text-7-2">

<ul>
<li>客户端初始化是在发送syn包后接收到syn/ack包时处于SYN_SENT状态下进行初始化的。<br/>
     tcp_rcv_synsent_state_process<sup><a class="footref" name="fnr-.1" href="#fn-.1">1</a></sup> tcp_init_metrics(sk);<br/>
</li>
<li>服务端初始化是在接收到syn包处于SYN_RECV状态下初始化的。<br/>
</li>
</ul>

<p>　　　tcp_rcv_state_process<sup><a class="footref" name="fnr-.2" href="#fn-.2">2</a></sup>    tcp_init_metrics(sk);　　<br/>
</p><ul>
<li>tcp_init_metrics()调用tcp_init_cwnd().<br/>
     tp-&gt;snd_cwnd = tcp_init_cwnd(tp, dst);<br/>
</li>
<li>tcp_init_cwnd()里实现取路由里设置的cwnd，TCP_INIT_CWND与tp-&gt;snd_cwnd_clamp取最小值。<br/>

<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #228b22;">__u32</span> <span style="color: #0000ff; font-size: 120%;">tcp_init_cwnd</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">dst_entry</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">dst</span><span style="color: #cd2626;">)</span>
<span class="linenr">2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">3:  </span>     <span style="color: #228b22;">__u32</span> <span style="color: #a0522d;">cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span>dst ? <span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_INITCWND<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">:</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">4:  </span>
<span class="linenr">5:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!cwnd<span style="color: #cd2626;">)</span>
<span class="linenr">6:  </span>         cwnd <span style="color: #8b6508;">=</span> TCP_INIT_CWND<span style="color: #8b6508;">;</span>
<span class="linenr">7:  </span>     <span style="color: #a020f0;">return</span> <span style="color: #228b22;">min_t</span><span style="color: #cd2626;">(</span>__u32<span style="color: #8b6508;">,</span> cwnd<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_clamp</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">8:  </span><span style="color: #cd2626;">}</span>
</pre>

     [注]: 目前centos 6.2里kernel-2.6.32的TCP_INIT_CWND值为10.<br/>

</p>
<hr/>
<p>
     *** include/net/tcp.h:<br/>
     TCP_INIT_CWND<sup><a class="footref" name="fnr-.3" href="#fn-.3">3</a></sup>             #define TCP_INIT_CWND 10<br/>

</p>
<hr/>
<ul>
<li>tp-&gt;snd_cwnd_clamp为允许的最大拥塞窗口值，初始值为65535。<br/>
       它通过tcp_v4_init_sock()里调用:<br/>
        tp-&gt;snd_cwnd_clamp = ~0;<br/>
       实现，其类型为u16.<br/>
</li>
</ul>

</li>
</ul>


<p><br/>

</p>
<hr/>
<p>
   *** net/ipv4/tcp_input.c:<br/>
   tcp_rcv_synsent_state_process<sup><a class="footref" name="fnr-.1.2" href="#fn-.1">1</a></sup> tcp_init_metrics(sk);<br/>
   tcp_rcv_state_process<sup><a class="footref" name="fnr-.2.2" href="#fn-.2">2</a></sup>    tcp_init_metrics(sk);<br/>

</p>
<hr/>

<p>   <br/>
</p>
<p>    <br/>
</p>
<p>    <br/>
</p></div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> 第30章 TCP的输出</h2>
<div class="outline-text-2" id="text-8">


</div>

<div id="outline-container-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> tcp_sendmsg()</h3>
<div class="outline-text-3" id="text-8-1">

<ol>
<li>先计算应该copy的序号与位置，设置skb-&gt;end_seq.<br/>
      TCP_SKB_CB(skb)-&gt;end_seq += copy;<br/>
</li>
<li>通过调用__tcp_push_pending_frames()发送队列的段。<br/>
      __tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH);<br/>
</li>
</ol>


<p>      <br/>
</p>
</div>

<div id="outline-container-8-1-1" class="outline-4">
<h4 id="sec-8-1-1"><span class="section-number-4">8.1.1</span> tcp_write_xmit()</h4>
<div class="outline-text-4" id="text-8-1-1">

<ol>
<li>使用tcp_cwnd_test()检查拥塞窗口是否还有空间。<br/>
</li>
<li>使用tcp_snd_wnd_test()检查滑动窗口是否还有空间。<br/>
</li>
<li>使用tcp_transmit_skb()发送当前skb.<br/>
</li>
<li>使用tcp_event_new_data_sent()递增packets_out.<br/>
</li>
</ol>


<p><br/>
</p><div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn-.1" href="#fnr-.1">1</a></sup> DEFINITION NOT FOUND: 5472<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.2" href="#fnr-.2">2</a></sup> DEFINITION NOT FOUND: 5713<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.3" href="#fnr-.3">3</a></sup> DEFINITION NOT FOUND: 203<br/>
</p>
<p><br/>
</p>
<p><br/>
</p>
<p>      <br/>
</p></div>
</div>
</div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2014-10-15T11:03+0800</p>
<p class="author">Author: mosp</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.3f with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
