<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>TCP内核源码分析笔记</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="TCP内核源码分析笔记"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2014-10-20T16:32+0800"/>
<meta name="author" content="mosp"/>
<meta name="description" content=""/>
<meta name="keywords" content="linux, kernel, tcp, 读书笔记， 网络管理"/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="/home/mosp/.emacs.d/style/style.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">TCP内核源码分析笔记</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 术语</a>
<ul>
<li><a href="#sec-1-1">1.1 ABC</a></li>
<li><a href="#sec-1-2">1.2 SACK</a></li>
<li><a href="#sec-1-3">1.3 D-SACK</a></li>
<li><a href="#sec-1-4">1.4 FACK</a></li>
<li><a href="#sec-1-5">1.5 F-RTO</a></li>
<li><a href="#sec-1-6">1.6 nagle算法</a></li>
<li><a href="#sec-1-7">1.7 cork算法</a></li>
<li><a href="#sec-1-8">1.8 template</a></li>
</ul>
</li>
<li><a href="#sec-2">2 tcp_v4_connect()</a></li>
<li><a href="#sec-3">3 sys_accept()</a>
<ul>
<li><a href="#sec-3-1">3.1 tcp_accept()</a></li>
</ul>
</li>
<li><a href="#sec-4">4 三次握手</a>
<ul>
<li><a href="#sec-4-1">4.1 客户端发送SYN段</a></li>
<li><a href="#sec-4-2">4.2 服务端接收到SYN段后，发送SYN/ACK处理</a></li>
<li><a href="#sec-4-3">4.3 客户端回复确认ACK段</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1 tcp_rcv_synsent_state_process()</a></li>
</ul>
</li>
<li><a href="#sec-4-4">4.4 服务端收到ACK段</a></li>
</ul>
</li>
<li><a href="#sec-5">5 数据传输</a>
<ul>
<li><a href="#sec-5-1">5.1 客户端请求数据</a>
<ul>
<li><a href="#sec-5-1-1">5.1.1 send()</a></li>
<li><a href="#sec-5-1-2">5.1.2 sendto()</a></li>
<li><a href="#sec-5-1-3">5.1.3 __sys_sendmsg()</a></li>
<li><a href="#sec-5-1-4">5.1.4 tcp_sendmsg():</a></li>
</ul>
</li>
<li><a href="#sec-5-2">5.2 服务端响应请求</a></li>
</ul>
</li>
<li><a href="#sec-6">6 第25章 传输控制块</a>
<ul>
<li><a href="#sec-6-1">6.1 25.4 传输控制块的内存管理</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1 25.4.4 接收缓存的分配与释放</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-7">7 第29章 拥塞控制</a>
<ul>
<li><a href="#sec-7-1">7.1 拥塞状态</a></li>
<li><a href="#sec-7-2">7.2 cwnd初始值</a></li>
<li><a href="#sec-7-3">7.3 慢启动</a>
<ul>
<li><a href="#sec-7-3-1">7.3.1 连接建立时</a></li>
<li><a href="#sec-7-3-2">7.3.2 tcp_ack()</a></li>
<li><a href="#sec-7-3-3">7.3.3 拥塞控制入口</a></li>
<li><a href="#sec-7-3-4">7.3.4 snd_ssthresh设置</a></li>
<li><a href="#sec-7-3-5">7.3.5 snd_cwnd_clamp设置</a>
<ul>
<li><a href="#sec-7-3-5-1">7.3.5.1 初始值后第一次修改</a></li>
<li><a href="#sec-7-3-5-2">7.3.5.2 连接复位前更新</a></li>
</ul>
</li>
<li><a href="#sec-7-3-6">7.3.6 拥塞控制实现</a></li>
<li><a href="#sec-7-3-7">7.3.7 慢启动算法</a></li>
<li><a href="#sec-7-3-8">7.3.8 备注</a></li>
</ul>
</li>
<li><a href="#sec-7-4">7.4 拥塞避免</a>
<ul>
<li><a href="#sec-7-4-1">7.4.1 拥塞避免算法</a></li>
</ul>
</li>
<li><a href="#sec-7-5">7.5 快速重传</a>
<ul>
<li><a href="#sec-7-5-1">7.5.1 快速重传做的事情有：</a></li>
<li><a href="#sec-7-5-2">7.5.2 第一个重复的ACK</a></li>
<li><a href="#sec-7-5-3">7.5.3 第2个重复的ACK</a></li>
<li><a href="#sec-7-5-4">7.5.4 第3个重复的ACK</a></li>
</ul>
</li>
<li><a href="#sec-7-6">7.6 快速恢复</a>
<ul>
<li><a href="#sec-7-6-1">7.6.1 具体来说快速恢复的主要步骤是：</a></li>
</ul>
</li>
<li><a href="#sec-7-7">7.7 拥塞状态机</a></li>
<li><a href="#sec-7-8">7.8 拥塞事件</a>
<ul>
<li><a href="#sec-7-8-1">7.8.1 TCP的拥塞事件集</a></li>
<li><a href="#sec-7-8-2">7.8.2 钩子函数定义</a></li>
<li><a href="#sec-7-8-3">7.8.3 封装调用</a></li>
<li><a href="#sec-7-8-4">7.8.4 CA_EVENT_TX_START</a></li>
<li><a href="#sec-7-8-5">7.8.5 CA_EVENT_CWND_RESTART</a></li>
<li><a href="#sec-7-8-6">7.8.6 CA_EVENT_COMPLETE_CWR</a></li>
<li><a href="#sec-7-8-7">7.8.7 CA_EVENT_FRTO</a></li>
<li><a href="#sec-7-8-8">7.8.8 CA_EVENT_LOSS</a></li>
<li><a href="#sec-7-8-9">7.8.9 CA_EVENT_FAST_ACK</a></li>
<li><a href="#sec-7-8-10">7.8.10 CA_EVENT_SLOW_ACK</a></li>
<li><a href="#sec-7-8-11">7.8.11 阈值的设置</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-8">8 第30章 TCP的输出</a>
<ul>
<li><a href="#sec-8-1">8.1 tcp_sendmsg()</a>
<ul>
<li><a href="#sec-8-1-1">8.1.1 tcp_write_xmit()</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 术语</h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> ABC</h3>
<div class="outline-text-3" id="text-1-1">

<ul>
<li>英文全称：Appropriate Byte Count<br/>
</li>
<li>中文全称: 适当字节计数<br/>
</li>
<li>功能描述: ABC是一种针对于部分确认应答的更慢地增加拥塞窗口(cwnd)的方法。<br/>
     可能的值为：<br/>
<ul>
<li>0: 每一个应答增加拥塞窗口一次(无ABC)<br/>
</li>
<li>1: 每一个最大传输段应答增加拥塞窗口一次<br/>
</li>
<li>2：允许增加拥塞控制窗口两次，如果应答是为了补偿延时应答的针对两个段的应答。<br/>
</li>
</ul>

</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> SACK</h3>
<div class="outline-text-3" id="text-1-2">

<ul>
<li>英文全称: Selective Acknowledgment.<br/>
</li>
<li>中文全称: 选择性确认<br/>
</li>
<li>功能描述: SACK是TCP选项，它使得接收方能告诉发送方哪些报文段丢失，哪些报文段重传了，哪些报文段已经提前收到等信息。<br/>
     根据这些信息TCP就可以只重传哪些真正丢失的报文段。需要注意的是只有收到失序的分组时才会可能会发送SACK，TCP的ACK还<br/>
     是建立在累积确认的基础上的。也就是说如果收到的报文段与期望收到的报文段的序号相同就会发送累积的ACK，SACK只是针对<br/>
     失序到达的报文段的。<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> D-SACK</h3>
<div class="outline-text-3" id="text-1-3">

<ul>
<li>英文全称: duplicate-Selective Acknowledgment.<br/>
</li>
<li>中文全称: 重复的SACK<br/>
</li>
<li>功能描述: RFC2883中对SACK进行了扩展。SACK中的信息描述的是收到的报文段，这些报文段可能是正常接收的，也可能是重复接收的，<br/>
     通过对SACK进行扩展，D-SACK可以在SACK选项中描述它重复收到的报文段。但是需要注意的是D-SACK只用于报告接收端收到的最后一<br/>
     个报文与已经接收了的报文的重复部分<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> FACK</h3>
<div class="outline-text-3" id="text-1-4">

<ul>
<li>英文全称: Forward Acknowledgment<br/>
</li>
<li>中文全称: 提前确认<br/>
</li>
<li>功能描述: FACK算法采取激进策略，将所有SACK的未确认区间当做丢失段。虽然这种策略通常带来更佳的网络性能，但是过于激进，因为SACK未确认的区间段可能只是发送了重排，而并非丢失<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> F-RTO</h3>
<div class="outline-text-3" id="text-1-5">

<ul>
<li>英文全称: Forward RTO Recovery<br/>
</li>
<li>中文全称: 虚假超时<br/>
</li>
<li>功能描述: F-RTO的基本思想是判断RTO是否正常，从而决定是否执行拥塞避免算法。方法是观察RTO之后的两个ACK。如果ACK不是冗余ACK，并且确认的包不是重传<br/>
     的，会认为RTO是虚假的就不执行拥塞避免算法。<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> nagle算法</h3>
<div class="outline-text-3" id="text-1-6">

<ul>
<li>功能描述: nagle算法主要目的是减少网络流量，当你发送的数据包太小时，TCP并不立即发送该数据包，而是缓存起来直到数据包到达一定大小后才发送。<br/>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> cork算法</h3>
<div class="outline-text-3" id="text-1-7">

<ul>
<li>功能描述: CORK算法的初衷：提高网络利用率，理想情况下，完全避免发送小包，仅仅发送满包以及不得不发的小包。<br/>
</li>
</ul>


<p>     <br/>
</p>
<p>     <br/>
</p></div>

</div>

<div id="outline-container-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> template</h3>
<div class="outline-text-3" id="text-1-8">

<ul>
<li>英文全称:<br/>
</li>
<li>中文全称:<br/>
</li>
<li>功能描述:<br/>
</li>
</ul>


<p>     <br/>
</p>
<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> tcp_v4_connect()</h2>
<div class="outline-text-2" id="text-2">

<ul>
<li>描述: 建立与服务器连接，发送SYN段<br/>
</li>
<li>返回值: 0或错误码<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_v4_connect</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">uaddr</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">addr_len</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #8b6508;">.....</span><span style="color: #008000;">&#12288;</span>     
<span class="linenr"> 4:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#30446;&#30340;&#22320;&#22336;&#21644;&#30446;&#26631;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 5:  </span>    inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">dport</span> <span style="color: #8b6508;">=</span> usin<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sin_port</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>    inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">daddr</span> <span style="color: #8b6508;">=</span> daddr<span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>    <span style="color: #8b6508;">....</span>     
<span class="linenr"> 8:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;MSS&#19978;&#38480; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">536</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>
<span class="linenr">11:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Socket identity is still unknown (sport may be zero).</span>
<span class="linenr">12:  </span><span style="color: #b22222;">     * However we set state to SYN-SENT and not releasing socket</span>
<span class="linenr">13:  </span><span style="color: #b22222;">     * lock select source port, enter ourselves into the hash tables and</span>
<span class="linenr">14:  </span><span style="color: #b22222;">     * complete initialization after this.</span>
<span class="linenr">15:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">16:  </span>    <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_SYN_SENT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#29366;&#24577; </span><span style="color: #b22222;">*/</span>
<span class="linenr">17:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_v4_hash_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23558;&#20256;&#36755;&#25511;&#21046;&#28155;&#21152;&#21040;ehash&#25955;&#21015;&#34920;&#20013;&#65292;&#24182;&#21160;&#24577;&#20998;&#37197;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr">18:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span>
<span class="linenr">19:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">failure</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    <span style="color: #8b6508;">....</span>
<span class="linenr">21:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36824;&#26410;&#35745;&#31639;&#21021;&#22987;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">22:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#21452;&#26041;&#22320;&#22336;&#12289;&#31471;&#21475;&#35745;&#31639;&#21021;&#22987;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">23:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">secure_tcp_sequence_number</span><span style="color: #cd2626;">(</span>inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">saddr</span><span style="color: #8b6508;">,</span>
<span class="linenr">24:  </span>                               inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">daddr</span><span style="color: #8b6508;">,</span>
<span class="linenr">25:  </span>                               inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sport</span><span style="color: #8b6508;">,</span>
<span class="linenr">26:  </span>                               usin<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sin_port</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>
<span class="linenr">28:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#21021;&#22987;&#24207;&#21495;&#21644;&#24403;&#21069;&#26102;&#38388;&#65292;&#38543;&#26426;&#31639;&#19968;&#20010;&#21021;&#22987;id </span><span style="color: #b22222;">*/</span>
<span class="linenr">29:  </span>    inet<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">id</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span> <span style="color: #8b6508;">^</span> jiffies<span style="color: #8b6508;">;</span>
<span class="linenr">30:  </span>
<span class="linenr">31:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">32:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">33:  </span>    rt <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">34:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span>
<span class="linenr">35:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">failure</span><span style="color: #8b6508;">;</span>
<span class="linenr">36:  </span>
<span class="linenr">37:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">38:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p><br/>
</p></div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> sys_accept()</h2>
<div class="outline-text-2" id="text-3">

<ul>
<li>描述: 调用tcp_accept(), 并把它返回的newsk进行连接描述符分配后返回给用户空间。<br/>
</li>
<li>返回值: 连接描述符<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span>asmlinkage <span style="color: #228b22;">long</span> <span style="color: #0000ff; font-size: 120%;">sys_accept</span><span style="color: #cd2626;">(</span><span style="color: #228b22;">int</span> <span style="color: #a0522d;">fd</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">upeer_sockaddr</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*</span>upeer_addrlen<span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">socket</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sock</span><span style="color: #8b6508;">,</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">newsock</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>    <span style="color: #8b6508;">.....</span>     
<span class="linenr"> 5:  </span>    sock <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sockfd_lookup</span><span style="color: #cd2626;">(</span>fd<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>err<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#24471;&#20390;&#21548;&#31471;&#21475;&#30340;socket </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>    <span style="color: #8b6508;">.....</span>    
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>newsock <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_alloc</span><span style="color: #cd2626;">()))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#19968;&#20010;&#26032;&#30340;&#22871;&#25509;&#21475;&#65292;&#29992;&#26469;&#22788;&#29702;&#19982;&#23458;&#25143;&#31471;&#30340;&#36830;&#25509; </span><span style="color: #b22222;">*/</span> 
<span class="linenr"> 8:  </span>    <span style="color: #8b6508;">.....</span>     
<span class="linenr"> 9:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35843;&#29992;&#20256;&#36755;&#23618;&#30340;accept&#65292;&#23545;TCP&#26469;&#35828;&#65292;&#26159;inet_accept </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>    err <span style="color: #8b6508;">=</span> sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> newsock<span style="color: #8b6508;">,</span> sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">f_flags</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">11:  </span>    <span style="color: #8b6508;">....</span>    
<span class="linenr">12:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>upeer_sockaddr<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35843;&#29992;&#32773;&#38656;&#35201;&#33719;&#21462;&#23545;&#26041;&#22871;&#25509;&#21475;&#22320;&#22336;&#21644;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr">13:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35843;&#29992;&#20256;&#36755;&#23618;&#22238;&#35843;&#33719;&#24471;&#23545;&#26041;&#30340;&#22320;&#22336;&#21644;&#31471;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr">14:  </span>        <span style="color: #a020f0;">if</span><span style="color: #cd2626;">(</span>newsock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">getname</span><span style="color: #cd2626;">(</span>newsock<span style="color: #8b6508;">,</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>address<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>len<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">2</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&lt;</span><span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">15:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">16:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#22797;&#21046;&#21040;&#29992;&#25143;&#24577; </span><span style="color: #b22222;">*/</span>
<span class="linenr">17:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">move_addr_to_user</span><span style="color: #cd2626;">(</span>address<span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span> upeer_sockaddr<span style="color: #8b6508;">,</span> upeer_addrlen<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">19:  </span>    <span style="color: #8b6508;">.....</span>     
<span class="linenr">20:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_map_fd</span><span style="color: #cd2626;">(</span>newsock<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">&lt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20026;&#26032;&#36830;&#25509;&#20998;&#37197;&#25991;&#20214;&#25551;&#36848;&#31526; </span><span style="color: #b22222;">*/</span>
<span class="linenr">21:  </span>
<span class="linenr">22:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p>  <br/>
</p>
</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> tcp_accept()</h3>
<div class="outline-text-3" id="text-3-1">

<p>  <b>[注]</b>: 在内核2.6.32以后对应函数为inet_csk_accept().<br/>
</p><ul>
<li>描述: 通过在规定时间内，判断tcp_sock-&gt;accept_queue队列非空，代表有新的连接进入．<br/>
</li>
<li>返回值: (struct sock *)newsk;<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #0000ff; font-size: 120%;">tcp_accept</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flags</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">err</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #8b6508;">....</span>
<span class="linenr"> 4:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Find already established connection </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">accept&#38431;&#21015;&#20026;&#31354;&#65292;&#35828;&#26126;&#36824;&#27809;&#26377;&#25910;&#21040;&#26032;&#36830;&#25509; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>        <span style="color: #228b22;">long</span> <span style="color: #a0522d;">timeo</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_rcvtimeo</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flags <span style="color: #8b6508;">&amp;</span> O_NONBLOCK<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22871;&#21475;&#26159;&#38750;&#38459;&#22622;&#30340;&#65292;&#25110;&#32773;&#22312;&#19968;&#23450;&#26102;&#38388;&#20869;&#27809;&#26377;&#26032;&#36830;&#25509;&#65292;&#21017;&#36820;&#22238; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!timeo<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36229;&#26102;&#26102;&#38388;&#21040;&#65292;&#27809;&#26377;&#26032;&#36830;&#25509;&#65292;&#36864;&#20986; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>
<span class="linenr">11:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36816;&#34892;&#21040;&#36825;&#37324;&#65292;&#35828;&#26126;&#26377;&#26032;&#36830;&#25509;&#21040;&#26469;&#65292;&#21017;&#31561;&#24453;&#26032;&#30340;&#20256;&#36755;&#25511;&#21046;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr">12:  </span>        error <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">wait_for_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> timeo<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>error<span style="color: #cd2626;">)</span>
<span class="linenr">14:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">16:  </span>
<span class="linenr">17:  </span>    req <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue</span> <span style="color: #8b6508;">=</span> req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">dl_next</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">)</span>
<span class="linenr">19:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">accept_queue_tail</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>
<span class="linenr">21:  </span>    newsk <span style="color: #8b6508;">=</span> req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">;</span>
<span class="linenr">22:  </span>    <span style="color: #008000; font-weight: bold;">sk_acceptq_removed</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>    <span style="color: #008000; font-weight: bold;">tcp_openreq_fastfree</span><span style="color: #cd2626;">(</span>req<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">24:  </span>    <span style="color: #8b6508;">....</span>
<span class="linenr">25:  </span>
<span class="linenr">26:  </span>    <span style="color: #a020f0;">return</span> newsk<span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 三次握手</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> 客户端发送SYN段</h3>
<div class="outline-text-3" id="text-4-1">

<ul>
<li>由tcp_v4_connect()-&gt;tcp_connect()-&gt;tcp_transmit_skb()发送，并置为TCP_SYN_SENT.<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26500;&#36896;&#24182;&#21457;&#36865;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 2:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_connect</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 3:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">buff</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span>    <span style="color: #008000; font-weight: bold;">tcp_connect_init</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#20256;&#36755;&#25511;&#21046;&#22359;&#20013;&#19982;&#36830;&#25509;&#30456;&#20851;&#30340;&#25104;&#21592; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 8:  </span>
<span class="linenr"> 9:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20026;SYN&#27573;&#20998;&#37197;&#25253;&#25991;&#24182;&#36827;&#34892;&#21021;&#22987;&#21270; </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>    buff <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">alloc_skb</span><span style="color: #cd2626;">(</span>MAX_TCP_HEADER <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">15</span><span style="color: #8b6508;">,</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_allocation</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">11:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">unlikely</span><span style="color: #cd2626;">(</span>buff <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">))</span>
<span class="linenr">12:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span>ENOBUFS<span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>
<span class="linenr">14:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Reserve space for headers. </span><span style="color: #b22222;">*/</span>
<span class="linenr">15:  </span>    <span style="color: #008000; font-weight: bold;">skb_reserve</span><span style="color: #cd2626;">(</span>buff<span style="color: #8b6508;">,</span> MAX_TCP_HEADER<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>
<span class="linenr">17:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span> <span style="color: #8b6508;">=</span> TCPCB_FLAG_SYN<span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>    <span style="color: #008000; font-weight: bold;">TCP_ECN_send_syn</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">19:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tso_segs</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>    <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tso_size</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">22:  </span>    buff<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">csum</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">++;</span>
<span class="linenr">24:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">25:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">26:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pushed_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>    <span style="color: #008000; font-weight: bold;">tcp_ca_init</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>
<span class="linenr">29:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Send it off. </span><span style="color: #b22222;">*/</span>
<span class="linenr">30:  </span>    <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">when</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_stamp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">when</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>
<span class="linenr">33:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23558;&#25253;&#25991;&#28155;&#21152;&#21040;&#21457;&#36865;&#38431;&#21015;&#19978; </span><span style="color: #b22222;">*/</span>
<span class="linenr">34:  </span>    <span style="color: #008000; font-weight: bold;">__skb_queue_tail</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_write_queue</span><span style="color: #8b6508;">,</span> buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">35:  </span>    <span style="color: #008000; font-weight: bold;">sk_charge_skb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">36:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span> <span style="color: #8b6508;">+=</span> <span style="color: #008000; font-weight: bold;">tcp_skb_pcount</span><span style="color: #cd2626;">(</span>buff<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">37:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">38:  </span>    <span style="color: #008000; font-weight: bold;">tcp_transmit_skb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">skb_clone</span><span style="color: #cd2626;">(</span>buff<span style="color: #8b6508;">,</span> GFP_KERNEL<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">39:  </span>    <span style="color: #008000; font-weight: bold;">TCP_INC_STATS</span><span style="color: #cd2626;">(</span>TCP_MIB_ACTIVEOPENS<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">40:  </span>
<span class="linenr">41:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Timer for repeating the SYN until an answer. </span><span style="color: #b22222;">*/</span>
<span class="linenr">42:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21551;&#21160;&#37325;&#20256;&#23450;&#26102;&#22120; </span><span style="color: #b22222;">*/</span>
<span class="linenr">43:  </span>    <span style="color: #008000; font-weight: bold;">tcp_reset_xmit_timer</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_TIME_RETRANS<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rto</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">44:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">45:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">46:  </span>
</pre>

    </div>
</li>
</ul>


<p>     <br/>
</p></div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> 服务端接收到SYN段后，发送SYN/ACK处理</h3>
<div class="outline-text-3" id="text-4-2">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_state_process()-&gt;tcp_v4_conn_request()-&gt;tcp_v4_send_synack().<br/>
</li>
<li>tcp_v4_send_synack()<br/>
<ul>
<li>tcp_make_synack(sk, dst, req); <i>* 根据路由、传输控制块、连接请求块中的构建SYN+ACK段 *</i><br/>
</li>
<li>ip_build_and_send_pkt(); <i>* 生成IP数据报并发送出去 *</i><br/>

<p><br/>
</p>
<p><br/>
	</p>
<div class="figure">
<p><img src="tcp_synack.png"  alt="tcp_synack.png" /></p>
<p>图: 服务端接收到SYN段后，发送SYN/ACK处理流程。</p>
</div>
<p><br/>
</p>
<p><br/>
</p></li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21521;&#23458;&#25143;&#31471;&#21457;&#36865;SYN+ACK&#25253;&#25991; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 2:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_v4_send_synack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">open_request</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">req</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 3:  </span>                  <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">dst_entry</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">dst</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span> <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span> <span style="color: #a0522d;">skb</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">First, grab a route. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26597;&#25214;&#21040;&#23458;&#25143;&#31471;&#30340;&#36335;&#30001; </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!dst <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #cd2626;">(</span>dst <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_v4_route_req</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> req<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">)</span>
<span class="linenr">11:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>
<span class="linenr">13:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#36335;&#30001;&#12289;&#20256;&#36755;&#25511;&#21046;&#22359;&#12289;&#36830;&#25509;&#35831;&#27714;&#22359;&#20013;&#30340;&#26500;&#24314;SYN+ACK&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">14:  </span>    skb <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_make_synack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> dst<span style="color: #8b6508;">,</span> req<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>
<span class="linenr">16:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29983;&#25104;SYN+ACK&#27573;&#25104;&#21151; </span><span style="color: #b22222;">*/</span>
<span class="linenr">17:  </span>        <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">th</span> <span style="color: #8b6508;">=</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">h</span><span style="color: #8b6508;">.</span><span style="color: #008000;">th</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>
<span class="linenr">19:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29983;&#25104;&#26657;&#39564;&#30721; </span><span style="color: #b22222;">*/</span>
<span class="linenr">20:  </span>        th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">check</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_v4_check</span><span style="color: #cd2626;">(</span>th<span style="color: #8b6508;">,</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #8b6508;">,</span>
<span class="linenr">21:  </span>                     req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">loc_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">22:  </span>                     req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rmt_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">23:  </span>                     <span style="color: #008000; font-weight: bold;">csum_partial</span><span style="color: #cd2626;">((</span><span style="color: #228b22;">char</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>th<span style="color: #8b6508;">,</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #8b6508;">,</span>
<span class="linenr">24:  </span>                              skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">csum</span><span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">25:  </span>
<span class="linenr">26:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29983;&#25104;IP&#25968;&#25454;&#25253;&#24182;&#21457;&#36865;&#20986;&#21435; </span><span style="color: #b22222;">*/</span>
<span class="linenr">27:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ip_build_and_send_pkt</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> sk<span style="color: #8b6508;">,</span> req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">loc_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">28:  </span>                        req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rmt_addr</span><span style="color: #8b6508;">,</span>
<span class="linenr">29:  </span>                        req<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af</span><span style="color: #8b6508;">.</span><span style="color: #008000;">v4_req</span><span style="color: #8b6508;">.</span><span style="color: #008000;">opt</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">30:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err <span style="color: #8b6508;">==</span> NET_XMIT_CN<span style="color: #cd2626;">)</span>
<span class="linenr">31:  </span>            err <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">33:  </span>
<span class="linenr">34:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">35:  </span>    <span style="color: #008000; font-weight: bold;">dst_release</span><span style="color: #cd2626;">(</span>dst<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">36:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">37:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">38:  </span>
</pre>

    </div>
</li>
</ul>


<p>       <br/>
</p></div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> 客户端回复确认ACK段</h3>
<div class="outline-text-3" id="text-4-3">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_state_process().当前客户端处于TCP_SYN_SENT状态。<br/>
</li>
<li>tcp_rcv_synsent_state_process(); <i>* tcp_rcv_synsent_state_process处理SYN_SENT状态下接收到的TCP段 *</i><br/>
<ul>
<li>tcp_ack(); <i>* 处理接收到的ack报文 *</i><br/>
</li>
<li>tcp_send_ack(); <i>* 在主动连接时，向服务器端发送ACK完成连接，并更新窗口 *</i><br/>
<ul>
<li>alloc_skb(); <i>* 构造ack段 *</i><br/>
</li>
<li>tcp_transmit_skb(); <i>* 将ack段发出 *</i><br/>
</li>
</ul>

</li>
<li>tcp_urg(sk, skb, th); <i>* 处理完第二次握手后，还需要处理带外数据 *</i><br/>
</li>
<li>tcp_data_snd_check(sk); <i>* 检测是否有数据需要发送 *</i><br/>
<ul>
<li>检查sk-&gt;sk_send_head队列上是否有待发送的数据。<br/>
</li>
<li>tcp_write_xmit(); <i>* 将TCP发送队列上的段发送出去 *</i><br/>
</li>
</ul>

</li>
</ul>

</li>
<li>代码关键路径:<br/>
</li>
</ul>


</div>

<div id="outline-container-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> tcp_rcv_synsent_state_process()</h4>
<div class="outline-text-4" id="text-4-3-1">


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;SYN_SENT&#29366;&#24577;&#19979;&#22788;&#29702;&#25509;&#25910;&#21040;&#30340;&#27573;&#65292;&#20294;&#26159;&#19981;&#22788;&#29702;&#24102;&#22806;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">  2:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_rcv_synsent_state_process</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>                   <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">th</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">unsigned</span> <span style="color: #a0522d;">len</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>  <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">  6:  </span>  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">saved_clamp</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span><span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>
<span class="linenr">  8:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35299;&#26512;TCP&#36873;&#39033;&#24182;&#20445;&#23384;&#21040;&#20256;&#36755;&#25511;&#21046;&#22359;&#20013; </span><span style="color: #b22222;">*/</span>
<span class="linenr">  9:  </span>  <span style="color: #008000; font-weight: bold;">tcp_parse_options</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 10:  </span>
<span class="linenr"> 11:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;ACK&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 12:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr"> 13:  </span><span style="color: #b22222;">       * "If the state is SYN-SENT then</span>
<span class="linenr"> 14:  </span><span style="color: #b22222;">       *    first check the ACK bit</span>
<span class="linenr"> 15:  </span><span style="color: #b22222;">       *      If the ACK bit is set</span>
<span class="linenr"> 16:  </span><span style="color: #b22222;">       *    If SEG.ACK =&lt; ISS, or SEG.ACK &gt; SND.NXT, send</span>
<span class="linenr"> 17:  </span><span style="color: #b22222;">       *        a reset (unless the RST bit is set, if so drop</span>
<span class="linenr"> 18:  </span><span style="color: #b22222;">       *        the segment and return)"</span>
<span class="linenr"> 19:  </span><span style="color: #b22222;">       *</span>
<span class="linenr"> 20:  </span><span style="color: #b22222;">       *  We do not send data with SYN, so that RFC-correct</span>
<span class="linenr"> 21:  </span><span style="color: #b22222;">       *  test reduces to:</span>
<span class="linenr"> 22:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 23:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span> <span style="color: #8b6508;">!=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 24:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">reset_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 25:  </span>
<span class="linenr"> 26:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_tsecr</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 27:  </span>          !<span style="color: #008000; font-weight: bold;">between</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_tsecr</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_stamp</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 28:  </span>               tcp_time_stamp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 29:  </span>          <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span>LINUX_MIB_PAWSACTIVEREJECTED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 30:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">reset_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 31:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 32:  </span>
<span class="linenr"> 33:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Now ACK is acceptable.</span>
<span class="linenr"> 34:  </span><span style="color: #b22222;">       *</span>
<span class="linenr"> 35:  </span><span style="color: #b22222;">       * "If the RST bit is set</span>
<span class="linenr"> 36:  </span><span style="color: #b22222;">       *    If the ACK was acceptable then signal the user "error:</span>
<span class="linenr"> 37:  </span><span style="color: #b22222;">       *    connection reset", drop the segment, enter CLOSED state,</span>
<span class="linenr"> 38:  </span><span style="color: #b22222;">       *    delete TCB, and return."</span>
<span class="linenr"> 39:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 40:  </span>
<span class="linenr"> 41:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25910;&#21040;ACK+RST&#27573;&#65292;&#38656;&#35201;tcp_reset&#35774;&#32622;&#38169;&#35823;&#30721;&#65292;&#24182;&#20851;&#38381;&#22871;&#25509;&#21475; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 42:  </span>          <span style="color: #008000; font-weight: bold;">tcp_reset</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 43:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 44:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 45:  </span>
<span class="linenr"> 46:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr"> 47:  </span><span style="color: #b22222;">       *   "fifth, if neither of the SYN or RST bits is set then</span>
<span class="linenr"> 48:  </span><span style="color: #b22222;">       *    drop the segment and return."</span>
<span class="linenr"> 49:  </span><span style="color: #b22222;">       *</span>
<span class="linenr"> 50:  </span><span style="color: #b22222;">       *    See note below!</span>
<span class="linenr"> 51:  </span><span style="color: #b22222;">       *                                        --ANK(990513)</span>
<span class="linenr"> 52:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 53:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">syn</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;SYN_SENT&#29366;&#24577;&#19979;&#25509;&#25910;&#21040;&#30340;&#27573;&#24517;&#39035;&#23384;&#22312;SYN&#26631;&#24535;&#65292;&#21542;&#21017;&#35828;&#26126;&#25509;&#25910;&#21040;&#30340;&#27573;&#26080;&#25928;&#65292;&#20002;&#24323;&#35813;&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 54:  </span>          <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 55:  </span>
<span class="linenr"> 56:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr"> 57:  </span><span style="color: #b22222;">       *   "If the SYN bit is on ...</span>
<span class="linenr"> 58:  </span><span style="color: #b22222;">       *    are acceptable then ...</span>
<span class="linenr"> 59:  </span><span style="color: #b22222;">       *    (our SYN has been ACKed), change the connection</span>
<span class="linenr"> 60:  </span><span style="color: #b22222;">       *    state to ESTABLISHED..."</span>
<span class="linenr"> 61:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 62:  </span>
<span class="linenr"> 63:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#39318;&#37096;&#26631;&#24535;&#20013;&#33719;&#21462;&#26174;&#31034;&#25317;&#22622;&#36890;&#30693;&#30340;&#29305;&#24615; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 64:  </span>      <span style="color: #008000; font-weight: bold;">TCP_ECN_rcv_synack</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> th<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 65:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ecn_flags</span><span style="color: #8b6508;">&amp;</span>TCP_ECN_OK<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#25903;&#25345;ECN&#65292;&#21017;&#35774;&#32622;&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 66:  </span>          sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_no_largesend</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 67:  </span>
<span class="linenr"> 68:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#19982;&#31383;&#21475;&#30456;&#20851;&#30340;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 69:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wl1</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 70:  </span>      <span style="color: #008000; font-weight: bold;">tcp_ack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> FLAG_SLOWPATH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 71:  </span>
<span class="linenr"> 72:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Ok.. it's good. Set up sequence numbers and</span>
<span class="linenr"> 73:  </span><span style="color: #b22222;">       * move to established.</span>
<span class="linenr"> 74:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 75:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 76:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_wup</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 77:  </span>
<span class="linenr"> 78:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">RFC1323: The window in SYN &amp; SYN/ACK segments is</span>
<span class="linenr"> 79:  </span><span style="color: #b22222;">       * never scaled.</span>
<span class="linenr"> 80:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 81:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ntohs</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 82:  </span>      <span style="color: #008000; font-weight: bold;">tcp_init_wl</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span><span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 83:  </span>
<span class="linenr"> 84:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">wscale_ok</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 85:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">snd_wscale</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_wscale</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 86:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window_clamp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">min</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window_clamp</span><span style="color: #8b6508;">,</span> 65535U<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 87:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 88:  </span>
<span class="linenr"> 89:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#26159;&#21542;&#25903;&#25345;&#26102;&#38388;&#25139;&#36873;&#39033;&#26469;&#35774;&#32622;&#20256;&#36755;&#25511;&#21046;&#22359;&#30340;&#30456;&#20851;&#23383;&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 90:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">tstamp_ok</span>       <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 91:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span>
<span class="linenr"> 92:  </span>              <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr"> 93:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">advmss</span>      <span style="color: #8b6508;">-=</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr"> 94:  </span>          <span style="color: #008000; font-weight: bold;">tcp_store_ts_recent</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 95:  </span>      <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 96:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 97:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr"> 98:  </span>
<span class="linenr"> 99:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;PMTU&#12289;MSS&#31561;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr">100:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">sack_ok</span> <span style="color: #8b6508;">&amp;&amp;</span> sysctl_tcp_fack<span style="color: #cd2626;">)</span>
<span class="linenr">101:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">sack_ok</span> <span style="color: #8b6508;">|=</span> <span style="color: #ff0000;">2</span><span style="color: #8b6508;">;</span>
<span class="linenr">102:  </span>
<span class="linenr">103:  </span>      <span style="color: #008000; font-weight: bold;">tcp_sync_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pmtu_cookie</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">104:  </span>      <span style="color: #008000; font-weight: bold;">tcp_initialize_rcv_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">105:  </span>
<span class="linenr">106:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Remember, tcp_poll() does not lock socket!</span>
<span class="linenr">107:  </span><span style="color: #b22222;">       * Change state from SYN-SENT only after copied_seq</span>
<span class="linenr">108:  </span><span style="color: #b22222;">       * is initialized. </span><span style="color: #b22222;">*/</span>
<span class="linenr">109:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">copied_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span><span style="color: #8b6508;">;</span>
<span class="linenr">110:  </span>      <span style="color: #008000; font-weight: bold;">mb</span><span style="color: #cd2626;">()</span><span style="color: #8b6508;">;</span>
<span class="linenr">111:  </span>      <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_ESTABLISHED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">112:  </span>
<span class="linenr">113:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Make sure socket is routed, for correct metrics.  </span><span style="color: #b22222;">*/</span>
<span class="linenr">114:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af_specific</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rebuild_header</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">115:  </span>
<span class="linenr">116:  </span>      <span style="color: #008000; font-weight: bold;">tcp_init_metrics</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">117:  </span>
<span class="linenr">118:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Prevent spurious tcp_cwnd_restart() on first data</span>
<span class="linenr">119:  </span><span style="color: #b22222;">       * packet.</span>
<span class="linenr">120:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">121:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lsndtime</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">122:  </span>
<span class="linenr">123:  </span>      <span style="color: #008000; font-weight: bold;">tcp_init_buffer_space</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">124:  </span>
<span class="linenr">125:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#21551;&#29992;&#20102;&#36830;&#25509;&#20445;&#27963;&#65292;&#21017;&#21551;&#29992;&#36830;&#25509;&#20445;&#27963;&#23450;&#26102;&#22120; </span><span style="color: #b22222;">*/</span>
<span class="linenr">126:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_flag</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> SOCK_KEEPOPEN<span style="color: #cd2626;">))</span>
<span class="linenr">127:  </span>          <span style="color: #008000; font-weight: bold;">tcp_reset_keepalive_timer</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">keepalive_time_when</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">128:  </span>
<span class="linenr">129:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">snd_wscale</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#39318;&#37096;&#39044;&#27979; </span><span style="color: #b22222;">*/</span>
<span class="linenr">130:  </span>          <span style="color: #008000; font-weight: bold;">__tcp_fast_path_on</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">131:  </span>      <span style="color: #a020f0;">else</span>
<span class="linenr">132:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pred_flags</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">133:  </span>
<span class="linenr">134:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">sock_flag</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> SOCK_DEAD<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22871;&#21475;&#19981;&#22788;&#20110;SOCK_DEAD&#29366;&#24577;&#65292;&#21017;&#21796;&#37266;&#31561;&#24453;&#35813;&#22871;&#25509;&#21475;&#30340;&#36827;&#31243; </span><span style="color: #b22222;">*/</span>
<span class="linenr">135:  </span>          sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state_change</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">136:  </span>          <span style="color: #008000; font-weight: bold;">sk_wake_async</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">,</span> POLL_OUT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">137:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr">138:  </span>
<span class="linenr">139:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36830;&#25509;&#24314;&#31435;&#23436;&#25104;&#65292;&#26681;&#25454;&#24773;&#20917;&#36827;&#20837;&#24310;&#26102;&#30830;&#35748;&#27169;&#24335; </span><span style="color: #b22222;">*/</span>
<span class="linenr">140:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_write_pending</span> <span style="color: #8b6508;">||</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">defer_accept</span> <span style="color: #8b6508;">||</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">pingpong</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">141:  </span>          <span style="color: #b22222;">/* </span><span style="color: #b22222;">Save one ACK. Data will be ready after</span>
<span class="linenr">142:  </span><span style="color: #b22222;">           * several ticks, if write_pending is set.</span>
<span class="linenr">143:  </span><span style="color: #b22222;">           *</span>
<span class="linenr">144:  </span><span style="color: #b22222;">           * It may be deleted, but with this feature tcpdumps</span>
<span class="linenr">145:  </span><span style="color: #b22222;">           * look so _wonderfully_ clever, that I was not able</span>
<span class="linenr">146:  </span><span style="color: #b22222;">           * to stand against the temptation 8)     --ANK</span>
<span class="linenr">147:  </span><span style="color: #b22222;">           </span><span style="color: #b22222;">*/</span>
<span class="linenr">148:  </span>          <span style="color: #008000; font-weight: bold;">tcp_schedule_ack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">149:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">lrcvtime</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">150:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">ato</span>  <span style="color: #8b6508;">=</span> TCP_ATO_MIN<span style="color: #8b6508;">;</span>
<span class="linenr">151:  </span>          <span style="color: #008000; font-weight: bold;">tcp_incr_quickack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">152:  </span>          <span style="color: #008000; font-weight: bold;">tcp_enter_quickack_mode</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">153:  </span>          <span style="color: #008000; font-weight: bold;">tcp_reset_xmit_timer</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_TIME_DACK<span style="color: #8b6508;">,</span> TCP_DELACK_MAX<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">154:  </span>
<span class="linenr">155:  </span><span style="color: #008b8b;">discard</span><span style="color: #8b6508;">:</span>
<span class="linenr">156:  </span>          <span style="color: #008000; font-weight: bold;">__kfree_skb</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">157:  </span>          <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">158:  </span>      <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#19981;&#38656;&#35201;&#24310;&#26102;&#30830;&#35748;&#65292;&#31435;&#21363;&#21457;&#36865;ACK&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">159:  </span>          <span style="color: #008000; font-weight: bold;">tcp_send_ack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">160:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr">161:  </span>      <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">162:  </span>  <span style="color: #cd2626;">}</span>
<span class="linenr">163:  </span>
<span class="linenr">164:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">No ACK in the segment </span><span style="color: #b22222;">*/</span>
<span class="linenr">165:  </span>
<span class="linenr">166:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25910;&#21040;RST&#27573;&#65292;&#21017;&#20002;&#24323;&#20256;&#36755;&#25511;&#21046;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr">167:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">rfc793:</span>
<span class="linenr">168:  </span><span style="color: #b22222;">       * "If the RST bit is set</span>
<span class="linenr">169:  </span><span style="color: #b22222;">       *</span>
<span class="linenr">170:  </span><span style="color: #b22222;">       *      Otherwise (no ACK) drop the segment and return."</span>
<span class="linenr">171:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">172:  </span>
<span class="linenr">173:  </span>      <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr">174:  </span>  <span style="color: #cd2626;">}</span>
<span class="linenr">175:  </span>
<span class="linenr">176:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">PAWS check. </span><span style="color: #b22222;">*/</span>
<span class="linenr">177:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">PAWS&#26816;&#27979;&#22833;&#25928;&#65292;&#20063;&#20002;&#24323;&#20256;&#36755;&#25511;&#21046;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr">178:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">ts_recent_stamp</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">tcp_paws_check</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">))</span>
<span class="linenr">179:  </span>      <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">;</span>
<span class="linenr">180:  </span>
<span class="linenr">181:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;SYN_SENT&#29366;&#24577;&#19979;&#25910;&#21040;&#20102;SYN&#27573;&#24182;&#19988;&#27809;&#26377;ACK&#65292;&#35828;&#26126;&#26159;&#20004;&#31471;&#21516;&#26102;&#25171;&#24320; </span><span style="color: #b22222;">*/</span>
<span class="linenr">182:  </span>  <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">syn</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">183:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">We see SYN without ACK. It is attempt of</span>
<span class="linenr">184:  </span><span style="color: #b22222;">       * simultaneous connect with crossed SYNs.</span>
<span class="linenr">185:  </span><span style="color: #b22222;">       * Particularly, it can be connect to self.</span>
<span class="linenr">186:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">187:  </span>      <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_SYN_RECV<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#29366;&#24577;&#20026;TCP_SYN_RECV </span><span style="color: #b22222;">*/</span>
<span class="linenr">188:  </span>
<span class="linenr">189:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#26102;&#38388;&#25139;&#30456;&#20851;&#30340;&#23383;&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">190:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">tstamp_ok</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">191:  </span>          <span style="color: #008000; font-weight: bold;">tcp_store_ts_recent</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">192:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span>
<span class="linenr">193:  </span>              <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr">194:  </span>      <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">195:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tcp_header_len</span> <span style="color: #8b6508;">=</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">196:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr">197:  </span>
<span class="linenr">198:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#31383;&#21475;&#30456;&#20851;&#30340;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr">199:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">200:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_wup</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">201:  </span>
<span class="linenr">202:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">RFC1323: The window in SYN &amp; SYN/ACK segments is</span>
<span class="linenr">203:  </span><span style="color: #b22222;">       * never scaled.</span>
<span class="linenr">204:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">205:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span>    <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ntohs</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">206:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wl1</span>    <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">;</span>
<span class="linenr">207:  </span>      tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">max_window</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span><span style="color: #8b6508;">;</span>
<span class="linenr">208:  </span>
<span class="linenr">209:  </span>      <span style="color: #008000; font-weight: bold;">TCP_ECN_rcv_syn</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> th<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#39318;&#37096;&#26631;&#24535;&#20013;&#33719;&#21462;&#26174;&#24335;&#25317;&#22622;&#36890;&#30693;&#30340;&#29305;&#24615;&#12290; </span><span style="color: #b22222;">*/</span>
<span class="linenr">210:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ecn_flags</span><span style="color: #8b6508;">&amp;</span>TCP_ECN_OK<span style="color: #cd2626;">)</span>
<span class="linenr">211:  </span>          sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_no_largesend</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">212:  </span>
<span class="linenr">213:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;MSS&#30456;&#20851;&#30340;&#25104;&#21592;&#21464;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr">214:  </span>      <span style="color: #008000; font-weight: bold;">tcp_sync_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">pmtu_cookie</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">215:  </span>      <span style="color: #008000; font-weight: bold;">tcp_initialize_rcv_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">216:  </span>
<span class="linenr">217:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21521;&#23545;&#31471;&#21457;&#36865;SYN+ACK&#27573;&#65292;&#24182;&#20002;&#24323;&#25509;&#25910;&#21040;&#30340;SYN&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr">218:  </span>      <span style="color: #008000; font-weight: bold;">tcp_send_synack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">219:  </span><span style="color: #483d8b;">#if</span> <span style="color: #ff0000;">0</span>
<span class="linenr">220:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">Note, we could accept data and URG from this segment.</span>
<span class="linenr">221:  </span><span style="color: #b22222;">       * There are no obstacles to make this.</span>
<span class="linenr">222:  </span><span style="color: #b22222;">       *</span>
<span class="linenr">223:  </span><span style="color: #b22222;">       * However, if we ignore data in ACKless segments sometimes,</span>
<span class="linenr">224:  </span><span style="color: #b22222;">       * we have no reasons to accept it sometimes.</span>
<span class="linenr">225:  </span><span style="color: #b22222;">       * Also, seems the code doing it in step6 of tcp_rcv_state_process</span>
<span class="linenr">226:  </span><span style="color: #b22222;">       * is not flawless. So, discard packet for sanity.</span>
<span class="linenr">227:  </span><span style="color: #b22222;">       * Uncomment this return to process the data.</span>
<span class="linenr">228:  </span><span style="color: #b22222;">       </span><span style="color: #b22222;">*/</span>
<span class="linenr">229:  </span>      <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">230:  </span><span style="color: #483d8b;">#else</span>
<span class="linenr">231:  </span>      <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr">232:  </span><span style="color: #483d8b;">#endif</span>
<span class="linenr">233:  </span>  <span style="color: #cd2626;">}</span>
<span class="linenr">234:  </span>  <span style="color: #b22222;">/* </span><span style="color: #b22222;">"fifth, if neither of the SYN or RST bits is set then</span>
<span class="linenr">235:  </span><span style="color: #b22222;">   * drop the segment and return."</span>
<span class="linenr">236:  </span><span style="color: #b22222;">   </span><span style="color: #b22222;">*/</span>
<span class="linenr">237:  </span>
<span class="linenr">238:  </span><span style="color: #008b8b;">discard_and_undo</span><span style="color: #8b6508;">:</span>
<span class="linenr">239:  </span>  <span style="color: #008000; font-weight: bold;">tcp_clear_options</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">240:  </span>  tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span> <span style="color: #8b6508;">=</span> saved_clamp<span style="color: #8b6508;">;</span>
<span class="linenr">241:  </span>  <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr">242:  </span>
<span class="linenr">243:  </span><span style="color: #008b8b;">reset_and_undo</span><span style="color: #8b6508;">:</span>
<span class="linenr">244:  </span>  <span style="color: #008000; font-weight: bold;">tcp_clear_options</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">245:  </span>  tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">mss_clamp</span> <span style="color: #8b6508;">=</span> saved_clamp<span style="color: #8b6508;">;</span>
<span class="linenr">246:  </span>  <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">247:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">248:  </span>
</pre>

    </div>

<p>         <br/>
</p></div>
</div>

</div>

<div id="outline-container-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> 服务端收到ACK段</h3>
<div class="outline-text-3" id="text-4-4">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_state_process().当前服务端处于TCP_SYN_RECV状态变为TCP_ESTABLISHED状态。<br/>
</li>
<li>代码关键路径:<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38500;&#20102;ESTABLISHED&#21644;TIME_WAIT&#29366;&#24577;&#22806;&#65292;&#20854;&#20182;&#29366;&#24577;&#19979;&#30340;TCP&#27573;&#22788;&#29702;&#37117;&#30001;&#26412;&#20989;&#25968;&#23454;&#29616; </span><span style="color: #b22222;">*/</span> 
<span class="linenr">  2:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_rcv_state_process</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>              <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcphdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">th</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">unsigned</span> <span style="color: #a0522d;">len</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">  6:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">queued</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>
<span class="linenr">  8:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">  9:  </span>
<span class="linenr"> 10:  </span>    <span style="color: #a020f0;">switch</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 11:  </span>    <span style="color: #8b6508;">.....</span>
<span class="linenr"> 12:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">SYN_RECV&#29366;&#24577;&#30340;&#22788;&#29702; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 13:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_fast_parse_options</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> th<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35299;&#26512;TCP&#36873;&#39033;&#65292;&#22914;&#26524;&#39318;&#37096;&#20013;&#23384;&#22312;&#26102;&#38388;&#25139;&#36873;&#39033; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 14:  </span>        <span style="color: #008000; font-weight: bold;">tcp_paws_discard</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">PAWS&#26816;&#27979;&#22833;&#36133;&#65292;&#21017;&#20002;&#24323;&#25253;&#25991; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 15:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#26159;RST&#27573; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 16:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;DACK&#32473;&#23545;&#31471;&#65292;&#35828;&#26126;&#25509;&#25910;&#21040;&#30340;TCP&#27573;&#24050;&#32463;&#22788;&#29702;&#36807; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 17:  </span>            <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span>LINUX_MIB_PAWSESTABREJECTED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 18:  </span>            <span style="color: #008000; font-weight: bold;">tcp_send_dupack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 19:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 20:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr"> 21:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">Reset is accepted even if it did not pass PAWS. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 22:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 23:  </span>
<span class="linenr"> 24:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 1: check sequence number </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 25:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">tcp_sequence</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">TCP&#27573;&#24207;&#21495;&#26080;&#25928; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 26:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;TCP&#27573;&#26080;RST&#26631;&#24535;&#65292;&#21017;&#21457;&#36865;DACK&#32473;&#23545;&#26041; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 27:  </span>            <span style="color: #008000; font-weight: bold;">tcp_send_dupack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 28:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 29:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 30:  </span>
<span class="linenr"> 31:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 2: check RST bit </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 32:  </span>    <span style="color: #a020f0;">if</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rst</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;RST&#26631;&#24535;&#65292;&#21017;&#37325;&#32622;&#36830;&#25509; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 33:  </span>        <span style="color: #008000; font-weight: bold;">tcp_reset</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 34:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 35:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 36:  </span>
<span class="linenr"> 37:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;&#24517;&#35201;&#65292;&#21017;&#26356;&#26032;&#26102;&#38388;&#25139; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 38:  </span>    <span style="color: #008000; font-weight: bold;">tcp_replace_ts_recent</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 39:  </span>
<span class="linenr"> 40:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 3: check security and precedence [ignored] </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 41:  </span>
<span class="linenr"> 42:  </span>    <span style="color: #b22222;">/*  </span><span style="color: #b22222;">step 4:</span>
<span class="linenr"> 43:  </span><span style="color: #b22222;">     *</span>
<span class="linenr"> 44:  </span><span style="color: #b22222;">     *  Check for a SYN in window.</span>
<span class="linenr"> 45:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 46:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">syn</span> <span style="color: #8b6508;">&amp;&amp;</span> !<span style="color: #008000; font-weight: bold;">before</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;SYN&#26631;&#24535;&#24182;&#19988;&#24207;&#21495;&#22312;&#25509;&#25910;&#31383;&#21475;&#20869; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 47:  </span>        <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span>LINUX_MIB_TCPABORTONSYN<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 48:  </span>        <span style="color: #008000; font-weight: bold;">tcp_reset</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22797;&#20301;&#36830;&#25509; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 49:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 50:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 51:  </span>
<span class="linenr"> 52:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 5: check the ACK field </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 53:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26377;ACK&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 54:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26816;&#26597;ACK&#26159;&#21542;&#20026;&#27491;&#24120;&#30340;&#31532;&#19977;&#27425;&#25569;&#25163; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 55:  </span>        <span style="color: #228b22;">int</span> <span style="color: #a0522d;">acceptable</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_ack</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> FLAG_SLOWPATH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 56:  </span>
<span class="linenr"> 57:  </span>        <span style="color: #a020f0;">switch</span><span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 58:  </span>        <span style="color: #a020f0;">case</span> TCP_SYN_RECV<span style="color: #8b6508;">:</span>
<span class="linenr"> 59:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>acceptable<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 60:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">copied_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rcv_nxt</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 61:  </span>                <span style="color: #008000; font-weight: bold;">mb</span><span style="color: #cd2626;">()</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 62:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#27491;&#24120;&#30340;&#31532;&#19977;&#27425;&#25569;&#25163;&#65292;&#35774;&#32622;&#36830;&#25509;&#29366;&#24577;&#20026;TCP_ESTABLISHED </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 63:  </span>                <span style="color: #008000; font-weight: bold;">tcp_set_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_ESTABLISHED<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 64:  </span>                sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state_change</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 65:  </span>
<span class="linenr"> 66:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Note, that this wakeup is only for marginal</span>
<span class="linenr"> 67:  </span><span style="color: #b22222;">                 * crossed SYN case. Passively open sockets</span>
<span class="linenr"> 68:  </span><span style="color: #b22222;">                 * are not waked up, because sk-&gt;sk_sleep ==</span>
<span class="linenr"> 69:  </span><span style="color: #b22222;">                 * NULL and sk-&gt;sk_socket == NULL.</span>
<span class="linenr"> 70:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 71:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_socket</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29366;&#24577;&#24050;&#32463;&#27491;&#24120;&#65292;&#21796;&#37266;&#37027;&#20123;&#31561;&#24453;&#30340;&#32447;&#31243; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 72:  </span>                    <span style="color: #008000; font-weight: bold;">sk_wake_async</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span><span style="color: #ff0000;">0</span><span style="color: #8b6508;">,</span>POLL_OUT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 73:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr"> 74:  </span>
<span class="linenr"> 75:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#20256;&#36755;&#25511;&#21046;&#22359;&#65292;&#22914;&#26524;&#23384;&#22312;&#26102;&#38388;&#25139;&#36873;&#39033;&#65292;&#21516;&#26102;&#24179;&#28369;RTT&#20026;0&#65292;&#21017;&#38656;&#35745;&#31639;&#37325;&#20256;&#36229;&#26102;&#26102;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 76:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 77:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ntohs</span><span style="color: #cd2626;">(</span>th<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&lt;&lt;</span>
<span class="linenr"> 78:  </span>                          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">snd_wscale</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 79:  </span>                <span style="color: #008000; font-weight: bold;">tcp_init_wl</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 80:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 81:  </span>
<span class="linenr"> 82:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">tcp_ack considers this ACK as duplicate</span>
<span class="linenr"> 83:  </span><span style="color: #b22222;">                 * and does not calculate rtt.</span>
<span class="linenr"> 84:  </span><span style="color: #b22222;">                 * Fix it at least with timestamps.</span>
<span class="linenr"> 85:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 86:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">saw_tstamp</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">rcv_tsecr</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 87:  </span>                    !tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">srtt</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 88:  </span>                    <span style="color: #008000; font-weight: bold;">tcp_ack_saw_tstamp</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 89:  </span>
<span class="linenr"> 90:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">tstamp_ok</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 91:  </span>                    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">advmss</span> <span style="color: #8b6508;">-=</span> TCPOLEN_TSTAMP_ALIGNED<span style="color: #8b6508;">;</span>
<span class="linenr"> 92:  </span>
<span class="linenr"> 93:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Make sure socket is routed, for</span>
<span class="linenr"> 94:  </span><span style="color: #b22222;">                 * correct metrics.</span>
<span class="linenr"> 95:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 96:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24314;&#31435;&#36335;&#30001;&#65292;&#21021;&#22987;&#21270;&#25317;&#22622;&#25511;&#21046;&#27169;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 97:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">af_specific</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rebuild_header</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 98:  </span>
<span class="linenr"> 99:  </span>                <span style="color: #008000; font-weight: bold;">tcp_init_metrics</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">100:  </span>
<span class="linenr">101:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Prevent spurious tcp_cwnd_restart() on</span>
<span class="linenr">102:  </span><span style="color: #b22222;">                 * first data packet.</span>
<span class="linenr">103:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr">104:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lsndtime</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#26368;&#36817;&#19968;&#27425;&#21457;&#36865;&#25968;&#25454;&#21253;&#30340;&#26102;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">105:  </span>
<span class="linenr">106:  </span>                <span style="color: #008000; font-weight: bold;">tcp_initialize_rcv_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">107:  </span>                <span style="color: #008000; font-weight: bold;">tcp_init_buffer_space</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">108:  </span>                <span style="color: #008000; font-weight: bold;">tcp_fast_path_on</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35745;&#31639;&#26377;&#20851;TCP&#39318;&#37096;&#39044;&#27979;&#30340;&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr">109:  </span>            <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">110:  </span>                <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">111:  </span>            <span style="color: #cd2626;">}</span>
<span class="linenr">112:  </span>            <span style="color: #a020f0;">break</span><span style="color: #8b6508;">;</span>
<span class="linenr">113:  </span>        <span style="color: #8b6508;">.....</span>
<span class="linenr">114:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">115:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span>
<span class="linenr">116:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">discard</span><span style="color: #8b6508;">;</span>
<span class="linenr">117:  </span>    <span style="color: #8b6508;">.....</span>
<span class="linenr">118:  </span>
<span class="linenr">119:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">step 6: check the URG bit </span><span style="color: #b22222;">*/</span>
<span class="linenr">120:  </span>    <span style="color: #008000; font-weight: bold;">tcp_urg</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> th<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26816;&#27979;&#24102;&#22806;&#25968;&#25454;&#20301; </span><span style="color: #b22222;">*/</span>
<span class="linenr">121:  </span>
<span class="linenr">122:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">tcp_data could move socket to TIME-WAIT </span><span style="color: #b22222;">*/</span>
<span class="linenr">123:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span> <span style="color: #8b6508;">!=</span> TCP_CLOSE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;tcp_data&#38656;&#35201;&#21457;&#36865;&#25968;&#25454;&#21644;ACK&#21017;&#22312;&#36825;&#37324;&#22788;&#29702; </span><span style="color: #b22222;">*/</span>
<span class="linenr">124:  </span>        <span style="color: #008000; font-weight: bold;">tcp_data_snd_check</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">125:  </span>        <span style="color: #008000; font-weight: bold;">tcp_ack_snd_check</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">126:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">127:  </span>
<span class="linenr">128:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!queued<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#27573;&#27809;&#26377;&#21152;&#20837;&#38431;&#21015;&#65292;&#25110;&#32773;&#21069;&#38754;&#30340;&#27969;&#31243;&#38656;&#35201;&#37322;&#25918;&#25253;&#25991;&#65292;&#21017;&#37322;&#25918;&#23427; </span><span style="color: #b22222;">*/</span>
<span class="linenr">129:  </span><span style="color: #008b8b;">discard</span><span style="color: #8b6508;">:</span>
<span class="linenr">130:  </span>        <span style="color: #008000; font-weight: bold;">__kfree_skb</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">131:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">132:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">133:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</li>
</ul>


<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 数据传输</h2>
<div class="outline-text-2" id="text-5">


</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> 客户端请求数据</h3>
<div class="outline-text-3" id="text-5-1">

<ul>
<li>由send() -&gt; sendto() -&gt; tcp_sendmsg().当前服务端处于TCP_ESTABLISHED状态。<br/>
</li>
</ul>


</div>

<div id="outline-container-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"><span class="section-number-4">5.1.1</span> send()</h4>
<div class="outline-text-4" id="text-5-1-1">

<p>     send() 直接调用了sendto().<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #b22222;">/*</span>
<span class="linenr">2:  </span><span style="color: #b22222;"> *  Send a datagram down a socket.</span>
<span class="linenr">3:  </span><span style="color: #b22222;"> </span><span style="color: #b22222;">*/</span>
<span class="linenr">4:  </span>
<span class="linenr">5:  </span><span style="color: #0000ff; font-size: 120%;">SYSCALL_DEFINE4</span><span style="color: #cd2626;">(</span>send<span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span><span style="color: #8b6508;">,</span> fd<span style="color: #8b6508;">,</span> <span style="color: #228b22;">void</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*,</span> buff<span style="color: #8b6508;">,</span> <span style="color: #228b22;">size_t</span><span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span>
<span class="linenr">6:  </span>        <span style="color: #228b22;">unsigned</span><span style="color: #8b6508;">,</span> flags<span style="color: #cd2626;">)</span>
<span class="linenr">7:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">8:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #008000; font-weight: bold;">sys_sendto</span><span style="color: #cd2626;">(</span>fd<span style="color: #8b6508;">,</span> buff<span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">9:  </span><span style="color: #cd2626;">}</span>
</pre>


</p>
<p>    <br/>
</p></div>

</div>

<div id="outline-container-5-1-2" class="outline-4">
<h4 id="sec-5-1-2"><span class="section-number-4">5.1.2</span> sendto()</h4>
<div class="outline-text-4" id="text-5-1-2">


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/*</span>
<span class="linenr"> 2:  </span><span style="color: #b22222;"> *  Send a datagram to a given address. We move the address into kernel</span>
<span class="linenr"> 3:  </span><span style="color: #b22222;"> *  space and check the user space data area is readable before invoking</span>
<span class="linenr"> 4:  </span><span style="color: #b22222;"> *  the protocol.</span>
<span class="linenr"> 5:  </span><span style="color: #b22222;"> </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span><span style="color: #0000ff; font-size: 120%;">SYSCALL_DEFINE6</span><span style="color: #cd2626;">(</span>sendto<span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span><span style="color: #8b6508;">,</span> fd<span style="color: #8b6508;">,</span> <span style="color: #228b22;">void</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*,</span> buff<span style="color: #8b6508;">,</span> <span style="color: #228b22;">size_t</span><span style="color: #8b6508;">,</span> len<span style="color: #8b6508;">,</span>
<span class="linenr"> 8:  </span>        <span style="color: #228b22;">unsigned</span><span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*,</span> addr<span style="color: #8b6508;">,</span>
<span class="linenr"> 9:  </span>        <span style="color: #228b22;">int</span><span style="color: #8b6508;">,</span> addr_len<span style="color: #cd2626;">)</span>
<span class="linenr">10:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">11:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">socket</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sock</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr_storage</span> <span style="color: #a0522d;">address</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span><span style="color: #8b6508;">;</span>
<span class="linenr">14:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #a0522d;">msg</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span> <span style="color: #a0522d;">iov</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">fput_needed</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>
<span class="linenr">18:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>len <span style="color: #8b6508;">&gt;</span> INT_MAX<span style="color: #cd2626;">)</span>
<span class="linenr">19:  </span>        len <span style="color: #8b6508;">=</span> INT_MAX<span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    sock <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sockfd_lookup_light</span><span style="color: #cd2626;">(</span>fd<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>err<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>fput_needed<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!sock<span style="color: #cd2626;">)</span>
<span class="linenr">22:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>
<span class="linenr">24:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#20986;&#29992;&#25143;&#31354;&#38388;&#30340;buff&#30452;&#25509;&#36171;&#32473;&#20102;iov.iov_base, iov.iov_len = len </span><span style="color: #b22222;">*/</span>     
<span class="linenr">25:  </span>    iov<span style="color: #8b6508;">.</span><span style="color: #008000;">iov_base</span> <span style="color: #8b6508;">=</span> buff<span style="color: #8b6508;">;</span>
<span class="linenr">26:  </span>    iov<span style="color: #8b6508;">.</span><span style="color: #008000;">iov_len</span> <span style="color: #8b6508;">=</span> len<span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_name</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_iov</span> <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">&amp;</span>iov<span style="color: #8b6508;">;</span>
<span class="linenr">29:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">30:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_control</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_controllen</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_namelen</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">33:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>addr<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">34:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">move_addr_to_kernel</span><span style="color: #cd2626;">(</span>addr<span style="color: #8b6508;">,</span> addr_len<span style="color: #8b6508;">,</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">35:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err <span style="color: #8b6508;">&lt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr">36:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_put</span><span style="color: #8b6508;">;</span>
<span class="linenr">37:  </span>        msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_name</span> <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #8b6508;">;</span>
<span class="linenr">38:  </span>        msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_namelen</span> <span style="color: #8b6508;">=</span> addr_len<span style="color: #8b6508;">;</span>
<span class="linenr">39:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">40:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">f_flags</span> <span style="color: #8b6508;">&amp;</span> O_NONBLOCK<span style="color: #cd2626;">)</span>
<span class="linenr">41:  </span>        flags <span style="color: #8b6508;">|=</span> MSG_DONTWAIT<span style="color: #8b6508;">;</span>
<span class="linenr">42:  </span>    msg<span style="color: #8b6508;">.</span><span style="color: #008000;">msg_flags</span> <span style="color: #8b6508;">=</span> flags<span style="color: #8b6508;">;</span>
<span class="linenr">43:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sendmsg</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>msg<span style="color: #8b6508;">,</span> len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">44:  </span>
<span class="linenr">45:  </span><span style="color: #008b8b;">out_put</span><span style="color: #8b6508;">:</span>
<span class="linenr">46:  </span>    <span style="color: #008000; font-weight: bold;">fput_light</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #8b6508;">,</span> fput_needed<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">47:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">48:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">49:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>

</div>

</div>

<div id="outline-container-5-1-3" class="outline-4">
<h4 id="sec-5-1-3"><span class="section-number-4">5.1.3</span> __sys_sendmsg()</h4>
<div class="outline-text-4" id="text-5-1-3">

<p>    关键路径：　<br/>
    － 通过copy_from_user把用户的struct msghdr拷贝到内核的msg_sys。<br/>
    － 也通过verify_iovec()把用户buff中的内容拷贝到内核的iovstack中。<br/>
    － 最后调用sock_sendmsg().<br/>
</p>
<p>    <br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">__sys_sendmsg</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">socket</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sock</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg</span><span style="color: #8b6508;">,</span>
<span class="linenr">  2:  </span>             <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg_sys</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">unsigned</span> <span style="color: #a0522d;">flags</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>             <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">used_address</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">used_address</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">compat_msghdr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg_compat</span> <span style="color: #8b6508;">=</span>
<span class="linenr">  6:  </span>        <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">compat_msghdr</span> <span style="color: #228b22;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>msg<span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr_storage</span> <span style="color: #a0522d;">address</span><span style="color: #8b6508;">;</span>
<span class="linenr">  8:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span> <span style="color: #a0522d;">iovstack</span><span style="color: #cd2626;">[</span>UIO_FASTIOV<span style="color: #cd2626;">]</span><span style="color: #8b6508;">,</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">iov</span> <span style="color: #8b6508;">=</span> iovstack<span style="color: #8b6508;">;</span>
<span class="linenr">  9:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">char</span> <span style="color: #a0522d;">ctl</span><span style="color: #cd2626;">[</span><span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">cmsghdr</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">20</span><span style="color: #cd2626;">]</span>
<span class="linenr"> 10:  </span>        <span style="color: #a020f0;">__attribute__</span> <span style="color: #cd2626;">((</span><span style="color: #008000; font-weight: bold;">aligned</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #228b22;">__kernel_size_t</span><span style="color: #cd2626;">))))</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 11:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">20 is size of ipv6_pktinfo </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 12:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">char</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">ctl_buf</span> <span style="color: #8b6508;">=</span> ctl<span style="color: #8b6508;">;</span>
<span class="linenr"> 13:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">ctl_len</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">iov_size</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">total_len</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 14:  </span>
<span class="linenr"> 15:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 16:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>MSG_CMSG_COMPAT <span style="color: #8b6508;">&amp;</span> flags<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 17:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">get_compat_msghdr</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> msg_compat<span style="color: #cd2626;">))</span>
<span class="linenr"> 18:  </span>            <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 19:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 20:  </span>    <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">copy_from_user</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> msg<span style="color: #8b6508;">,</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span><span style="color: #cd2626;">)))</span>
<span class="linenr"> 21:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 22:  </span>
<span class="linenr"> 23:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">do not move before msg_sys is valid </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 24:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EMSGSIZE<span style="color: #8b6508;">;</span>
<span class="linenr"> 25:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">&gt;</span> UIO_MAXIOV<span style="color: #cd2626;">)</span>
<span class="linenr"> 26:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 27:  </span>
<span class="linenr"> 28:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Check whether to allocate the iovec area </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 29:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>ENOMEM<span style="color: #8b6508;">;</span>
<span class="linenr"> 30:  </span>    iov_size <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">*</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 31:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span> <span style="color: #8b6508;">&gt;</span> UIO_FASTIOV<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 32:  </span>        iov <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_kmalloc</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> iov_size<span style="color: #8b6508;">,</span> GFP_KERNEL<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 33:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!iov<span style="color: #cd2626;">)</span>
<span class="linenr"> 34:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 35:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 36:  </span>
<span class="linenr"> 37:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">This will also move the address data into kernel space </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 38:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>MSG_CMSG_COMPAT <span style="color: #8b6508;">&amp;</span> flags<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 39:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">verify_compat_iovec</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> iov<span style="color: #8b6508;">,</span>
<span class="linenr"> 40:  </span>                      <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #8b6508;">,</span>
<span class="linenr"> 41:  </span>                      VERIFY_READ<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 42:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span>
<span class="linenr"> 43:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">verify_iovec</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> iov<span style="color: #8b6508;">,</span>
<span class="linenr"> 44:  </span>                   <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sockaddr</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">&amp;</span>address<span style="color: #8b6508;">,</span>
<span class="linenr"> 45:  </span>                   VERIFY_READ<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 46:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err <span style="color: #8b6508;">&lt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 47:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 48:  </span>    total_len <span style="color: #8b6508;">=</span> err<span style="color: #8b6508;">;</span>
<span class="linenr"> 49:  </span>
<span class="linenr"> 50:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>ENOBUFS<span style="color: #8b6508;">;</span>
<span class="linenr"> 51:  </span>
<span class="linenr"> 52:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_controllen</span> <span style="color: #8b6508;">&gt;</span> INT_MAX<span style="color: #cd2626;">)</span>
<span class="linenr"> 53:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 54:  </span>    ctl_len <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_controllen</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 55:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>MSG_CMSG_COMPAT <span style="color: #8b6508;">&amp;</span> flags<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> ctl_len<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 56:  </span>        err <span style="color: #8b6508;">=</span>
<span class="linenr"> 57:  </span>            <span style="color: #008000; font-weight: bold;">cmsghdr_from_user_compat_to_kern</span><span style="color: #cd2626;">(</span>msg_sys<span style="color: #8b6508;">,</span> sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> ctl<span style="color: #8b6508;">,</span>
<span class="linenr"> 58:  </span>                             <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span>ctl<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 59:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span>
<span class="linenr"> 60:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 61:  </span>        ctl_buf <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_control</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 62:  </span>        ctl_len <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_controllen</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 63:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_len<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 64:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_len <span style="color: #8b6508;">&gt;</span> <span style="color: #a020f0;">sizeof</span><span style="color: #cd2626;">(</span>ctl<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 65:  </span>            ctl_buf <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_kmalloc</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> ctl_len<span style="color: #8b6508;">,</span> GFP_KERNEL<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 66:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_buf <span style="color: #8b6508;">==</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 67:  </span>                <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 68:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr"> 69:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EFAULT<span style="color: #8b6508;">;</span>
<span class="linenr"> 70:  </span>        <span style="color: #b22222;">/*</span>
<span class="linenr"> 71:  </span><span style="color: #b22222;">         * Careful! Before this, msg_sys-&gt;msg_control contains a user pointer.</span>
<span class="linenr"> 72:  </span><span style="color: #b22222;">         * Afterwards, it will be a kernel pointer. Thus the compiler-assisted</span>
<span class="linenr"> 73:  </span><span style="color: #b22222;">         * checking falls down on this.</span>
<span class="linenr"> 74:  </span><span style="color: #b22222;">         </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 75:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">copy_from_user</span><span style="color: #cd2626;">(</span>ctl_buf<span style="color: #8b6508;">,</span> <span style="color: #cd2626;">(</span><span style="color: #228b22;">void</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*</span><span style="color: #cd2626;">)</span>msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_control</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 76:  </span>                   ctl_len<span style="color: #cd2626;">))</span>
<span class="linenr"> 77:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freectl</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 78:  </span>        msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_control</span> <span style="color: #8b6508;">=</span> ctl_buf<span style="color: #8b6508;">;</span>
<span class="linenr"> 79:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 80:  </span>    msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_flags</span> <span style="color: #8b6508;">=</span> flags<span style="color: #8b6508;">;</span>
<span class="linenr"> 81:  </span>
<span class="linenr"> 82:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">file</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">f_flags</span> <span style="color: #8b6508;">&amp;</span> O_NONBLOCK<span style="color: #cd2626;">)</span>
<span class="linenr"> 83:  </span>        msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_flags</span> <span style="color: #8b6508;">|=</span> MSG_DONTWAIT<span style="color: #8b6508;">;</span>
<span class="linenr"> 84:  </span>    <span style="color: #b22222;">/*</span>
<span class="linenr"> 85:  </span><span style="color: #b22222;">     * If this is sendmmsg() and current destination address is same as</span>
<span class="linenr"> 86:  </span><span style="color: #b22222;">     * previously succeeded address, omit asking LSM's decision.</span>
<span class="linenr"> 87:  </span><span style="color: #b22222;">     * used_address-&gt;name_len is initialized to UINT_MAX so that the first</span>
<span class="linenr"> 88:  </span><span style="color: #b22222;">     * destination address never matches.</span>
<span class="linenr"> 89:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 90:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>used_address <span style="color: #8b6508;">&amp;&amp;</span> used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span> <span style="color: #8b6508;">==</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_namelen</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 91:  </span>        !<span style="color: #008000; font-weight: bold;">memcmp</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name</span><span style="color: #8b6508;">,</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_name</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 92:  </span>            used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 93:  </span>        err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sendmsg_nosec</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> msg_sys<span style="color: #8b6508;">,</span> total_len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 94:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_freectl</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 95:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr"> 96:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sendmsg</span><span style="color: #cd2626;">(</span>sock<span style="color: #8b6508;">,</span> msg_sys<span style="color: #8b6508;">,</span> total_len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 97:  </span>    <span style="color: #b22222;">/*</span>
<span class="linenr"> 98:  </span><span style="color: #b22222;">     * If this is sendmmsg() and sending to current destination address was</span>
<span class="linenr"> 99:  </span><span style="color: #b22222;">     * successful, remember it.</span>
<span class="linenr">100:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">101:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>used_address <span style="color: #8b6508;">&amp;&amp;</span> err <span style="color: #8b6508;">&gt;=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">102:  </span>        used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span> <span style="color: #8b6508;">=</span> msg_sys<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_namelen</span><span style="color: #8b6508;">;</span>
<span class="linenr">103:  </span>        <span style="color: #008000; font-weight: bold;">memcpy</span><span style="color: #cd2626;">(</span><span style="color: #8b6508;">&amp;</span>used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name</span><span style="color: #8b6508;">,</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_name</span><span style="color: #8b6508;">,</span>
<span class="linenr">104:  </span>               used_address<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">name_len</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">105:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">106:  </span>
<span class="linenr">107:  </span><span style="color: #008b8b;">out_freectl</span><span style="color: #8b6508;">:</span>
<span class="linenr">108:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ctl_buf <span style="color: #8b6508;">!=</span> ctl<span style="color: #cd2626;">)</span>
<span class="linenr">109:  </span>        <span style="color: #008000; font-weight: bold;">sock_kfree_s</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> ctl_buf<span style="color: #8b6508;">,</span> ctl_len<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">110:  </span><span style="color: #008b8b;">out_freeiov</span><span style="color: #8b6508;">:</span>
<span class="linenr">111:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>iov <span style="color: #8b6508;">!=</span> iovstack<span style="color: #cd2626;">)</span>
<span class="linenr">112:  </span>        <span style="color: #008000; font-weight: bold;">sock_kfree_s</span><span style="color: #cd2626;">(</span>sock<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk</span><span style="color: #8b6508;">,</span> iov<span style="color: #8b6508;">,</span> iov_size<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">113:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">114:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">115:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">116:  </span>
</pre>

    </div>
</p>
<p>     <br/>
</p></div>

</div>

<div id="outline-container-5-1-4" class="outline-4">
<h4 id="sec-5-1-4"><span class="section-number-4">5.1.4</span> tcp_sendmsg():</h4>
<div class="outline-text-4" id="text-5-1-4">


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr">  1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">sendmsg&#31995;&#32479;&#35843;&#29992;&#22312;TCP&#23618;&#30340;&#23454;&#29616; </span><span style="color: #b22222;">*/</span>
<span class="linenr">  2:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_sendmsg</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">kiocb</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">iocb</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">msghdr</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">msg</span><span style="color: #8b6508;">,</span>
<span class="linenr">  3:  </span>        <span style="color: #228b22;">size_t</span> <span style="color: #a0522d;">size</span><span style="color: #cd2626;">)</span>
<span class="linenr">  4:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">  5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">iovec</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">iov</span><span style="color: #8b6508;">;</span>
<span class="linenr">  6:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">  7:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">;</span>
<span class="linenr">  8:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">iovlen</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">flags</span><span style="color: #8b6508;">;</span>
<span class="linenr">  9:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">mss_now</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 10:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">copied</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 11:  </span>    <span style="color: #228b22;">long</span> <span style="color: #a0522d;">timeo</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 12:  </span>
<span class="linenr"> 13:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#21462;&#22871;&#25509;&#21475;&#30340;&#38145; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 14:  </span>    <span style="color: #008000; font-weight: bold;">lock_sock</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 15:  </span>    <span style="color: #008000; font-weight: bold;">TCP_CHECK_TIMER</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 16:  </span>
<span class="linenr"> 17:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#26631;&#24535;&#35745;&#31639;&#38459;&#22622;&#36229;&#26102;&#26102;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 18:  </span>    flags <span style="color: #8b6508;">=</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_flags</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 19:  </span>    timeo <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sock_sndtimeo</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flags <span style="color: #8b6508;">&amp;</span> MSG_DONTWAIT<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 20:  </span>
<span class="linenr"> 21:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Wait for a connection to finish. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 22:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span><span style="color: #ff0000;">1</span> <span style="color: #8b6508;">&lt;&lt;</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_state</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;</span> <span style="color: #8b6508;">~</span><span style="color: #cd2626;">(</span>TCPF_ESTABLISHED <span style="color: #8b6508;">|</span> TCPF_CLOSE_WAIT<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21482;&#26377;&#36825;&#20004;&#31181;&#29366;&#24577;&#25165;&#33021;&#21457;&#36865;&#28040;&#24687; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 23:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_wait_connect</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>timeo<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">!=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20854;&#23427;&#29366;&#24577;&#19979;&#31561;&#24453;&#36830;&#25509;&#27491;&#30830;&#24314;&#31435;&#65292;&#36229;&#26102;&#21017;&#36827;&#34892;&#38169;&#35823;&#22788;&#29702; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 24:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out_err</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 25:  </span>
<span class="linenr"> 26:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">This should be in poll </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 27:  </span>    <span style="color: #008000; font-weight: bold;">clear_bit</span><span style="color: #cd2626;">(</span>SOCK_ASYNC_NOSPACE<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_socket</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 28:  </span>
<span class="linenr"> 29:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#24471;&#26377;&#25928;&#30340;MSS&#65292;&#22914;&#26524;&#25903;&#25345;OOB&#65292;&#21017;&#19981;&#33021;&#25903;&#25345;TSO&#65292;MSS&#21017;&#24212;&#24403;&#26159;&#27604;&#36739;&#23567;&#30340;&#20540; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 30:  </span>    mss_now <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> !<span style="color: #cd2626;">(</span>flags<span style="color: #8b6508;">&amp;</span>MSG_OOB<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 31:  </span>
<span class="linenr"> 32:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Ok commence sending. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 33:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#33719;&#21462;&#24453;&#21457;&#36865;&#25968;&#25454;&#22359;&#25968;&#21450;&#25968;&#25454;&#22359;&#25351;&#38024; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 34:  </span>    iovlen <span style="color: #8b6508;">=</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iovlen</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 35:  </span>    iov <span style="color: #8b6508;">=</span> msg<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">msg_iov</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 36:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">copied&#34920;&#31034;&#20174;&#29992;&#25143;&#25968;&#25454;&#22359;&#22797;&#21046;&#21040;skb&#20013;&#30340;&#23383;&#33410;&#25968;&#12290; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 37:  </span>    copied <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 38:  </span>
<span class="linenr"> 39:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #8b6508;">-</span>EPIPE<span style="color: #8b6508;">;</span>
<span class="linenr"> 40:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22871;&#25509;&#21475;&#23384;&#22312;&#38169;&#35823;&#65292;&#21017;&#19981;&#20801;&#35768;&#21457;&#36865;&#25968;&#25454;&#65292;&#36820;&#22238;EPIPE&#38169;&#35823; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 41:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_err</span> <span style="color: #8b6508;">||</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_shutdown</span> <span style="color: #8b6508;">&amp;</span> SEND_SHUTDOWN<span style="color: #cd2626;">))</span>
<span class="linenr"> 42:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 43:  </span>
<span class="linenr"> 44:  </span>    <span style="color: #a020f0;">while</span> <span style="color: #cd2626;">(</span><span style="color: #8b6508;">--</span>iovlen <span style="color: #8b6508;">&gt;=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;&#25152;&#26377;&#24453;&#21457;&#36865;&#25968;&#25454;&#22359; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 45:  </span>        <span style="color: #228b22;">int</span> <span style="color: #a0522d;">seglen</span> <span style="color: #8b6508;">=</span> iov<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">iov_len</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 46:  </span>        <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">char</span> <span style="color: #a0522d;">__user</span> <span style="color: #8b6508;">*</span>from <span style="color: #8b6508;">=</span> iov<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">iov_base</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 47:  </span>
<span class="linenr"> 48:  </span>        iov<span style="color: #8b6508;">++;</span>
<span class="linenr"> 49:  </span>
<span class="linenr"> 50:  </span>        <span style="color: #a020f0;">while</span> <span style="color: #cd2626;">(</span>seglen <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;&#21333;&#20010;&#25968;&#25454;&#22359;&#20013;&#30340;&#25152;&#26377;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 51:  </span>            <span style="color: #228b22;">int</span> <span style="color: #a0522d;">copy</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 52:  </span>
<span class="linenr"> 53:  </span>            skb <span style="color: #8b6508;">=</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_write_queue</span><span style="color: #8b6508;">.</span><span style="color: #008000;">prev</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 54:  </span>
<span class="linenr"> 55:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span> <span style="color: #8b6508;">||</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;&#38431;&#21015;&#20026;&#31354;&#65292;&#21069;&#38754;&#21462;&#24471;&#30340;skb&#26080;&#25928; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 56:  </span>                <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">=</span> mss_now <span style="color: #8b6508;">-</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&lt;=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;skb&#26377;&#25928;&#65292;&#20294;&#26159;&#23427;&#24050;&#32463;&#27809;&#26377;&#22810;&#20313;&#30340;&#31354;&#38388;&#22797;&#21046;&#26032;&#25968;&#25454;&#20102; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 57:  </span>
<span class="linenr"> 58:  </span><span style="color: #008b8b;">new_segment</span><span style="color: #8b6508;">:</span>
<span class="linenr"> 59:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Allocate new segment. If the interface is SG,</span>
<span class="linenr"> 60:  </span><span style="color: #b22222;">                 * allocate skb fitting to single page.</span>
<span class="linenr"> 61:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 62:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">sk_stream_memory_free</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21457;&#36865;&#38431;&#21015;&#20013;&#25968;&#25454;&#38271;&#24230;&#36798;&#21040;&#21457;&#36865;&#32531;&#20914;&#21306;&#30340;&#19978;&#38480;&#65292;&#31561;&#24453;&#32531;&#20914;&#21306; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 63:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">wait_for_sndbuf</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 64:  </span>
<span class="linenr"> 65:  </span>                skb <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_alloc_pskb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">select_size</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 66:  </span>                               <span style="color: #ff0000;">0</span><span style="color: #8b6508;">,</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_allocation</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#26032;&#30340;skb </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 67:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!skb<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#22833;&#36133;&#65292;&#35828;&#26126;&#31995;&#32479;&#20869;&#23384;&#19981;&#36275;&#65292;&#31561;&#24453; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 68:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">wait_for_memory</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 69:  </span>
<span class="linenr"> 70:  </span>                <span style="color: #b22222;">/*</span>
<span class="linenr"> 71:  </span><span style="color: #b22222;">                 * Check whether we can use HW checksum.</span>
<span class="linenr"> 72:  </span><span style="color: #b22222;">                 </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 73:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_route_caps</span> <span style="color: #8b6508;">&amp;</span>
<span class="linenr"> 74:  </span>                    <span style="color: #cd2626;">(</span>NETIF_F_IP_CSUM <span style="color: #8b6508;">|</span> NETIF_F_NO_CSUM <span style="color: #8b6508;">|</span>
<span class="linenr"> 75:  </span>                     NETIF_F_HW_CSUM<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;&#36335;&#30001;&#32593;&#32476;&#35774;&#22791;&#30340;&#29305;&#24615;&#65292;&#30830;&#23450;&#26159;&#21542;&#30001;&#30828;&#20214;&#25191;&#34892;&#26657;&#39564;&#21644; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 76:  </span>                    skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ip_summed</span> <span style="color: #8b6508;">=</span> CHECKSUM_HW<span style="color: #8b6508;">;</span>
<span class="linenr"> 77:  </span>
<span class="linenr"> 78:  </span>                <span style="color: #008000; font-weight: bold;">skb_entail</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23558;SKB&#28155;&#21152;&#21040;&#21457;&#36865;&#38431;&#21015;&#23614;&#37096; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 79:  </span>                copy <span style="color: #8b6508;">=</span> mss_now<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26412;&#27425;&#38656;&#35201;&#22797;&#21046;&#30340;&#25968;&#25454;&#37327;&#26159;MSS </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 80:  </span>            <span style="color: #cd2626;">}</span>
<span class="linenr"> 81:  </span>
<span class="linenr"> 82:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Try to append data to the end of skb. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 83:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">&gt;</span> seglen<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35201;&#22797;&#21046;&#30340;&#25968;&#25454;&#19981;&#33021;&#22823;&#20110;&#24403;&#21069;&#27573;&#30340;&#38271;&#24230; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 84:  </span>                copy <span style="color: #8b6508;">=</span> seglen<span style="color: #8b6508;">;</span>
<span class="linenr"> 85:  </span>
<span class="linenr"> 86:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Where to copy to? </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 87:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">skb_tailroom</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">skb&#32447;&#24615;&#23384;&#20648;&#21306;&#24213;&#37096;&#36824;&#26377;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 88:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">We have some space in skb head. Superb! </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 89:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">&gt;</span> <span style="color: #008000; font-weight: bold;">skb_tailroom</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26412;&#27425;&#21482;&#22797;&#21046;skb&#23384;&#20648;&#21306;&#24213;&#37096;&#21097;&#20313;&#31354;&#38388;&#22823;&#23567;&#30340;&#25968;&#25454;&#37327; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 90:  </span>                    copy <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_tailroom</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 91:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#29992;&#25143;&#31354;&#38388;&#22797;&#21046;&#25351;&#23450;&#38271;&#24230;&#30340;&#25968;&#25454;&#21040;skb&#20013;&#65292;&#22914;&#26524;&#22833;&#36133;&#65292;&#21017;&#36864;&#20986; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 92:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_add_data</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> from<span style="color: #8b6508;">,</span> copy<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">!=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 93:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_fault</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 94:  </span>            <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#32447;&#24615;&#23384;&#20648;&#21306;&#24213;&#37096;&#24050;&#32463;&#27809;&#26377;&#31354;&#38388;&#20102;&#65292;&#22797;&#21046;&#21040;&#20998;&#25955;/&#32858;&#38598;&#23384;&#20648;&#21306;&#20013; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 95:  </span>                <span style="color: #228b22;">int</span> <span style="color: #a0522d;">merge</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26159;&#21542;&#22312;&#39029;&#20013;&#28155;&#21152;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 96:  </span>                <span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">nr_frags</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#25955;/&#32858;&#38598;&#29255;&#26029;&#25968; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 97:  </span>                <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">page</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#29255;&#39029;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 98:  </span>                <span style="color: #228b22;">int</span> <span style="color: #a0522d;">off</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_OFF</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#29255;&#20869;&#30340;&#20559;&#31227; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 99:  </span>
<span class="linenr">100:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">skb_can_coalesce</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> i<span style="color: #8b6508;">,</span> page<span style="color: #8b6508;">,</span> off<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">101:  </span>                    off <span style="color: #8b6508;">!=</span> PAGE_SIZE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24403;&#21069;&#20998;&#29255;&#36824;&#33021;&#28155;&#21152;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">102:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">We can extend the last page</span>
<span class="linenr">103:  </span><span style="color: #b22222;">                     * fragment. </span><span style="color: #b22222;">*/</span>
<span class="linenr">104:  </span>                    merge <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">105:  </span>                <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>i <span style="color: #8b6508;">==</span> MAX_SKB_FRAGS <span style="color: #8b6508;">||</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30446;&#21069;skb&#20013;&#30340;&#39029;&#19981;&#33021;&#28155;&#21152;&#25968;&#25454;&#65292;&#36825;&#37324;&#21028;&#26029;&#26159;&#21542;&#33021;&#20877;&#20998;&#37197;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">106:  </span>                       <span style="color: #cd2626;">(</span>!i <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">107:  </span>                       !<span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_route_caps</span> <span style="color: #8b6508;">&amp;</span> NETIF_F_SG<span style="color: #cd2626;">)))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#32593;&#21345;&#19981;&#25903;&#25345;S/G&#65292;&#19981;&#33021;&#20998;&#29255; </span><span style="color: #b22222;">*/</span>
<span class="linenr">108:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Need to add new fragment and cannot</span>
<span class="linenr">109:  </span><span style="color: #b22222;">                     * do this because interface is non-SG,</span>
<span class="linenr">110:  </span><span style="color: #b22222;">                     * or because all the page slots are</span>
<span class="linenr">111:  </span><span style="color: #b22222;">                     * busy. </span><span style="color: #b22222;">*/</span>
<span class="linenr">112:  </span>                    <span style="color: #008000; font-weight: bold;">tcp_mark_push</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">SKB&#21487;&#20197;&#25552;&#20132;&#20102; </span><span style="color: #b22222;">*/</span>
<span class="linenr">113:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">new_segment</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37325;&#26032;&#20998;&#37197;skb </span><span style="color: #b22222;">*/</span>
<span class="linenr">114:  </span>                <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#39029;&#25968;&#37327;&#26410;&#36798;&#21040;&#19978;&#38480;&#65292;&#21028;&#26029;&#24403;&#21069;&#39029;&#26159;&#21542;&#36824;&#26377;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">115:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">If page is cached, align</span>
<span class="linenr">116:  </span><span style="color: #b22222;">                     * offset to L1 cache boundary</span>
<span class="linenr">117:  </span><span style="color: #b22222;">                     </span><span style="color: #b22222;">*/</span>
<span class="linenr">118:  </span>                    off <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span>off <span style="color: #8b6508;">+</span> L1_CACHE_BYTES <span style="color: #8b6508;">-</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;</span>
<span class="linenr">119:  </span>                          <span style="color: #8b6508;">~</span><span style="color: #cd2626;">(</span>L1_CACHE_BYTES <span style="color: #8b6508;">-</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">120:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>off <span style="color: #8b6508;">==</span> PAGE_SIZE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26368;&#21518;&#19968;&#20010;&#20998;&#39029;&#25968;&#25454;&#24050;&#32463;&#28385;&#65292;&#38656;&#35201;&#20998;&#37197;&#26032;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">121:  </span>                        <span style="color: #008000; font-weight: bold;">put_page</span><span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">122:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> page <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">123:  </span>                    <span style="color: #cd2626;">}</span>
<span class="linenr">124:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">125:  </span>
<span class="linenr">126:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!page<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38656;&#35201;&#20998;&#37197;&#26032;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">127:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Allocate new cache page. </span><span style="color: #b22222;">*/</span>
<span class="linenr">128:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>page <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_alloc_page</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)))</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#26032;&#39029;&#65292;&#22914;&#26524;&#20869;&#23384;&#19981;&#36275;&#21017;&#31561;&#24453;&#20869;&#23384; </span><span style="color: #b22222;">*/</span>
<span class="linenr">129:  </span>                        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">wait_for_memory</span><span style="color: #8b6508;">;</span>
<span class="linenr">130:  </span>                    off <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">131:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">132:  </span>
<span class="linenr">133:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copy <span style="color: #8b6508;">&gt;</span> PAGE_SIZE <span style="color: #8b6508;">-</span> off<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24453;&#22797;&#21046;&#30340;&#25968;&#25454;&#19981;&#33021;&#22823;&#20110;&#39029;&#20013;&#21097;&#20313;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">134:  </span>                    copy <span style="color: #8b6508;">=</span> PAGE_SIZE <span style="color: #8b6508;">-</span> off<span style="color: #8b6508;">;</span>
<span class="linenr">135:  </span>
<span class="linenr">136:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Time to copy data. We are close to</span>
<span class="linenr">137:  </span><span style="color: #b22222;">                 * the end! </span><span style="color: #b22222;">*/</span>
<span class="linenr">138:  </span>                err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">skb_copy_to_page</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> from<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> page<span style="color: #8b6508;">,</span>
<span class="linenr">139:  </span>                               off<span style="color: #8b6508;">,</span> copy<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#29992;&#25143;&#24577;&#22797;&#21046;&#25968;&#25454;&#21040;&#39029;&#20013; </span><span style="color: #b22222;">*/</span>
<span class="linenr">140:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>err<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22797;&#21046;&#22833;&#36133;&#20102; </span><span style="color: #b22222;">*/</span>
<span class="linenr">141:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">If this page was new, give it to the</span>
<span class="linenr">142:  </span><span style="color: #b22222;">                     * socket so it does not get leaked.</span>
<span class="linenr">143:  </span><span style="color: #b22222;">                     </span><span style="color: #b22222;">*/</span>
<span class="linenr">144:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#26159;&#26032;&#20998;&#37197;&#30340;&#39029;&#65292;&#21017;&#23558;&#39029;&#35760;&#24405;&#21040;skb&#20013;&#65292;&#20379;&#20170;&#21518;&#20351;&#29992; </span><span style="color: #b22222;">*/</span>
<span class="linenr">145:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> page<span style="color: #8b6508;">;</span>
<span class="linenr">146:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_OFF</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">147:  </span>                    <span style="color: #cd2626;">}</span>
<span class="linenr">148:  </span>                    <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">;</span>
<span class="linenr">149:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">150:  </span>
<span class="linenr">151:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">Update the skb. </span><span style="color: #b22222;">*/</span>
<span class="linenr">152:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;skb&#30340;&#20998;&#27573;&#20449;&#24687; </span><span style="color: #b22222;">*/</span>
<span class="linenr">153:  </span>                <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>merge<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;&#26368;&#21518;&#19968;&#20010;&#39029;&#20013;&#36861;&#21152;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">154:  </span>                    <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frags</span><span style="color: #cd2626;">[</span>i <span style="color: #8b6508;">-</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span><span style="color: #8b6508;">.</span><span style="color: #008000;">size</span> <span style="color: #8b6508;">+=</span>
<span class="linenr">155:  </span>                                    copy<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#26368;&#21518;&#19968;&#39029;&#30340;&#25968;&#25454;&#38271;&#24230; </span><span style="color: #b22222;">*/</span>
<span class="linenr">156:  </span>                <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26032;&#20998;&#37197;&#30340;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">157:  </span>                    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;skb&#20013;&#20998;&#29255;&#20449;&#24687; </span><span style="color: #b22222;">*/</span>
<span class="linenr">158:  </span>                    <span style="color: #008000; font-weight: bold;">skb_fill_page_desc</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> i<span style="color: #8b6508;">,</span> page<span style="color: #8b6508;">,</span> off<span style="color: #8b6508;">,</span> copy<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">159:  </span>                    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr">160:  </span>                        <span style="color: #008000; font-weight: bold;">get_page</span><span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">161:  </span>                    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>off <span style="color: #8b6508;">+</span> copy <span style="color: #8b6508;">&lt;</span> PAGE_SIZE<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">162:  </span>                        <span style="color: #008000; font-weight: bold;">get_page</span><span style="color: #cd2626;">(</span>page<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">163:  </span>                        <span style="color: #008000; font-weight: bold;">TCP_PAGE</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> page<span style="color: #8b6508;">;</span>
<span class="linenr">164:  </span>                    <span style="color: #cd2626;">}</span>
<span class="linenr">165:  </span>                <span style="color: #cd2626;">}</span>
<span class="linenr">166:  </span>
<span class="linenr">167:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#39029;&#20869;&#20559;&#31227; </span><span style="color: #b22222;">*/</span>
<span class="linenr">168:  </span>                <span style="color: #008000; font-weight: bold;">TCP_OFF</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">=</span> off <span style="color: #8b6508;">+</span> copy<span style="color: #8b6508;">;</span>
<span class="linenr">169:  </span>            <span style="color: #cd2626;">}</span>
<span class="linenr">170:  </span>
<span class="linenr">171:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!copied<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#27809;&#26377;&#22797;&#21046;&#25968;&#25454;&#65292;&#21017;&#21462;&#28040;PSH&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr">172:  </span>                <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span> <span style="color: #8b6508;">&amp;=</span> <span style="color: #8b6508;">~</span>TCPCB_FLAG_PSH<span style="color: #8b6508;">;</span>
<span class="linenr">173:  </span>
<span class="linenr">174:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">write_seq</span> <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#21457;&#36865;&#38431;&#21015;&#26368;&#21518;&#19968;&#20010;&#21253;&#30340;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">175:  </span>            <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span> <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;skb&#30340;&#24207;&#21495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">176:  </span>            <span style="color: #008000; font-weight: bold;">skb_shinfo</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">tso_segs</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">177:  </span>
<span class="linenr">178:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#25968;&#25454;&#22797;&#21046;&#30340;&#25351;&#38024; </span><span style="color: #b22222;">*/</span>
<span class="linenr">179:  </span>            from <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span>
<span class="linenr">180:  </span>            copied <span style="color: #8b6508;">+=</span> copy<span style="color: #8b6508;">;</span>
<span class="linenr">181:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#25152;&#26377;&#25968;&#25454;&#24050;&#32463;&#22797;&#21046;&#23436;&#27605;&#21017;&#36864;&#20986; </span><span style="color: #b22222;">*/</span>
<span class="linenr">182:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>seglen <span style="color: #8b6508;">-=</span> copy<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">==</span> <span style="color: #ff0000;">0</span> <span style="color: #8b6508;">&amp;&amp;</span> iovlen <span style="color: #8b6508;">==</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr">183:  </span>                <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">184:  </span>
<span class="linenr">185:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#24403;&#21069;skb&#20013;&#30340;&#25968;&#25454;&#23567;&#20110;mss&#65292;&#35828;&#26126;&#21487;&#20197;&#24448;&#37324;&#38754;&#32487;&#32493;&#22797;&#21046;&#25968;&#25454;&#12290;&#25110;&#32773;&#21457;&#36865;&#30340;&#26159;OOB&#25968;&#25454;&#65292;&#21017;&#20063;&#36339;&#36807;&#21457;&#36865;&#36807;&#31243;&#65292;&#32487;&#32493;&#22797;&#21046;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">186:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span> <span style="color: #8b6508;">!=</span> mss_now <span style="color: #8b6508;">||</span> <span style="color: #cd2626;">(</span>flags <span style="color: #8b6508;">&amp;</span> MSG_OOB<span style="color: #cd2626;">))</span>
<span class="linenr">187:  </span>                <span style="color: #a020f0;">continue</span><span style="color: #8b6508;">;</span>
<span class="linenr">188:  </span>
<span class="linenr">189:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">forced_push</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24517;&#39035;&#31435;&#21363;&#21457;&#36865;&#25968;&#25454;&#65292;&#21363;&#19978;&#27425;&#21457;&#36865;&#21518;&#20135;&#29983;&#30340;&#25968;&#25454;&#24050;&#32463;&#36229;&#36807;&#36890;&#21578;&#31383;&#21475;&#20540;&#30340;&#19968;&#21322; </span><span style="color: #b22222;">*/</span>
<span class="linenr">190:  </span>                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;PSH&#26631;&#24535;&#21518;&#21457;&#36865;&#25968;&#25454; </span><span style="color: #b22222;">*/</span>
<span class="linenr">191:  </span>                <span style="color: #008000; font-weight: bold;">tcp_mark_push</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">192:  </span>                <span style="color: #008000; font-weight: bold;">__tcp_push_pending_frames</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> mss_now<span style="color: #8b6508;">,</span> TCP_NAGLE_PUSH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">193:  </span>            <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>skb <span style="color: #8b6508;">==</span> sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span><span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#34429;&#28982;&#19981;&#26159;&#24517;&#39035;&#21457;&#36865;&#25968;&#25454;&#65292;&#20294;&#26159;&#21457;&#36865;&#38431;&#21015;&#19978;&#21482;&#23384;&#22312;&#24403;&#21069;&#27573;&#65292;&#20063;&#23558;&#20854;&#21457;&#36865;&#20986;&#21435; </span><span style="color: #b22222;">*/</span>
<span class="linenr">194:  </span>                <span style="color: #008000; font-weight: bold;">tcp_push_one</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> mss_now<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">195:  </span>            <span style="color: #a020f0;">continue</span><span style="color: #8b6508;">;</span>
<span class="linenr">196:  </span>
<span class="linenr">197:  </span><span style="color: #008b8b;">wait_for_sndbuf</span><span style="color: #8b6508;">:</span>
<span class="linenr">198:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30001;&#20110;&#21457;&#36865;&#38431;&#21015;&#28385;&#30340;&#21407;&#22240;&#23548;&#33268;&#31561;&#24453; </span><span style="color: #b22222;">*/</span>
<span class="linenr">199:  </span>            <span style="color: #008000; font-weight: bold;">set_bit</span><span style="color: #cd2626;">(</span>SOCK_NOSPACE<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_socket</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">flags</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">200:  </span><span style="color: #008b8b;">wait_for_memory</span><span style="color: #8b6508;">:</span>
<span class="linenr">201:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copied<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#34429;&#28982;&#27809;&#26377;&#20869;&#23384;&#20102;&#65292;&#20294;&#26159;&#26412;&#27425;&#35843;&#29992;&#22797;&#21046;&#20102;&#25968;&#25454;&#21040;&#32531;&#20914;&#21306;&#65292;&#35843;&#29992;tcp_push&#23558;&#20854;&#21457;&#36865;&#20986;&#21435; </span><span style="color: #b22222;">*/</span>
<span class="linenr">202:  </span>                <span style="color: #008000; font-weight: bold;">tcp_push</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> flags <span style="color: #8b6508;">&amp;</span> <span style="color: #8b6508;">~</span>MSG_MORE<span style="color: #8b6508;">,</span> mss_now<span style="color: #8b6508;">,</span> TCP_NAGLE_PUSH<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">203:  </span>
<span class="linenr">204:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#31561;&#24453;&#20869;&#23384;&#21487;&#29992; </span><span style="color: #b22222;">*/</span>
<span class="linenr">205:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_wait_memory</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>timeo<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">!=</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span>
<span class="linenr">206:  </span>                <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30830;&#23454;&#27809;&#26377;&#20869;&#23384;&#20102;&#65292;&#36229;&#26102;&#21518;&#36820;&#22238;&#22833;&#36133; </span><span style="color: #b22222;">*/</span>
<span class="linenr">207:  </span>
<span class="linenr">208:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#30561;&#30496;&#21518;&#65292;MSS&#21487;&#33021;&#21457;&#29983;&#20102;&#21464;&#21270;&#65292;&#37325;&#26032;&#35745;&#31639; </span><span style="color: #b22222;">*/</span>
<span class="linenr">209:  </span>            mss_now <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_mss</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> !<span style="color: #cd2626;">(</span>flags<span style="color: #8b6508;">&amp;</span>MSG_OOB<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">210:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">211:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">212:  </span>
<span class="linenr">213:  </span><span style="color: #008b8b;">out</span><span style="color: #8b6508;">:</span>
<span class="linenr">214:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copied<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20174;&#29992;&#25143;&#24577;&#22797;&#21046;&#20102;&#25968;&#25454;&#65292;&#21457;&#36865;&#23427; </span><span style="color: #b22222;">*/</span>
<span class="linenr">215:  </span>        <span style="color: #008000; font-weight: bold;">tcp_push</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> mss_now<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">nonagle</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">216:  </span>    <span style="color: #008000; font-weight: bold;">TCP_CHECK_TIMER</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">217:  </span>    <span style="color: #008000; font-weight: bold;">release_sock</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37322;&#25918;&#38145;&#20197;&#21518;&#36820;&#22238; </span><span style="color: #b22222;">*/</span>
<span class="linenr">218:  </span>    <span style="color: #a020f0;">return</span> copied<span style="color: #8b6508;">;</span>
<span class="linenr">219:  </span>
<span class="linenr">220:  </span><span style="color: #008b8b;">do_fault</span><span style="color: #8b6508;">:</span>
<span class="linenr">221:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">len</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22797;&#21046;&#25968;&#25454;&#22833;&#36133;&#20102;&#65292;&#22914;&#26524;skb&#38271;&#24230;&#20026;0&#65292;&#35828;&#26126;&#26159;&#26032;&#20998;&#37197;&#30340;&#65292;&#37322;&#25918;&#23427; </span><span style="color: #b22222;">*/</span>
<span class="linenr">222:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span> <span style="color: #8b6508;">==</span> skb<span style="color: #cd2626;">)</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;skb&#26159;&#21457;&#36865;&#38431;&#21015;&#22836;&#65292;&#21017;&#28165;&#31354;&#38431;&#21015;&#22836; </span><span style="color: #b22222;">*/</span>
<span class="linenr">223:  </span>            sk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sk_send_head</span> <span style="color: #8b6508;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #8b6508;">;</span>
<span class="linenr">224:  </span>        <span style="color: #008000; font-weight: bold;">__skb_unlink</span><span style="color: #cd2626;">(</span>skb<span style="color: #8b6508;">,</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">list</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">225:  </span>        <span style="color: #008000; font-weight: bold;">sk_stream_free_skb</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37322;&#25918;skb </span><span style="color: #b22222;">*/</span>
<span class="linenr">226:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">227:  </span>
<span class="linenr">228:  </span><span style="color: #008b8b;">do_error</span><span style="color: #8b6508;">:</span>
<span class="linenr">229:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>copied<span style="color: #cd2626;">)</span>
<span class="linenr">230:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span><span style="color: #8b6508;">;</span>
<span class="linenr">231:  </span><span style="color: #008b8b;">out_err</span><span style="color: #8b6508;">:</span>
<span class="linenr">232:  </span>    err <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">sk_stream_error</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flags<span style="color: #8b6508;">,</span> err<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">233:  </span>    <span style="color: #008000; font-weight: bold;">TCP_CHECK_TIMER</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">234:  </span>    <span style="color: #008000; font-weight: bold;">release_sock</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">235:  </span>    <span style="color: #a020f0;">return</span> err<span style="color: #8b6508;">;</span>
<span class="linenr">236:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>


<p>    <br/>
</p>
<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> 服务端响应请求</h3>
<div class="outline-text-3" id="text-5-2">

<ul>
<li>由tcp_v4_do_rcv()-&gt;tcp_rcv_established().当前服务端处于TCP_ESTABLISHED状态。<br/>
</li>
<li>代码关键路径:<br/>
</li>
</ul>


<p>     <br/>
</p></div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> 第25章 传输控制块</h2>
<div class="outline-text-2" id="text-6">


</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> 25.4 传输控制块的内存管理</h3>
<div class="outline-text-3" id="text-6-1">


</div>

<div id="outline-container-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> 25.4.4 接收缓存的分配与释放</h4>
<div class="outline-text-4" id="text-6-1-1">

<p>    书上说到设置该skb的sk宿主时TCP使用sk_stream_set_owner_r(),而到内核kernel-2.6.32中，<br/>
    TCP和UDP统一使用skb_set_owner_r().<br/>
</p>
<p><br/>
</p></div>
</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> 第29章 拥塞控制</h2>
<div class="outline-text-2" id="text-7">


</div>

<div id="outline-container-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> 拥塞状态</h3>
<div class="outline-text-3" id="text-7-1">

<ol>
<li>TCP_CA_Open <br/>
    这个状态是也就是初始状态，我们可以看到在tcp_create_openreq_child(这个函数的意思可以看我前面的blog)中，<br/>
    当我们new一个新的socket之后就会设置这个socket的状态为TCP_CA_Open。这个也可以说是fast path。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_Disorder <br/>
    当发送者检测到重复的ack或者sack就进入这个状态。在这个状态，拥塞窗口不会被调整，但是这个状态下的话，<br/>
    每一次新的输入数据包都会触发一个新的端的传输。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_CWR <br/>
    这个状态叫做 (Congestion Window Reduced),顾名思义，也就是当拥塞窗口减小的时候会进入这个状态。<br/>
    比如当发送者收到一个ECN，此时就需要减小窗口。这个状态能够被Recovery or Loss 所打断。当接收到一个拥塞提醒的时候，<br/>
    发送者是每接收到一个ack，就减小拥塞窗口一个段，直到窗口大小减半。因此可以这么说当发送者正在减小窗口并且没有任何重传段的时候，<br/>
    就会处于CWR状态。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_Recovery <br/>
    当足够数量的(一般是3个)的连续的重复ack到达发送端，则发送端立即重传第一个没有被ack的数据段，然后进入这个状态。<br/>
    处于这个状态的时候，发送者也是和CWR状态类似，每次接收到ack后减小窗口。在这个状态，拥塞窗口不会增长，发送者要么重传标记lost的段，<br/>
    要么传输新的段。当发送者进入这个状态时的没有被ack的段全部ack之后就离开这个状态。 <br/>

<p><br/>
</p></li>
<li>TCP_CA_Loss <br/>
    当RTO超时后，发送者就进入这个状态。此时所有的没有被ack的段都标记为loss，然后降低窗口大小为1,然后进入慢开始阶段。<br/>
    loss状态不能被其他状态所中断。而这个状态的退出只有当进入loss时，所有的被标记为loss的段都得到ack后，才会再次返回open状态。<br/>
</li>
</ol>

</div>

</div>

<div id="outline-container-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> cwnd初始值</h3>
<div class="outline-text-3" id="text-7-2">

<ul>
<li>客户端初始化是在发送syn包后接收到syn/ack包时处于SYN_SENT状态下进行初始化的。<br/>
     tcp_rcv_synsent_state_process<sup><a class="footref" name="fnr-.1" href="#fn-.1">1</a></sup> tcp_init_metrics(sk);<br/>
</li>
<li>服务端初始化是在接收到syn包处于SYN_RECV状态下初始化的。<br/>
</li>
</ul>

<p>　　　tcp_rcv_state_process<sup><a class="footref" name="fnr-.2" href="#fn-.2">2</a></sup>    tcp_init_metrics(sk);　　<br/>
</p><ul>
<li>tcp_init_metrics()调用tcp_init_cwnd().<br/>
     tp-&gt;snd_cwnd = tcp_init_cwnd(tp, dst);<br/>
</li>
<li>tcp_init_cwnd()里实现取路由里设置的cwnd，TCP_INIT_CWND与tp-&gt;snd_cwnd_clamp取最小值。<br/>

<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #228b22;">__u32</span> <span style="color: #0000ff; font-size: 120%;">tcp_init_cwnd</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">dst_entry</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">dst</span><span style="color: #cd2626;">)</span>
<span class="linenr">2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">3:  </span>     <span style="color: #228b22;">__u32</span> <span style="color: #a0522d;">cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span>dst ? <span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_INITCWND<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">:</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">4:  </span>
<span class="linenr">5:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!cwnd<span style="color: #cd2626;">)</span>
<span class="linenr">6:  </span>         cwnd <span style="color: #8b6508;">=</span> TCP_INIT_CWND<span style="color: #8b6508;">;</span>
<span class="linenr">7:  </span>     <span style="color: #a020f0;">return</span> <span style="color: #228b22;">min_t</span><span style="color: #cd2626;">(</span>__u32<span style="color: #8b6508;">,</span> cwnd<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_clamp</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">8:  </span><span style="color: #cd2626;">}</span>
</pre>

     [注]: 目前centos 6.2里kernel-2.6.32的TCP_INIT_CWND值为10.<br/>

</p>
<hr/>
<p>
     *** include/net/tcp.h:<br/>
     TCP_INIT_CWND<sup><a class="footref" name="fnr-.3" href="#fn-.3">3</a></sup>             #define TCP_INIT_CWND 10<br/>

</p>
<hr/>
<ul>
<li>tp-&gt;snd_cwnd_clamp为允许的最大拥塞窗口值，初始值为65535。<br/>
       它通过tcp_v4_init_sock()里调用:<br/>
        tp-&gt;snd_cwnd_clamp = ~0;<br/>
       实现，其类型为u16.<br/>
</li>
</ul>

</li>
</ul>


<p><br/>

</p>
<hr/>
<p>
   *** net/ipv4/tcp_input.c:<br/>
   tcp_rcv_synsent_state_process<sup><a class="footref" name="fnr-.1.2" href="#fn-.1">1</a></sup> tcp_init_metrics(sk);<br/>
   tcp_rcv_state_process<sup><a class="footref" name="fnr-.2.2" href="#fn-.2">2</a></sup>    tcp_init_metrics(sk);<br/>

</p>
<hr/>

<p><br/>
</p></div>

</div>

<div id="outline-container-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> 慢启动</h3>
<div class="outline-text-3" id="text-7-3">


</div>

<div id="outline-container-7-3-1" class="outline-4">
<h4 id="sec-7-3-1"><span class="section-number-4">7.3.1</span> 连接建立时</h4>
<div class="outline-text-4" id="text-7-3-1">

<p>    在建立连接时，做为服务器端会通过tcp_v4_do_rcv（）－－》tcp_v4_hnd_req（）－－》tcp_che <br/>
    ck_req（）－－－》inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sock（） <br/>
    ，即tcp_v4_syn_recv_sock（）－－》tcp_create_openreq_child（）来将新的连接设为TCP_CA_Open状态。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #0000ff; font-size: 120%;">tcp_create_openreq_child</span><span style="color: #cd2626;">(</span>&#65289;
<span class="linenr"> 2:  </span>&#65371;
<span class="linenr"> 3:  </span>        <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span>newsk <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk_clone</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> req<span style="color: #8b6508;">,</span> GFP_ATOMIC<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>newsk <span style="color: #8b6508;">!=</span> <span style="color: #008b8b;">NULL</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 6:  </span>    <span style="color: #8b6508;">.....</span>
<span class="linenr"> 7:  </span>        <span style="color: #008000; font-weight: bold;">tcp_set_ca_state</span><span style="color: #cd2626;">(</span>newsk<span style="color: #8b6508;">,</span> TCP_CA_Open<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>    <span style="color: #8b6508;">.....</span>
<span class="linenr"> 9:  </span>        &#65373;
<span class="linenr">10:  </span>
<span class="linenr">11:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">12:  </span>
</pre>


    至于客户端，没有发现显式的设置TCP_CA_Open状态的语句，但TCP_CA_Open等于0，在创建SOCK结 <br/>
    故,就被全初始化为0了，所以在建好连接时，客户端也应该是TCP_CA_Open状态。     <br/>
</p>
<p>    <br/>
</p></div>

</div>

<div id="outline-container-7-3-2" class="outline-4">
<h4 id="sec-7-3-2"><span class="section-number-4">7.3.2</span> tcp_ack()</h4>
<div class="outline-text-4" id="text-7-3-2">

<p>    这个函数主要功能是： <br/>
    1 update重传队列，并基于sack来设置skb的相关buf。 <br/>
    2 update发送窗口。 <br/>
    3 基于sack的信息或者重复ack来决定是否进入拥塞模式。<br/>
</p></div>

</div>

<div id="outline-container-7-3-3" class="outline-4">
<h4 id="sec-7-3-3"><span class="section-number-4">7.3.3</span> 拥塞控制入口</h4>
<div class="outline-text-4" id="text-7-3-3">

<p>    每接收到一个传输数据包的响应ack包进入tcp_cong_avoid()中判读该进行慢启动还是拥塞避免处理流程。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_ack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_ack_is_dubious</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 4:  </span>         <span style="color: #b22222;">/* </span><span style="color: #b22222;">Advance CWND, if state allows this. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 5:  </span>         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_DATA_ACKED<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> !frto_cwnd <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 6:  </span>             <span style="color: #008000; font-weight: bold;">tcp_may_raise_cwnd</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">))</span>
<span class="linenr"> 7:  </span>             <span style="color: #008000; font-weight: bold;">tcp_cong_avoid</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> ack<span style="color: #8b6508;">,</span> prior_in_flight<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>         <span style="color: #008000; font-weight: bold;">tcp_fastretrans_alert</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> prior_packets <span style="color: #8b6508;">-</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 9:  </span>                       flag<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>     <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">11:  </span>         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_DATA_ACKED<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> !frto_cwnd<span style="color: #cd2626;">)</span>
<span class="linenr">12:  </span>             <span style="color: #008000; font-weight: bold;">tcp_cong_avoid</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> ack<span style="color: #8b6508;">,</span> prior_in_flight<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>     <span style="color: #cd2626;">}</span>
<span class="linenr">14:  </span><span style="color: #cd2626;">}</span>
</pre>


</p></div>

</div>

<div id="outline-container-7-3-4" class="outline-4">
<h4 id="sec-7-3-4"><span class="section-number-4">7.3.4</span> snd_ssthresh设置</h4>
<div class="outline-text-4" id="text-7-3-4">

<p>    这个值在加载cubic模块的时候可以传递一个我们制定的值给它，不过，默认是很大的值，我这里是2147483647,然后在接收ack期间(slow start)期间会调整这个值，<br/>
    在cubic中，默认是16（一般来说说当拥塞窗口到达16的时候，snd_ssthresh会被设置为16).<br/>
    在cubic中有两个可以设置snd_ssthresh的地方一个是hystart_update，一个是bictcp_recalc_ssthresh，后一个我这里就不介绍了，以后介绍拥塞状态机的时候<br/>
    会详细介绍，现在只需要知道，只有遇到拥塞的时候，需要调整snd_ssthres的时候，我们才需要调用bictcp_recalc_ssthresh。<br/>
    而hystart_update是在bictcp_acked中被调用，而bictcp_acked则是基本每次收到ack都会调用这个函数，我们来看在bictcp_acked中什么情况就会调用<br/>
    hystart_update：<br/>
    调用关系: tcp_ack() &ndash;&gt; tcp_clean_rtx_queue() &ndash;&gt; ca_ops-&gt;pkts_acked() &ndash;&gt; bictcp_acked().<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">hystart triggers when cwnd is larger than some threshold </span><span style="color: #b22222;">*/</span>
<span class="linenr">2:  </span><span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>hystart <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&lt;=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">3:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;=</span> hystart_low_window<span style="color: #cd2626;">)</span>
<span class="linenr">4:  </span>    <span style="color: #008000; font-weight: bold;">hystart_update</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> delay<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
</pre>

    其中hystart是hybrid slow start打开的标志，默认是开启，hystart_low_window是设置snd_ssthresh的最小拥塞窗口值，默认是16。而tp-&gt;snd_ssthresh默认<br/>
    是一个很大的值，因此这里就知道了，当拥塞窗口增大到16的时候我们就会进去hystart_update来更新snd_ssthresh.因此hystart_updat换句话来说也就是主要用于<br/>
    是否退出slow start。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">hystart_low_window</span> __read_mostly <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">16</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 2:  </span><span style="color: #008000; font-weight: bold;">module_param</span><span style="color: #cd2626;">(</span>hystart_low_window<span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span><span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0644</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 3:  </span><span style="color: #008000; font-weight: bold;">MODULE_PARM_DESC</span><span style="color: #cd2626;">(</span>hystart_low_window<span style="color: #8b6508;">,</span> <span style="color: #8b2252;">"lower bound cwnd for hybrid slow start"</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">hystart_update</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">delay</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 6:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">bictcp</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">ca</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk_ca</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 9:  </span>
<span class="linenr">10:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>ca<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">found</span> <span style="color: #8b6508;">&amp;</span> hystart_detect<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr">11:  </span><span style="color: #8b6508;">.................................................................</span>
<span class="linenr">12:  </span>        <span style="color: #b22222;">/*</span>
<span class="linenr">13:  </span><span style="color: #b22222;">         * Either one of two conditions are met,</span>
<span class="linenr">14:  </span><span style="color: #b22222;">         * we exit from slow start immediately.</span>
<span class="linenr">15:  </span><span style="color: #b22222;">         </span><span style="color: #b22222;">*/</span>
<span class="linenr">16:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">found&#26159;&#19968;&#20010;&#26159;&#21542;&#36864;&#20986;slow start&#30340;&#26631;&#35760;</span>
<span class="linenr">17:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ca<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">found</span> <span style="color: #8b6508;">&amp;</span> hystart_detect<span style="color: #cd2626;">)</span>
<span class="linenr">18:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#35774;&#32622;snd_ssthresh</span>
<span class="linenr">19:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">21:  </span><span style="color: #cd2626;">}</span>
</pre>

</p>
<p>    <br/>
    然后是slow start的处理,这里有关abc的处理，注释都很详细了，这里就不解释了，我们主要看abc关闭的部分。这里使用cnt，也是主要为了打开abc之后的slow start。<br/>
    这是abc（Appropriate Byte Counting）相关的rfc：<br/>
</p>
<p><br/>
</p></div>

</div>

<div id="outline-container-7-3-5" class="outline-4">
<h4 id="sec-7-3-5"><span class="section-number-4">7.3.5</span> snd_cwnd_clamp设置</h4>
<div class="outline-text-4" id="text-7-3-5">

<p>    关于snd_cwnd_clamp变量，在《linux内核源码剖析——TCP/IP实现（下册）》p717，讲到：snd_cwnd_clamp是允许的拥塞窗口最大值，初始值为65535，之后再接收SYN和ACK段时，<br/>
    会根据条件确定是否从路由配置项读取信息更新该字段，最后在TCP连接复位前，将更新后的值根据某种算法计算后再更新回相对应的路由配置项中，便于连接使用。<br/>
</p>
</div>

<div id="outline-container-7-3-5-1" class="outline-5">
<h5 id="sec-7-3-5-1"><span class="section-number-5">7.3.5.1</span> 初始值后第一次修改</h5>
<div class="outline-text-5" id="text-7-3-5-1">

<p>     啥时候第一次修改的路由配置项还不清楚。<br/>
</p>
<p><br/>
</p></div>

</div>

<div id="outline-container-7-3-5-2" class="outline-5">
<h5 id="sec-7-3-5-2"><span class="section-number-5">7.3.5.2</span> 连接复位前更新</h5>
<div class="outline-text-5" id="text-7-3-5-2">

<ul>
<li>客户端<br/>
<ul>
<li>调用关系： tcp_time_wait() &ndash;&gt; tcp_update_metrics().<br/>

<hr/>
        *** net/ipv4/tcp.c:<br/>
        tcp_close<sup><a class="footref" name="fnr-.4" href="#fn-.4">4</a></sup>                tcp_time_wait(sk, TCP_FIN_WAIT2, tmo);<br/>

<p>         <br/>
        *** net/ipv4/tcp_input.c:<br/>
        tcp_fin<sup><a class="footref" name="fnr-.5" href="#fn-.5">5</a></sup>                  tcp_time_wait(sk, TCP_TIME_WAIT, 0);<br/>
        tcp_rcv_state_process<sup><a class="footref" name="fnr-.6" href="#fn-.6">6</a></sup>    tcp_time_wait(sk, TCP_FIN_WAIT2, tmo);<br/>
        tcp_rcv_state_process<sup><a class="footref" name="fnr-.7" href="#fn-.7">7</a></sup>    tcp_time_wait(sk, TCP_TIME_WAIT, 0);<br/>
</p>
<p>         <br/>
        *** net/ipv4/tcp_timer.c:<br/>
        tcp_keepalive_timer<sup><a class="footref" name="fnr-.8" href="#fn-.8">8</a></sup>       tcp_time_wait(sk, TCP_FIN_WAIT2, tmo);<br/>

</p>
<hr/>
</li>
<li>更新时机：  <br/>
</li>
</ul>

<p>      *** net/ipv4/tcp_minisocks.c:<br/>
      tcp_time_wait<sup><a class="footref" name="fnr-.9" href="#fn-.9">9</a></sup>             tcp_update_metrics(sk);<br/>
</p></li>
<li>服务端<br/>
<ul>
<li>调用关系： tcp_ack() -&gt;  tcp_rcv_state_process() &ndash;&gt; tcp_update_metrics();<br/>
</li>
<li>更新时机：<br/>
</li>
</ul>

<p>      *** net/ipv4/tcp_input.c:<br/>
      tcp_rcv_state_process<sup><a class="footref" name="fnr-.10" href="#fn-.10">10</a></sup>    tcp_update_metrics(sk);<br/>
</p></li>
</ul>


<p>      <br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_update_metrics</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span><span style="color: #8b6508;">......</span>
<span class="linenr"> 4:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_in_initial_slowstart</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 5:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Slow start still did not finish. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_SSTHRESH<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 7:  </span>                !<span style="color: #008000; font-weight: bold;">dst_metric_locked</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_SSTHRESH<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 8:  </span>                <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;&gt;</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_SSTHRESH<span style="color: #cd2626;">))</span>
<span class="linenr"> 9:  </span>                dst<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">metrics</span><span style="color: #cd2626;">[</span>RTAX_SSTHRESH<span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;&gt;</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">dst_metric_locked</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_CWND<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">11:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_CWND<span style="color: #cd2626;">))</span>
<span class="linenr">12:  </span>                dst<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">metrics</span><span style="color: #cd2626;">[</span>RTAX_CWND <span style="color: #8b6508;">-</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>        <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">14:  </span>               icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">==</span> TCP_CA_Open<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">15:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Cong. avoidance phase, cwnd is reliable. </span><span style="color: #b22222;">*/</span>
<span class="linenr">16:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">dst_metric_locked</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_SSTHRESH<span style="color: #cd2626;">))</span>
<span class="linenr">17:  </span>                dst<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">metrics</span><span style="color: #cd2626;">[</span>RTAX_SSTHRESH<span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span> <span style="color: #8b6508;">=</span>
<span class="linenr">18:  </span>                    <span style="color: #008000; font-weight: bold;">max</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;&gt;</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">19:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">dst_metric_locked</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_CWND<span style="color: #cd2626;">))</span>
<span class="linenr">20:  </span>                dst<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">metrics</span><span style="color: #cd2626;">[</span>RTAX_CWND<span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span> <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_CWND<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;&gt;</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>        <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">22:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Else slow start did not finish, cwnd is non-sense,</span>
<span class="linenr">23:  </span><span style="color: #b22222;">               ssthresh may be also invalid.</span>
<span class="linenr">24:  </span><span style="color: #b22222;">             </span><span style="color: #b22222;">*/</span>
<span class="linenr">25:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">dst_metric_locked</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_CWND<span style="color: #cd2626;">))</span>
<span class="linenr">26:  </span>                dst<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">metrics</span><span style="color: #cd2626;">[</span>RTAX_CWND<span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span> <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_CWND<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;&gt;</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_SSTHRESH<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">28:  </span>                !<span style="color: #008000; font-weight: bold;">dst_metric_locked</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_SSTHRESH<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">29:  </span>                tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #008000; font-weight: bold;">dst_metric</span><span style="color: #cd2626;">(</span>dst<span style="color: #8b6508;">,</span> RTAX_SSTHRESH<span style="color: #cd2626;">))</span>
<span class="linenr">30:  </span>                dst<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">metrics</span><span style="color: #cd2626;">[</span>RTAX_SSTHRESH<span style="color: #8b6508;">-</span><span style="color: #ff0000;">1</span><span style="color: #cd2626;">]</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">32:  </span><span style="color: #8b6508;">......</span>      
<span class="linenr">33:  </span><span style="color: #cd2626;">}</span>       
</pre>

    </div>
</p>
<p>     <br/>
</p>
<p>    <br/>
</p></div>
</div>

</div>

<div id="outline-container-7-3-6" class="outline-4">
<h4 id="sec-7-3-6"><span class="section-number-4">7.3.6</span> 拥塞控制实现</h4>
<div class="outline-text-4" id="text-7-3-6">


<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">bictcp_cong_avoid</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">ack</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">in_flight</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">bictcp</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">ca</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk_ca</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>    <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21028;&#26029;&#21457;&#36865;&#25317;&#22622;&#31383;&#21475;&#26159;&#21542;&#21040;&#36798;&#38480;&#21046;&#65292;&#22914;&#26524;&#21040;&#36798;&#38480;&#21046;&#21017;&#30452;&#25509;&#36820;&#22238;&#12290;</span>
<span class="linenr"> 6:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">tcp_is_cwnd_limited</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> in_flight<span style="color: #cd2626;">))</span>
<span class="linenr"> 7:  </span>        <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>    <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24320;&#22987;&#20915;&#23450;&#36827;&#20837;slow start&#36824;&#26159;&#25317;&#22622;&#25511;&#21046;&#29366;&#24577;</span>
<span class="linenr"> 9:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&lt;=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">10:  </span>        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#26159;&#21542;&#38656;&#35201;reset&#23545;&#24212;&#30340;bictcp&#30340;&#20540;</span>
<span class="linenr">11:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>hystart <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">after</span><span style="color: #cd2626;">(</span>ack<span style="color: #8b6508;">,</span> ca<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span><span style="color: #cd2626;">))</span>
<span class="linenr">12:  </span>            <span style="color: #008000; font-weight: bold;">bictcp_hystart_reset</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36827;&#20837;slow start&#29366;&#24577;</span>
<span class="linenr">14:  </span>        <span style="color: #008000; font-weight: bold;">tcp_slow_start</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">16:  </span>        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36827;&#20837;&#25317;&#22622;&#36991;&#20813;&#29366;&#24577;&#65292;&#39318;&#20808;&#20250;&#26356;&#26032;ca-&gt;cnt.</span>
<span class="linenr">17:  </span>        <span style="color: #008000; font-weight: bold;">bictcp_update</span><span style="color: #cd2626;">(</span>ca<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#28982;&#21518;&#36827;&#20837;&#25317;&#22622;&#36991;&#20813;</span>
<span class="linenr">19:  </span>        <span style="color: #008000; font-weight: bold;">tcp_cong_avoid_ai</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> ca<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">cnt</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">21:  </span><span style="color: #cd2626;">}</span>
</pre>


</p></div>

</div>

<div id="outline-container-7-3-7" class="outline-4">
<h4 id="sec-7-3-7"><span class="section-number-4">7.3.7</span> 慢启动算法</h4>
<div class="outline-text-4" id="text-7-3-7">


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_slow_start</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">cnt</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">increase in packets </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">RFC3465: ABC Slow start</span>
<span class="linenr"> 6:  </span><span style="color: #b22222;">     * Increase only after a full MSS of bytes is acked</span>
<span class="linenr"> 7:  </span><span style="color: #b22222;">     *</span>
<span class="linenr"> 8:  </span><span style="color: #b22222;">     * TCP sender SHOULD increase cwnd by the number of</span>
<span class="linenr"> 9:  </span><span style="color: #b22222;">     * previously unacknowledged bytes ACKed by each incoming</span>
<span class="linenr">10:  </span><span style="color: #b22222;">     * acknowledgment, provided the increase is not more than L</span>
<span class="linenr">11:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">12:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sysctl_tcp_abc <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">bytes_acked</span> <span style="color: #8b6508;">&lt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">mss_cache</span><span style="color: #cd2626;">)</span>
<span class="linenr">13:  </span>        <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
<span class="linenr">14:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#38480;&#21046;slow start&#30340;cnt</span>
<span class="linenr">15:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sysctl_tcp_max_ssthresh <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">0</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;</span> sysctl_tcp_max_ssthresh<span style="color: #cd2626;">)</span>
<span class="linenr">16:  </span>        cnt <span style="color: #8b6508;">=</span> sysctl_tcp_max_ssthresh <span style="color: #8b6508;">&gt;&gt;</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>   <span style="color: #b22222;">/* </span><span style="color: #b22222;">limited slow start </span><span style="color: #b22222;">*/</span>
<span class="linenr">17:  </span>    <span style="color: #a020f0;">else</span>
<span class="linenr">18:  </span>        cnt <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">;</span>          <span style="color: #b22222;">/* </span><span style="color: #b22222;">exponential increase </span><span style="color: #b22222;">*/</span>
<span class="linenr">19:  </span>
<span class="linenr">20:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">RFC3465: ABC</span>
<span class="linenr">21:  </span><span style="color: #b22222;">     * We MAY increase by 2 if discovered delayed ack</span>
<span class="linenr">22:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">23:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sysctl_tcp_abc <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">1</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">bytes_acked</span> <span style="color: #8b6508;">&gt;=</span> <span style="color: #ff0000;">2</span><span style="color: #8b6508;">*</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">mss_cache</span><span style="color: #cd2626;">)</span>
<span class="linenr">24:  </span>        cnt <span style="color: #8b6508;">&lt;&lt;=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">25:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">bytes_acked</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">26:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#26356;&#26032;cnt&#65292;&#20063;&#23601;&#26159;&#24403;&#21069;&#25317;&#22622;&#31383;&#21475;&#25509;&#21463;&#30340;&#27573;&#30340;&#20010;&#25968;.</span>
<span class="linenr">27:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">+=</span> cnt<span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>    <span style="color: #a020f0;">while</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">&gt;=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">29:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#36825;&#37324;snd_cwnd_cnt&#26159;snd_cwnd&#30340;&#20960;&#20493;&#65292;&#25317;&#22622;&#31383;&#21475;&#23601;&#22686;&#21152;&#20960;&#12290;</span>
<span class="linenr">30:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">-=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#25317;&#22622;&#31383;&#21475;&#27809;&#26377;&#36229;&#36807;&#26368;&#22823;&#20540;&#65292;&#21017;&#21152;&#19968;</span>
<span class="linenr">32:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&lt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_clamp</span><span style="color: #cd2626;">)</span>
<span class="linenr">33:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">++;</span>
<span class="linenr">34:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">35:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>

</div>

</div>

<div id="outline-container-7-3-8" class="outline-4">
<h4 id="sec-7-3-8"><span class="section-number-4">7.3.8</span> 备注</h4>
<div class="outline-text-4" id="text-7-3-8">

<p>    这里着重解释一下，cwnd的指数增长是如何进行的，所有的文献中都会提到，cwnd在一个RTT内会翻倍，这里看到的源码似乎不是这样，而是接收一个ACK就加一。<br/>
    这里疑惑了一下，接收一个ACK的时间不就是RTT吗？其实不是的，一个cwnd内的包是一起发送的，之间相关的时间很短，只和带宽有关，ACK也是连续返回的，<br/>
    一个cwnd内的所有ACK都返回了才算是一个RTT。每返回一个ACK，cwnd就加一，那等所有ACK都返回了，cwnd也就翻倍了。<br/>
</p>
<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> 拥塞避免</h3>
<div class="outline-text-3" id="text-7-4">


</div>

<div id="outline-container-7-4-1" class="outline-4">
<h4 id="sec-7-4-1"><span class="section-number-4">7.4.1</span> 拥塞避免算法</h4>
<div class="outline-text-4" id="text-7-4-1">

<p>    通过判断当前的拥塞窗口下已经发送的数据段的个数是否大于算法计算出来的值w，如果大于我们才能增加拥塞窗口值，否则之需要增加snd_cwnd_cnt。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_cong_avoid_ai</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">w</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#21028;&#26029;&#26159;&#21542;&#22823;&#20110;&#25105;&#20204;&#30340;&#26631;&#35760;&#20540;</span>
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">&gt;=</span> w<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 5:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&lt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_clamp</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 6:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">++;</span>
<span class="linenr"> 7:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 9:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22686;&#21152;&#35745;&#25968;&#20540;</span>
<span class="linenr">10:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span><span style="color: #8b6508;">++;</span>
<span class="linenr">11:  </span><span style="color: #cd2626;">}</span>    
</pre>


</p></div>
</div>

</div>

<div id="outline-container-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> 快速重传</h3>
<div class="outline-text-3" id="text-7-5">

<p>   快速重传：tcp_ack中的丢包检测，即检测到连续3个重复ACK。<br/>
   超时重传是TCP协议保证数据可靠性的一个重要机制，其原理是在发送一个数据以后就开启一个计时器，<br/>
   在一定时间内如果没有得到发送数据报的ACK报文，那么就重新发送数据，直到发送成功为止。这是数据<br/>
   包丢失的情况下给出的一种修补机制。一般来说，重传发生在超时之后，但是如果发送端接收到3个以上<br/>
   的重复ACK，就应该意识到，数据丢了，需要重新传递。这个机制不需要等到重传定时器溢出，所以叫<br/>
   做快速重传，而快速重传以后，因为走的不是慢启动而是拥塞避免算法，所以这又叫做快速恢复算法。<br/>
   快速重传和快速恢复旨在：快速恢复丢失的数据包。<br/>
   没有快速重传和快速恢复，TCP将会使用定时器来要求传输暂停。在暂停这段时间内，没有新的数据包<br/>
   被发送。<br/>
</p>
</div>

<div id="outline-container-7-5-1" class="outline-4">
<h4 id="sec-7-5-1"><span class="section-number-4">7.5.1</span> 快速重传做的事情有：</h4>
<div class="outline-text-4" id="text-7-5-1">

<ol>
<li>把ssthresh设置为cwnd的一半<br/>
</li>
<li>把cwnd再设置为ssthresh的值(具体实现有些为ssthresh+3)<br/>
</li>
<li>重新进入拥塞避免阶段。<br/>
</li>
</ol>

</div>

</div>

<div id="outline-container-7-5-2" class="outline-4">
<h4 id="sec-7-5-2"><span class="section-number-4">7.5.2</span> 第一个重复的ACK</h4>
<div class="outline-text-4" id="text-7-5-2">

<p>    现在的TCP协议中默认都是支持SACK,FACK,D-SACK的 。用sysctl -a|grep ack 就可知道。 <br/>
    但具体到一个连接的支持情况还要看三次握手，只要双方都支持了SACK，FACK就会自动打开，只有有一方不支持SACK，连接就处于最基本的reno方法的拥塞控制。 <br/>
    FACK和SACK都是很好的东西，是对传统的RENO的改进，具体请看相应的RFC等。 <br/>
    下面试图分析一下《TCP／IP详解》的第21章的图21-7的情况下内核的实现，基于2.6.21。为了简化分析，现在只假设连接只支持RENO，以后会对FACK，SACK，D－SACK进行分析。<br/>
    抓包发现搜狐的服务器现在竟然不支持SACK！！<br/>
    假设已经在传输过程中，如图所示，第45个包丢失了。 <br/>
    下面分析第60个包的运行情况，只对slip端进行分析，下同：<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_ack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>     <span style="color: #8b6508;">......</span>
<span class="linenr"> 4:  </span>    u32 prior_snd_una <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">ack_seq</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">seq</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>    <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">ack</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ack_seq</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>         <span style="color: #8b6508;">....</span>
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>flag<span style="color: #8b6508;">&amp;</span>FLAG_SLOWPATH<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">after</span><span style="color: #cd2626;">(</span>ack<span style="color: #8b6508;">,</span> prior_snd_una<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span> <span style="color: #b22222;">// </span><span style="color: #b22222;">&lt;1&gt;</span>
<span class="linenr"> 9:  </span>     <span style="color: #8b6508;">....</span>
<span class="linenr">10:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">11:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ack_seq <span style="color: #8b6508;">!=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span><span style="color: #cd2626;">)</span>
<span class="linenr">12:  </span>            flag <span style="color: #8b6508;">|=</span> FLAG_DATA<span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>        <span style="color: #a020f0;">else</span>
<span class="linenr">14:  </span>            <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span>LINUX_MIB_TCPPUREACKS<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>
<span class="linenr">16:  </span>        flag <span style="color: #8b6508;">|=</span> <span style="color: #008000; font-weight: bold;">tcp_ack_update_window</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> ack<span style="color: #8b6508;">,</span> ack_seq<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;2&gt;</span>
<span class="linenr">17:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked</span><span style="color: #cd2626;">)</span>                              <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;3&gt;</span>
<span class="linenr">18:  </span>            flag <span style="color: #8b6508;">|=</span> <span style="color: #008000; font-weight: bold;">tcp_sacktag_write_queue</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> prior_snd_una<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">19:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_ECN_rcv_ecn_echo</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">h</span><span style="color: #8b6508;">.</span><span style="color: #008000;">th</span><span style="color: #cd2626;">))</span>
<span class="linenr">20:  </span>            flag <span style="color: #8b6508;">|=</span> FLAG_ECE<span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>
<span class="linenr">22:  </span>        <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_SLOW_ACK<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">24:  </span>&#65373;  
</pre>

    </div>
</p>
<p>    <br/>
    作为60这个包，这个tcp_ack()是通过tcp_rcv_established()的FAST <br/>
    PATH进去的，flag的值是0，ack的值是等于prior_snd_una，&lt;1&gt;处的判断使代码运行到&lt; <br/>
    2&gt;处，因为不支持SACK，所以&lt;3&gt;处不会进入，下面说一下&lt;2&gt;:<br/>
</p>
<p>    <br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_ack_update_window</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #8b6508;">,</span>
<span class="linenr"> 2:  </span>                 <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">ack</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">ack_seq</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 3:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 4:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">nwin</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">ntohs</span><span style="color: #cd2626;">(</span>skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">h</span><span style="color: #8b6508;">.</span><span style="color: #008000;">th</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">window</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">likely</span><span style="color: #cd2626;">(</span>!skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">h</span><span style="color: #8b6508;">.</span><span style="color: #008000;">th</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">syn</span><span style="color: #cd2626;">))</span>
<span class="linenr"> 8:  </span>        nwin <span style="color: #8b6508;">&lt;&lt;=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">rx_opt</span><span style="color: #8b6508;">.</span><span style="color: #008000;">snd_wscale</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 9:  </span>
<span class="linenr">10:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_may_update_window</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> ack<span style="color: #8b6508;">,</span> ack_seq<span style="color: #8b6508;">,</span> nwin<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>  <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;4&gt;</span>
<span class="linenr">11:  </span>        flag <span style="color: #8b6508;">|=</span> FLAG_WIN_UPDATE<span style="color: #8b6508;">;</span>                      <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;5&gt;</span>
<span class="linenr">12:  </span>    <span style="color: #8b6508;">............</span>
<span class="linenr">13:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">14:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">=</span> ack<span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>    <span style="color: #a020f0;">return</span> flag<span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">17:  </span>
<span class="linenr">18:  </span> <span style="color: #a020f0;">static</span> <span style="color: #a020f0;">inline</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_may_update_window</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">ack</span><span style="color: #8b6508;">,</span>
<span class="linenr">19:  </span>                    <span style="color: #a020f0;">const</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">ack_seq</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #228b22;">u32</span> <span style="color: #a0522d;">nwin</span><span style="color: #cd2626;">)</span>
<span class="linenr">20:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">21:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">after</span><span style="color: #cd2626;">(</span>ack<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">||</span>
<span class="linenr">22:  </span>        <span style="color: #008000; font-weight: bold;">after</span><span style="color: #cd2626;">(</span>ack_seq<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wl1</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">||</span>
<span class="linenr">23:  </span>        <span style="color: #cd2626;">(</span>ack_seq <span style="color: #8b6508;">==</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wl1</span> <span style="color: #8b6508;">&amp;&amp;</span> nwin <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_wnd</span><span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>   <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;6&gt;</span>
<span class="linenr">24:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>     <br/>
    &lt;4&gt;处是不会进入的除非，新的窗口比原来的大 <br/>
    ,见&lt;6&gt;，所以&lt;5&gt;处不会被运行，FLAG_WIN_UPDATE不会被置。<br/>
</p>
<p><br/>
   为了方便分析，假设新窗口不增大，FLAG_WIN_UPDATE不会被置。 <br/>
   回到tcp_ack().<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_ack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span><span style="color: #8b6508;">........................</span>
<span class="linenr"> 4:  </span>     flag <span style="color: #8b6508;">|=</span> <span style="color: #008000; font-weight: bold;">tcp_clean_rtx_queue</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #8b6508;">&amp;</span>seq_rtt<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>   <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;7&gt;</span>
<span class="linenr"> 5:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frto_counter</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 6:  </span>         <span style="color: #008000; font-weight: bold;">tcp_process_frto</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> prior_snd_una<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_ack_is_dubious</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>    <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;8&gt;</span>
<span class="linenr"> 8:  </span>         <span style="color: #b22222;">/* </span><span style="color: #b22222;">Advance CWND, if state allows this. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_DATA_ACKED<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">tcp_may_raise_cwnd</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">))</span><span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;9&gt;</span>
<span class="linenr">10:  </span>             <span style="color: #008000; font-weight: bold;">tcp_cong_avoid</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> ack<span style="color: #8b6508;">,</span>  seq_rtt<span style="color: #8b6508;">,</span> prior_in_flight<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">11:  </span>         <span style="color: #008000; font-weight: bold;">tcp_fastretrans_alert</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> prior_snd_una<span style="color: #8b6508;">,</span> prior_packets<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;10&gt;</span>
<span class="linenr">12:  </span>     <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">13:  </span>         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_DATA_ACKED<span style="color: #cd2626;">))</span>
<span class="linenr">14:  </span>             <span style="color: #008000; font-weight: bold;">tcp_cong_avoid</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> ack<span style="color: #8b6508;">,</span> seq_rtt<span style="color: #8b6508;">,</span> prior_in_flight<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>     <span style="color: #cd2626;">}</span>
<span class="linenr">16:  </span><span style="color: #8b6508;">.......................</span>
<span class="linenr">17:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>

   注意 tcp_ack_update_window（）中的 “tp-&gt;snd_una = ack”， <br/>
   &lt;7&gt;处是根据这种更新后进行的计算。 <br/>
   tcp_clean_rtx_queue（）主要是对来的ACK进行检查，看是否可以把已ACK的数据从发送队列 <br/>
   sk_write_queue中去掉，并返回FLAG_DATA_ACKED标志。 <br/>
   本情况下,不会任何操作就返回了，因为还不能从sk_write_queue中拿掉任何数据。 <br/>
</p>
<p>    <br/>
   根据目前的flag的情况，&lt;8&gt;处是肯定会进入的,具体请自行分析， <br/>
   &lt;9&gt;处flag不满足FLAG_DATA_ACKED，最后进入&lt;10&gt;。 <br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">FLAG_ACKED</span>       <span style="color: #cd2626;">(</span>FLAG_DATA_ACKED<span style="color: #8b6508;">|</span>FLAG_SYN_ACKED<span style="color: #cd2626;">)</span>
<span class="linenr">2:  </span><span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">FLAG_NOT_DUP</span>     <span style="color: #cd2626;">(</span>FLAG_DATA<span style="color: #8b6508;">|</span>FLAG_WIN_UPDATE<span style="color: #8b6508;">|</span>FLAG_ACKED<span style="color: #cd2626;">)</span>
<span class="linenr">3:  </span><span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">FLAG_CA_ALERT</span>        <span style="color: #cd2626;">(</span>FLAG_DATA_SACKED<span style="color: #8b6508;">|</span>FLAG_ECE<span style="color: #cd2626;">)</span>
<span class="linenr">4:  </span><span style="color: #a020f0;">static</span> <span style="color: #a020f0;">inline</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_ack_is_dubious</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>
<span class="linenr">5:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">6:  </span>     <span style="color: #a020f0;">return</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_NOT_DUP<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">||</span> <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_CA_ALERT<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">||</span>
<span class="linenr">7:  </span>         <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">!=</span> TCP_CA_Open<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">8:  </span><span style="color: #cd2626;">}</span>
</pre>


    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_fastretrans_alert</span><span style="color: #cd2626;">(</span> <span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span><span style="color: #8b6508;">...............</span>
<span class="linenr"> 4:  </span>     <span style="color: #228b22;">int</span> is_dupack <span style="color: #8b6508;">=</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">==</span> prior_snd_una <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr"> 5:  </span>!<span style="color: #cd2626;">(</span>flag<span style="color: #8b6508;">&amp;</span>FLAG_NOT_DUP<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;11&gt;</span>
<span class="linenr"> 6:  </span><span style="color: #8b6508;">.................................</span>
<span class="linenr"> 7:  </span>      <span style="color: #b22222;">/* </span><span style="color: #b22222;">F. Process state. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">switch</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 9:  </span>    <span style="color: #a020f0;">case</span> TCP_CA_Recovery<span style="color: #8b6508;">:</span>
<span class="linenr">10:  </span>    <span style="color: #8b6508;">..................</span>
<span class="linenr">11:  </span>        <span style="color: #a020f0;">break</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>    <span style="color: #a020f0;">case</span> TCP_CA_Loss<span style="color: #8b6508;">:</span>
<span class="linenr">13:  </span>    <span style="color: #8b6508;">..............................</span>
<span class="linenr">14:  </span>    <span style="color: #a020f0;">default</span><span style="color: #8b6508;">:</span>
<span class="linenr">15:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">IsReno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>                   <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;12&gt;</span>
<span class="linenr">16:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">!=</span> prior_snd_una<span style="color: #cd2626;">)</span>
<span class="linenr">17:  </span>                <span style="color: #008000; font-weight: bold;">tcp_reset_reno_sack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>is_dupack<span style="color: #cd2626;">)</span>
<span class="linenr">19:  </span>                <span style="color: #008000; font-weight: bold;">tcp_add_reno_sack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>   <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;13&gt;</span>
<span class="linenr">20:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">21:  </span> <span style="color: #8b6508;">..............................................</span>
<span class="linenr">22:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">tcp_time_to_recover</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>  <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;14&gt;</span>
<span class="linenr">23:  </span>            <span style="color: #008000; font-weight: bold;">tcp_try_to_open</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;15&gt;</span>
<span class="linenr">24:  </span>            <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>   <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;16&gt;</span>
<span class="linenr">25:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">26:  </span><span style="color: #8b6508;">....................</span>
<span class="linenr">27:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>     <br/>
    因为是RENO，所以进入&lt;12&gt;处。is_dupack为1，在&lt;13&gt;处tcp_add_reno_sack（）增� <br/>
    觮p-&gt;sacked_out. <br/>
    &lt;14&gt;的tcp_time_to_recover（）是个极为重要的函数，对第一个重复的ACK而言，返回的是0。 <br/>
    在&lt;15&gt;处的tcp_try_to_open会将icsk-&gt;icsk_ca_state的状态由原来的TCP_CA_Open设为 <br/>
    TCP_CA_Disorder。 <br/>
    &lt;16&gt;处返回整个函数。这2个函数后面会介绍，现在只是提其功能。<br/>
</p>
<p><br/>
</p></div>

</div>

<div id="outline-container-7-5-3" class="outline-4">
<h4 id="sec-7-5-3"><span class="section-number-4">7.5.3</span> 第2个重复的ACK</h4>
<div class="outline-text-4" id="text-7-5-3">

<p>   在不增加窗口大小的情况下，本ACK包还是会通过FASTPATH进入tcp_ack()函数。在增加了sacked_out后与第一个重复的ACK一样就返回了。 <br/>
</p>
<p><br/>
</p></div>

</div>

<div id="outline-container-7-5-4" class="outline-4">
<h4 id="sec-7-5-4"><span class="section-number-4">7.5.4</span> 第3个重复的ACK</h4>
<div class="outline-text-4" id="text-7-5-4">

<p>   该ACK包与前2个包不同之处是：这个包要更新拥塞控制的状态了，这个就是经典的RENO：3个重复ACK引发重传。<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_time_to_recover</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>     <span style="color: #228b22;">__u32</span> <span style="color: #a0522d;">packets_out</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span>     <span style="color: #b22222;">/* </span><span style="color: #b22222;">Trick#1: The loss is proven. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 6:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lost_out</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 7:  </span>         <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>
<span class="linenr"> 9:  </span>     <span style="color: #b22222;">/* </span><span style="color: #b22222;">Not-A-Trick#2 : Classic rule... </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>     <span style="color: #b22222;">// </span><span style="color: #b22222;">if (tcp_dupack_heuristics(tp) &gt; tp-&gt;reordering) // &#22312;linux kernel-2.6.32&#24050;&#32463;&#25913;&#25104;&#34892;&#20102;&#65292;</span>
<span class="linenr">11:  </span>     <span style="color: #b22222;">// </span><span style="color: #b22222;">static inline int tcp_dupack_heuristics(struct tcp_sock *tp)</span>
<span class="linenr">12:  </span>     <span style="color: #b22222;">// </span><span style="color: #b22222;">{</span>
<span class="linenr">13:  </span>     <span style="color: #b22222;">//      </span><span style="color: #b22222;">return tcp_is_fack(tp) ? tp-&gt;fackets_out : tp-&gt;sacked_out + 1;</span>
<span class="linenr">14:  </span>     <span style="color: #b22222;">// </span><span style="color: #b22222;">}</span>
<span class="linenr">15:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_fackets_out</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span><span style="color: #cd2626;">)</span>   <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;17&gt; </span>
<span class="linenr">16:  </span>         <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>
<span class="linenr">18:  </span>     <span style="color: #b22222;">/* </span><span style="color: #b22222;">Trick#3 : when we use RFC2988 timer restart, fast</span>
<span class="linenr">19:  </span><span style="color: #b22222;">      * retransmit can be triggered by timeout of queue head.</span>
<span class="linenr">20:  </span><span style="color: #b22222;">      </span><span style="color: #b22222;">*/</span>
<span class="linenr">21:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_head_timedout</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">))</span>
<span class="linenr">22:  </span>         <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">23:  </span>
<span class="linenr">24:  </span>     <span style="color: #b22222;">/* </span><span style="color: #b22222;">Trick#4: It is still not OK... But will it be useful to delay</span>
<span class="linenr">25:  </span><span style="color: #b22222;">      * recovery more?</span>
<span class="linenr">26:  </span><span style="color: #b22222;">      </span><span style="color: #b22222;">*/</span>
<span class="linenr">27:  </span>     packets_out <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>packets_out <span style="color: #8b6508;">&lt;=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">29:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked_out</span> <span style="color: #8b6508;">&gt;=</span> <span style="color: #228b22;">max_t</span><span style="color: #cd2626;">(</span>__u32<span style="color: #8b6508;">,</span> packets_out<span style="color: #8b6508;">/</span><span style="color: #ff0000;">2</span><span style="color: #8b6508;">,</span> sysctl_tcp_reordering<span style="color: #cd2626;">)</span>
<span class="linenr">30:  </span><span style="color: #8b6508;">&amp;&amp;</span> !<span style="color: #008000; font-weight: bold;">tcp_may_send_now</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr">31:  </span>         <span style="color: #b22222;">/* </span><span style="color: #b22222;">We have nothing to send. This connection is limited</span>
<span class="linenr">32:  </span><span style="color: #b22222;">          * either by receiver window or by application.</span>
<span class="linenr">33:  </span><span style="color: #b22222;">          </span><span style="color: #b22222;">*/</span>
<span class="linenr">34:  </span>         <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">35:  </span>     <span style="color: #cd2626;">}</span>
<span class="linenr">36:  </span>
<span class="linenr">37:  </span>     <span style="color: #a020f0;">return</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">38:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>    <br/>
   &lt;17&gt;处的tp-&gt;reordering初始化的值是3，这个就是个乱序包的阈值。因为没有SACK，FA <br/>
   CK，所以tcp_fackets_out(tp)其实就是返回 sacked_out+1，也就是4，呵呵，终于可以返回1了。 <br/>

</p>
<hr/>
<p>
   ** include/net/tcp.h:<br/>
   CP_FASTRETRANS_THRESH<sup><a class="footref" name="fnr-.11" href="#fn-.11">11</a></sup>     #define TCP_FASTRETRANS_THRESH 3<br/>

</p>
<hr/>
<p>
   ./tcp_input.c:79:int sysctl_tcp_reordering __read_mostly = TCP_FASTRETRANS_THRESH;<br/>
   ./tcp_ipv4.c:1824:   tp-&gt;reordering = sysctl_tcp_reordering;<br/>
</p>
<p><br/>
   第3个重复的ACK在tcp_time_to_recover（）返回1后，会在<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #0000ff; font-size: 120%;">tcp_fastretrans_alert</span><span style="color: #cd2626;">()</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>     <span style="color: #a020f0;">switch</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 4:  </span><span style="color: #8b6508;">..............................</span>
<span class="linenr"> 5:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span><span style="color: #8b6508;">;</span>    <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;18&gt;</span>
<span class="linenr"> 6:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_marker</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_retrans</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_out</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 9:  </span>
<span class="linenr">10:  </span>         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">&lt;</span> TCP_CA_CWR<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">11:  </span>             <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>flag<span style="color: #8b6508;">&amp;</span>FLAG_ECE<span style="color: #cd2626;">))</span>
<span class="linenr">12:  </span>                 tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>             tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  <span style="color: #b22222;">// </span><span style="color: #b22222;">&lt;19&gt;</span>
<span class="linenr">14:  </span>             <span style="color: #008000; font-weight: bold;">TCP_ECN_queue_cwr</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>         <span style="color: #cd2626;">}</span>
<span class="linenr">16:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">bytes_acked</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>         <span style="color: #008000; font-weight: bold;">tcp_set_ca_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_CA_Recovery<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">// </span><span style="color: #b22222;">&lt;20&gt; </span>
<span class="linenr">19:  </span>     <span style="color: #cd2626;">}</span>
<span class="linenr">20:  </span>
<span class="linenr">21:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>is_dupack <span style="color: #8b6508;">||</span> <span style="color: #008000; font-weight: bold;">tcp_head_timedout</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">))</span>
<span class="linenr">22:  </span>         <span style="color: #008000; font-weight: bold;">tcp_update_scoreboard</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>   <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;21&gt;</span>
<span class="linenr">23:  </span>     <span style="color: #008000; font-weight: bold;">tcp_cwnd_down</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>             <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;22&gt;</span>
<span class="linenr">24:  </span>     <span style="color: #008000; font-weight: bold;">tcp_xmit_retransmit_queue</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  <span style="color: #b22222;">//</span><span style="color: #b22222;">&lt;23&gt;</span>
<span class="linenr">25:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>    <br/>
   &lt;18&gt; : 此处设置发生状态转化时的最高发送序号 tp-&gt;snd_nxt，以后会用到它。 <br/>
   &lt;19&gt; : 最终调用RENO的tcp_reno_ssthresh（）进行经典运算，将snd_ssthresh设为tp-&gt;snd_cwnd的一半。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">Slow start threshold is half the congestion window (min 2) </span><span style="color: #b22222;">*/</span>
<span class="linenr">2:  </span><span style="color: #228b22;">u32</span> <span style="color: #0000ff; font-size: 120%;">tcp_reno_ssthresh</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>
<span class="linenr">3:  </span><span style="color: #cd2626;">{</span>
<span class="linenr">4:  </span>    <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">5:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #008000; font-weight: bold;">max</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;&gt;</span> 1U<span style="color: #8b6508;">,</span> 2U<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">6:  </span><span style="color: #cd2626;">}</span>
<span class="linenr">7:  </span><span style="color: #008000; font-weight: bold;">EXPORT_SYMBOL_GPL</span><span style="color: #cd2626;">(</span>tcp_reno_ssthresh<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
</pre>

   &lt;20&gt; : 将本连接从TCP_CA_Disorder变为TCP_CA_Recovery。 <br/>
   &lt;21&gt; : 主要是把 要重发的那个包的进行：TCP_SKB_CB(skb)-&gt;sacked |= TCPCB_LOST。增加tp-&gt;lost_out的值， <br/>
   还有一些帮助用的hint变量。 <br/>
   &lt;22&gt; : tcp_cwnd_down()每收到2个ACK，就把发送控制窗口tp-&gt;snd_cwnd缩小。<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/* </span><span style="color: #b22222;">Decrease cwnd each second ack. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 2:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_cwnd_down</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 3:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">decr</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>flag <span style="color: #8b6508;">&amp;</span> <span style="color: #cd2626;">(</span>FLAG_ANY_PROGRESS <span style="color: #8b6508;">|</span> FLAG_DSACKING_ACK<span style="color: #cd2626;">))</span> <span style="color: #8b6508;">||</span>
<span class="linenr"> 8:  </span>        <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> !<span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_NOT_DUP<span style="color: #cd2626;">)))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 9:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">=</span> decr <span style="color: #8b6508;">&amp;</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>        decr <span style="color: #8b6508;">&gt;&gt;=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">11:  </span>
<span class="linenr">12:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>decr <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #008000; font-weight: bold;">tcp_cwnd_min</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr">13:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">-=</span> decr<span style="color: #8b6508;">;</span>
<span class="linenr">14:  </span>
<span class="linenr">15:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">min</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">tcp_packets_in_flight</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_stamp</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">18:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
   &lt;23&gt; : 因为&lt;20&gt;已经把要重发的包标为TCPCB_LOST，在这里会引起重发这个包，同时重置RTO时钟 <br/>
   （此场景中的3个重复的ACK是不会是RTO超时的，一般的RTO大约几秒，而这3个ACK才1秒多,我也确 <br/>
   实没有找到重置RTO的地方）<br/>
</p>
<p>   <br/>
</p></div>
</div>

</div>

<div id="outline-container-7-6" class="outline-3">
<h3 id="sec-7-6"><span class="section-number-3">7.6</span> 快速恢复</h3>
<div class="outline-text-3" id="text-7-6">

<p>   后来的“快速恢复”算法是在上述的“快速重传”算法后添加的，当收到3个重复ACK时，TCP最后进入的不是拥塞避免阶段，而是快速恢复阶段。<br/>
   快速重传和快速恢复算法一般同时使用。快速恢复的思想是“数据包守恒”原则，即同一个时刻在网络中的数据包数量是恒定的，只有当“老”数<br/>
   据包离开了网络后，才能向网络中发送一个“新”的数据包，如果发送方收到一个重复的ACK，那么根据TCP的ACK机制就表明有一个数据包离开<br/>
   了网络，于是cwnd加1。如果能够严格按照该原则那么网络中很少会发生拥塞，事实上拥塞控制的目的也就在修正违反该原则的地方。<br/>
</p>
</div>

<div id="outline-container-7-6-1" class="outline-4">
<h4 id="sec-7-6-1"><span class="section-number-4">7.6.1</span> 具体来说快速恢复的主要步骤是：</h4>
<div class="outline-text-4" id="text-7-6-1">

<ol>
<li>当收到3个重复ACK时，把ssthresh设置为cwnd的一半，把cwnd设置为ssthresh的值加3，然后重传丢失的报文段，加3的原因是因为<br/>
      收到3个重复的ACK，表明有3个“老”的数据包离开了网络。 <br/>
</li>
<li>再收到重复的ACK时，拥塞窗口增加1。<br/>
</li>
<li>当收到新的数据包的ACK时，把cwnd设置为第一步中的ssthresh的值。原因是因为该ACK确认了新的数据，说明从重复ACK时的数据都已收到，<br/>
      该恢复过程已经结束，可以回到恢复之前的状态了，也即再次进入拥塞避免状态。<br/>
      Reno在收到一个新的数据的ACK时就退出了快速恢复状态了，而NewReno需要收到该窗口内所有数据包的确认后才会退出快速恢复状态，<br/>
      从而更一步提高吞吐量。<br/>
</li>
</ol>

<p>   快速恢复：bictcp_undo_cwnd，直接把snd_cwnd更新为max(snd_cwnd，last_max_cwnd)，和掉包前相差不大。<br/>
</p>
<p><br/>
</p></div>
</div>

</div>

<div id="outline-container-7-7" class="outline-3">
<h3 id="sec-7-7"><span class="section-number-3">7.7</span> 拥塞状态机</h3>
<div class="outline-text-3" id="text-7-7">

<p>　拥塞状态机处理最主要的函数就是tcp_fastretrans_alert，进入这个函数的条件:<br/>
　- each incoming ACK, if state is not “Open”(每个处于非OPEN状态的ack包)<br/>
</p><ul>
<li>when arrived ACK is unusual, namely: (异常的ack包类型如下)<br/>
<ul>
<li>SACK<br/>
</li>
<li>Duplicate ACK.<br/>
</li>
<li>ECN ECE.<br/>
</li>
</ul>

</li>
</ul>

<p>  在tcp_ack()中调用的，进入这个函数就意味着我们碰到了拥塞状态或者在拥塞状态处理tcp。在这个函数中，实现了下面的这些算法： <br/>
  1 失败重传。 <br/>
  2 从不同的拥塞状态恢复。 <br/>
  3 检测到一个失败的拥塞状态从而使数据包的传输的延迟。 <br/>
  4 从所有的拥塞状态恢复到Open状态。<br/>
　此函数分成几个阶段：<br/>
　A. FLAG_ECE，收到包含ECE标志的ACK。<br/>
　B. reneging SACKs，ACK指向已经被SACK的数据段。如果是此原因，进入超时处理，然后返回。<br/>
　C. state is not Open，发现丢包，需要标志出丢失的包，这样就知道该重传哪些包了。<br/>
　D. 检查是否有错误( left_out &gt; packets_out)。<br/>
　E. 各个状态是怎样退出的，当snd_una &gt;= high_seq时候。<br/>
　F. 各个状态的处理和进入。  <br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">inet_connection_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">icsk</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 2:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 3:  </span><span style="color: #b22222;">///</span><span style="color: #b22222;">FLAG_SND_UNA_ADVANCED&#34920;&#31034;Snd_una&#34987;&#25913;&#21464;&#65292;&#20063;&#23601;&#26159;&#24403;&#21069;&#30340;ack&#19981;&#26159;&#19968;&#20010;&#37325;&#22797;ack&#12290;&#32780;FLAG_NOT_DUP&#34920;&#31034;&#20063;&#34920;&#31034;&#19981;&#26159;&#37325;&#22797;ack&#12290;  </span>
<span class="linenr"> 4:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">is_dupack</span> <span style="color: #8b6508;">=</span> !<span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> <span style="color: #cd2626;">(</span>FLAG_SND_UNA_ADVANCED <span style="color: #8b6508;">|</span> FLAG_NOT_DUP<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 5:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#21028;&#26029;&#26159;&#21542;&#26377;&#20002;&#22833;&#30340;&#27573;&#12290;  </span>
<span class="linenr"> 6:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">do_lost</span> <span style="color: #8b6508;">=</span> is_dupack <span style="color: #8b6508;">||</span> <span style="color: #cd2626;">((</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_DATA_SACKED<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>  
<span class="linenr"> 7:  </span>                    <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_fackets_out</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span><span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 8:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">fast_rexmit</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">,</span> <span style="color: #a0522d;">mib_idx</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 9:  </span>
<span class="linenr">10:  </span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#21457;&#36865;&#26410;&#30830;&#35748;&#30340;&#25968;&#25454;&#21253;&#20026;0&#65292;&#21017;&#25105;&#20204;&#24517;&#39035;&#35201;&#37325;&#32622;sacked_out.  </span>
<span class="linenr">11:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">WARN_ON</span><span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked_out</span><span style="color: #cd2626;">))</span>  
<span class="linenr">12:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked_out</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>  
<span class="linenr">13:  </span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;sacked_out&#20026;0&#65292;&#21017;fackets_out&#20063;&#24517;&#39035;&#35774;&#32622;&#20026;0.&#36825;&#26159;&#22240;&#20026;fack&#30340;&#35745;&#25968;&#20381;&#36182;&#20110;&#26368;&#23569;&#19968;&#20010;sack&#30340;&#27573;&#12290;  </span>
<span class="linenr">14:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">WARN_ON</span><span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked_out</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">fackets_out</span><span style="color: #cd2626;">))</span>  
<span class="linenr">15:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">fackets_out</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>  
<span class="linenr">16:  </span>
<span class="linenr">17:  </span>     <span style="color: #b22222;">/* </span><span style="color: #b22222;">Now state machine starts. </span>
<span class="linenr">18:  </span><span style="color: #b22222;">      * A. ECE, hence prohibit cwnd undoing, the reduction is required. </span><span style="color: #b22222;">*/</span>  
<span class="linenr">19:  </span> <span style="color: #b22222;">///</span><span style="color: #b22222;">&#22914;&#26524;&#25509;&#25910;&#21040;ece&#21017;reset&#24930;&#24320;&#22987;&#30340;&#30028;&#38480;&#12290;&#36825;&#26159;&#22240;&#20026;&#25105;&#20204;&#23601;&#35201;&#24320;&#22987;&#20943;&#23567;&#31383;&#21475;&#20102;&#65292;&#25152;&#20197;&#36825;&#26679;&#23601;&#33021;&#20572;&#27490;&#24930;&#24320;&#22987;&#12290;  </span>
<span class="linenr">20:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_ECE<span style="color: #cd2626;">)</span>  
<span class="linenr">21:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>  
<span class="linenr">22:  </span>
<span class="linenr">23:  </span>     <span style="color: #b22222;">/* </span><span style="color: #b22222;">B. In all the states check for reneging SACKs. </span><span style="color: #b22222;">*/</span>  
<span class="linenr">24:  </span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36825;&#20010;&#20027;&#35201;&#29992;&#26469;&#21028;&#26029;&#24403;&#21069;&#30340;ack&#26159;&#19981;&#26159;&#30830;&#35748;&#30340;&#26159;&#24050;&#32463;&#34987;sack&#30340;&#25968;&#25454;&#27573;&#65292;&#22914;&#26524;&#26159;&#30340;&#35805;&#65292;&#35828;&#26126;&#23545;&#31471;&#26377;bug&#25110;&#32773;&#19981;&#33021;&#27491;&#30830;&#30340;&#22788;&#29702;OFO&#30340;&#25968;&#25454;&#27573;&#12290;&#27492;&#26102;&#25105;&#20204;&#38656;&#35201;destroy&#25481;&#25152;&#26377;&#30340;sack&#20449;&#24687;&#65292;&#28982;&#21518;&#36820;&#22238;&#12290;  </span>
<span class="linenr">25:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_check_sack_reneging</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">))</span>  
<span class="linenr">26:  </span>         <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>  
<span class="linenr">27:  </span>
<span class="linenr">28:  </span>     <span style="color: #b22222;">/* </span><span style="color: #b22222;">C. Process data loss notification, provided it is valid. </span><span style="color: #b22222;">*/</span>  
<span class="linenr">29:  </span>
<span class="linenr">30:  </span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36825;&#27573;&#20027;&#35201;&#26159;&#20026;&#20102;&#21028;&#26029;&#25968;&#25454;&#26159;&#21542;&#20002;&#22833;&#12290;&#21069;&#20004;&#20010;&#21028;&#26029;&#20027;&#35201;&#26159;flag&#21644;fack&#30340;&#21028;&#23450;&#12290;  </span>
<span class="linenr">31:  </span>     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_fack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_DATA_LOST<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>  
<span class="linenr">32:  </span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36825;&#20010;&#20026;&#30495;&#35828;&#26126;&#19968;&#20123;&#27573;&#21487;&#33021;&#24050;&#32463;&#34987;&#25509;&#21463;&#31471;sack&#25481;&#20102;&#12290;  </span>
<span class="linenr">33:  </span>         <span style="color: #008000; font-weight: bold;">before</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>  
<span class="linenr">34:  </span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36825;&#20010;&#35828;&#26126;&#24403;&#21069;&#24050;&#32463;&#36827;&#20837;&#20102;&#25317;&#22622;&#22788;&#29702;&#30340;&#29366;&#24577;&#12290;  </span>
<span class="linenr">35:  </span>         icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">!=</span> TCP_CA_Open <span style="color: #8b6508;">&amp;&amp;</span>  
<span class="linenr">36:  </span> <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36825;&#20010;&#20026;&#30495;&#35828;&#26126;&#22312;&#37325;&#20256;&#38431;&#21015;&#24320;&#22987;&#30340;&#19968;&#20123;&#27573;&#24050;&#32463;&#20002;&#22833;&#12290;  </span>
<span class="linenr">37:  </span>         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">fackets_out</span> <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>  
<span class="linenr">38:  </span> <span style="color: #b22222;">///</span><span style="color: #b22222;">&#21040;&#36798;&#36825;&#37324;&#65292;&#25105;&#20204;&#23558;&#20250;&#20381;&#27425;&#26631;&#35760;&#25152;&#26377;&#30340;&#37325;&#20256;&#27573;&#37117;&#20026;&#20002;&#22833;&#65292;&#30452;&#21040;&#25105;&#20204;&#21457;&#29616;&#31532;&#19968;&#20010;&#34987;sacked&#30340;&#27573;&#12290;  </span>
<span class="linenr">39:  </span>         <span style="color: #008000; font-weight: bold;">tcp_mark_head_lost</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">fackets_out</span> <span style="color: #8b6508;">-</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">40:  </span>         <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_net</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span> LINUX_MIB_TCPLOSS<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">41:  </span>     <span style="color: #cd2626;">}</span>  
<span class="linenr">42:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">D. Check consistency of the current state. </span><span style="color: #b22222;">*/</span>  
<span class="linenr">43:  </span>    <span style="color: #008000; font-weight: bold;">tcp_verify_left_out</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
</pre>

    </div>
    接下来就看这几个状态是如何变迁的，因此我这里只是用来描述状态变迁相关的函数。<br/>
    首先状态变迁分为两部分，一部分是进入某些状态，一部分是从某些状态跳出来。首先来分析状态的默认处理，也就是假设是处于Open状态，然后收到了异常的ACK,此时代码是如何处理的.。<br/>
    这里要注意TCP reno算法是用快重传来模拟SACK，所以如果关闭了SACK那么就需要模拟SACK.<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span>    <span style="color: #a020f0;">switch</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 2:  </span><span style="color: #8b6508;">...........................................................................................</span>
<span class="linenr"> 3:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">Loss is undone; fall through to processing in Open state. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 4:  </span><span style="color: #b22222;">// </span><span style="color: #b22222;">&#36827;&#20837;&#19979;&#38754;&#21017;&#26377;&#21487;&#33021;&#26159;&#12288;disorder,open, cwr,loss &#36825;&#20960;&#20010;&#29366;&#24577;.</span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">default</span><span style="color: #8b6508;">:</span>
<span class="linenr"> 6:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;SACK&#20851;&#38381;&#65292;&#37027;&#20040;&#23601;&#38656;&#35201;&#27169;&#25311;SACK</span>
<span class="linenr"> 7:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 8:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_SND_UNA_ADVANCED<span style="color: #cd2626;">)</span>
<span class="linenr"> 9:  </span>                <span style="color: #008000; font-weight: bold;">tcp_reset_reno_sack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>is_dupack<span style="color: #cd2626;">)</span>
<span class="linenr">11:  </span>                <span style="color: #008000; font-weight: bold;">tcp_add_reno_sack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">13:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#20174;DSACK&#24674;&#22797;</span>
<span class="linenr">14:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">&lt;=</span> TCP_CA_Disorder<span style="color: #cd2626;">)</span>
<span class="linenr">15:  </span>            <span style="color: #008000; font-weight: bold;">tcp_try_undo_dsack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#26159;&#21542;&#38656;&#35201;&#36827;&#20837;revocer&#29366;&#24577;&#12290;</span>
<span class="linenr">17:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">tcp_time_to_recover</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr">18:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#38656;&#35201;&#65292;&#21017;&#23581;&#35797;&#30528;&#26816;&#27979;&#26159;&#21542;&#38656;&#35201;&#36827;&#20837;CWR&#25110;&#32773;Disorder&#29366;&#24577;.</span>
<span class="linenr">19:  </span>            <span style="color: #008000; font-weight: bold;">tcp_try_to_open</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>            <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">22:  </span>
<span class="linenr">23:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">MTU probe failure: don't reduce cwnd </span><span style="color: #b22222;">*/</span>
<span class="linenr">24:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">&lt;</span> TCP_CA_CWR <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">25:  </span>            icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_mtup</span><span style="color: #8b6508;">.</span><span style="color: #008000;">probe_size</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">26:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">==</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">mtu_probe</span><span style="color: #8b6508;">.</span><span style="color: #008000;">probe_seq_start</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">27:  </span>            <span style="color: #008000; font-weight: bold;">tcp_mtup_probe_failed</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">Restores the reduction we did in tcp_mtup_probe() </span><span style="color: #b22222;">*/</span>
<span class="linenr">29:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">++;</span>
<span class="linenr">30:  </span>            <span style="color: #008000; font-weight: bold;">tcp_simple_retransmit</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>            <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">33:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#26368;&#32456;&#36827;&#20837;recovery&#29366;&#24577;</span>
<span class="linenr">34:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">Otherwise enter Recovery state </span><span style="color: #b22222;">*/</span>
<span class="linenr">35:  </span>        <span style="color: #008000; font-weight: bold;">tcp_enter_recovery</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_ECE<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span>
<span class="linenr">36:  </span>        fast_rexmit <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>
<span class="linenr">37:  </span>    <span style="color: #cd2626;">}</span>
</pre>

    </div>

      上面有三个函数需要详细分析，分别是tcp_time_to_recover,tcp_try_to_open以及tcp_enter_recovery。<br/>
      首先是tcp_time_to_recover,这个函数主要是用来判断是否需要进入recover状态。<br/>
</p>
<p>       <br/>
      首先来描述下几个基本概念，一个就是重定序长度(reordering),这个值的意思是当有大于１个的SACK之后，相差最大的两个SACK之间的距离,<br/>
      比如第一个SACK通知的序列是7,第二个是2，那么reordering值就是6.而FACK_OUT表示sack确认的最大的序列号。<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">bool</span> <span style="color: #0000ff; font-size: 120%;">tcp_time_to_recover</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>    <span style="color: #228b22;">__u32</span> <span style="color: #a0522d;">packets_out</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>
<span class="linenr"> 6:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Do not perform any recovery during F-RTO algorithm </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frto_counter</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 8:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">false</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 9:  </span>
<span class="linenr">10:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Trick#1: The loss is proven. </span><span style="color: #b22222;">*/</span>
<span class="linenr">11:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lost_out</span><span style="color: #cd2626;">)</span>
<span class="linenr">12:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>
<span class="linenr">14:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Not-A-Trick#2 : Classic rule... </span><span style="color: #b22222;">*/</span>
<span class="linenr">15:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;SACK&#30340;&#26368;&#22823;&#24207;&#21015;&#21495;&#22823;&#20110;&#37325;&#23450;&#24207;&#38271;&#24230;&#65292;&#37027;&#20040;&#35828;&#26126;&#37325;&#23450;&#24207;&#24207;&#21015;&#20013;&#22836;&#37096;&#30340;&#25968;&#25454;&#19968;&#23450;&#20002;&#22833;&#65292;&#37027;&#20040;&#23601;&#38656;&#35201;&#36827;&#20837;recover&#29366;&#24577;.</span>
<span class="linenr">16:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_dupack_heuristics</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span><span style="color: #cd2626;">)</span>
<span class="linenr">17:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span><span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>
<span class="linenr">19:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Trick#3 : when we use RFC2988 timer restart, fast</span>
<span class="linenr">20:  </span><span style="color: #b22222;">     * retransmit can be triggered by timeout of queue head.</span>
<span class="linenr">21:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">22:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#25968;&#25454;&#21253;&#36229;&#26102;(&#22240;&#20026;&#27599;&#27425;&#37325;&#20256;&#23450;&#26102;&#22120;&#37117;&#20250;&#34987;&#37325;&#32622;),&#21017;&#36827;&#20837;recover&#29366;&#24577;.</span>
<span class="linenr">23:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_fack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">tcp_head_timedout</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr">24:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span><span style="color: #8b6508;">;</span>
<span class="linenr">25:  </span>
<span class="linenr">26:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Trick#4: It is still not OK... But will it be useful to delay</span>
<span class="linenr">27:  </span><span style="color: #b22222;">     * recovery more?</span>
<span class="linenr">28:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">29:  </span>    packets_out <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span><span style="color: #8b6508;">;</span>
<span class="linenr">30:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#36825;&#37324;&#19981;&#22826;&#29702;&#35299;&#20160;&#20040;&#24847;&#24605;</span>
<span class="linenr">31:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>packets_out <span style="color: #8b6508;">&lt;=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">32:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked_out</span> <span style="color: #8b6508;">&gt;=</span> <span style="color: #228b22;">max_t</span><span style="color: #cd2626;">(</span>__u32<span style="color: #8b6508;">,</span> packets_out<span style="color: #8b6508;">/</span><span style="color: #ff0000;">2</span><span style="color: #8b6508;">,</span> sysctl_tcp_reordering<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">33:  </span>        !<span style="color: #008000; font-weight: bold;">tcp_may_send_now</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr">34:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">We have nothing to send. This connection is limited</span>
<span class="linenr">35:  </span><span style="color: #b22222;">         * either by receiver window or by application.</span>
<span class="linenr">36:  </span><span style="color: #b22222;">         </span><span style="color: #b22222;">*/</span>
<span class="linenr">37:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span><span style="color: #8b6508;">;</span>
<span class="linenr">38:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">39:  </span>
<span class="linenr">40:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">If a thin stream is detected, retransmit after first</span>
<span class="linenr">41:  </span><span style="color: #b22222;">     * received dupack. Employ only if SACK is supported in order</span>
<span class="linenr">42:  </span><span style="color: #b22222;">     * to avoid possible corner-case series of spurious retransmissions</span>
<span class="linenr">43:  </span><span style="color: #b22222;">     * Use only if there are no unsent data.</span>
<span class="linenr">44:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">45:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22788;&#29702;thin stream</span>
<span class="linenr">46:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">thin_dupack</span> <span style="color: #8b6508;">||</span> sysctl_tcp_thin_dupack<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">47:  </span>        <span style="color: #008000; font-weight: bold;">tcp_stream_is_thin</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">tcp_dupack_heuristics</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">1</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">48:  </span>        <span style="color: #008000; font-weight: bold;">tcp_is_sack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> !<span style="color: #008000; font-weight: bold;">tcp_send_head</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr">49:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span><span style="color: #8b6508;">;</span>
<span class="linenr">50:  </span>
<span class="linenr">51:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Trick#6: TCP early retransmit, per RFC5827.  To avoid spurious</span>
<span class="linenr">52:  </span><span style="color: #b22222;">     * retransmissions due to small network reorderings, we implement</span>
<span class="linenr">53:  </span><span style="color: #b22222;">     * Mitigation A.3 in the RFC and delay the retransmission for a short</span>
<span class="linenr">54:  </span><span style="color: #b22222;">     * interval if appropriate.</span>
<span class="linenr">55:  </span><span style="color: #b22222;">     </span><span style="color: #b22222;">*/</span>
<span class="linenr">56:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22788;&#29702;early retransmit</span>
<span class="linenr">57:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">do_early_retrans</span> <span style="color: #8b6508;">&amp;&amp;</span> !tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_out</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked_out</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">58:  </span>        <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span> <span style="color: #8b6508;">==</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked_out</span> <span style="color: #8b6508;">+</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span> <span style="color: #8b6508;">&lt;</span> <span style="color: #ff0000;">4</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>
<span class="linenr">59:  </span>        !<span style="color: #008000; font-weight: bold;">tcp_may_send_now</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr">60:  </span>        <span style="color: #a020f0;">return</span> !<span style="color: #008000; font-weight: bold;">tcp_pause_early_retransmit</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">61:  </span>
<span class="linenr">62:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#26368;&#32456;&#36820;&#22238;false.</span>
<span class="linenr">63:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">false</span><span style="color: #8b6508;">;</span>
<span class="linenr">64:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
      然后来看tcp_try_to_open方法,这个函数名字有点问题，它的主要作用是检测是否需要进入CWR或者Disorder状态.<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_try_to_open</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span>    <span style="color: #008000; font-weight: bold;">tcp_verify_left_out</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frto_counter</span> <span style="color: #8b6508;">&amp;&amp;</span> !<span style="color: #008000; font-weight: bold;">tcp_any_retrans_done</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr"> 8:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_stamp</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 9:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#25509;&#21463;&#21040;ECE&#37027;&#20040;&#23601;&#36827;&#20837;cwr&#29366;&#24577;.</span>
<span class="linenr">10:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_ECE<span style="color: #cd2626;">)</span>
<span class="linenr">11:  </span>        <span style="color: #008000; font-weight: bold;">tcp_enter_cwr</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>
<span class="linenr">13:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">!=</span> TCP_CA_CWR<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">14:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#26816;&#27979;&#26159;&#21542;&#38656;&#35201;&#36827;&#20837;disorder&#29366;&#24577;&#65292;&#21542;&#21017;&#36827;&#20837;open&#29366;&#24577;.</span>
<span class="linenr">15:  </span>        <span style="color: #008000; font-weight: bold;">tcp_try_keep_open</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#26159;open&#29366;&#24577;&#65292;&#21017;&#20462;&#25913;&#25317;&#22622;&#31383;&#21475;</span>
<span class="linenr">17:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">!=</span> TCP_CA_Open<span style="color: #cd2626;">)</span>
<span class="linenr">18:  </span>            <span style="color: #008000; font-weight: bold;">tcp_moderate_cwnd</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">19:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">20:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#20943;&#23567;&#25317;&#22622;&#31383;&#21475;</span>
<span class="linenr">21:  </span>        <span style="color: #008000; font-weight: bold;">tcp_cwnd_down</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> flag<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">22:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">23:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>      <br/>
      然后来看tcp__try_keep_open方法，这个方法就是判断是否进入Disorder状态.条件很简单，那就是要么有SACK的段或者有丢失的段，要么有任何重传的段，<br/>
      那么就进入Disorder状态。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_try_keep_open</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#40664;&#35748;&#26159;&#36827;&#20837;open&#29366;&#24577;</span>
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">state</span> <span style="color: #8b6508;">=</span> TCP_CA_Open<span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#36827;&#20837;Disorder&#29366;&#24577;</span>
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_left_out</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">||</span> <span style="color: #008000; font-weight: bold;">tcp_any_retrans_done</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr"> 8:  </span>        state <span style="color: #8b6508;">=</span> TCP_CA_Disorder<span style="color: #8b6508;">;</span>
<span class="linenr"> 9:  </span>
<span class="linenr">10:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">!=</span> state<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">11:  </span>        <span style="color: #008000; font-weight: bold;">tcp_set_ca_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> state<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">14:  </span><span style="color: #cd2626;">}</span>
</pre>

      然后就是tcp_enter_recovery，这个函数主要就是用来进入recover状态，然后设置相关的域。<br/>
      high_seq : 进入recover状态时的snd_nxt.<br/>
      undo_marker: 表示进入revover状态时的snd_una<br/>
      undo_retrans: 表示进入revover状态时的重传段个数<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_enter_recovery</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">bool</span> <span style="color: #a0522d;">ece_ack</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">mib_idx</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>
<span class="linenr"> 6:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span>
<span class="linenr"> 7:  </span>        mib_idx <span style="color: #8b6508;">=</span> LINUX_MIB_TCPRENORECOVERY<span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">else</span>
<span class="linenr"> 9:  </span>        mib_idx <span style="color: #8b6508;">=</span> LINUX_MIB_TCPSACKRECOVERY<span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>
<span class="linenr">11:  </span>    <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_net</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span> mib_idx<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#26356;&#26032;&#30456;&#20851;&#22495;</span>
<span class="linenr">13:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span><span style="color: #8b6508;">;</span>
<span class="linenr">14:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_marker</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_retrans</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_out</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>
<span class="linenr">18:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">&lt;</span> TCP_CA_CWR<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">19:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!ece_ack<span style="color: #cd2626;">)</span>
<span class="linenr">20:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#20445;&#23384;&#24403;&#21069;&#30340;ssthresh,&#20197;&#20415;&#20110;&#21518;&#32493;&#24674;&#22797;</span>
<span class="linenr">21:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">22:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#26356;&#26032;slow start&#30340;&#38408;&#20540;.</span>
<span class="linenr">23:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">24:  </span>        <span style="color: #008000; font-weight: bold;">TCP_ECN_queue_cwr</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">25:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">26:  </span>
<span class="linenr">27:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">bytes_acked</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">29:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#20445;&#23384;&#25317;&#22622;&#31383;&#21475;</span>
<span class="linenr">30:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_cwnd</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prr_delivered</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prr_out</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">33:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#36827;&#20837;recovery&#29366;&#24577;</span>
<span class="linenr">34:  </span>    <span style="color: #008000; font-weight: bold;">tcp_set_ca_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_CA_Recovery<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">35:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>

      然后来看tcp_enter_cwr，这个函数主要是用于进入CWR状态。看这个函数的时候，可以看到和上面recover状态使用的变量的设置关系.<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_enter_cwr</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">set_ssthresh</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">inet_connection_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">icsk</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 5:  </span>
<span class="linenr"> 6:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">bytes_acked</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">&lt;</span> TCP_CA_CWR<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 9:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_marker</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>set_ssthresh<span style="color: #cd2626;">)</span>
<span class="linenr">11:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">min</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">,</span>
<span class="linenr">13:  </span>                   <span style="color: #008000; font-weight: bold;">tcp_packets_in_flight</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> 1U<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">14:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#35774;&#32622;&#26368;&#22823;&#24207;&#21015;&#21495;</span>
<span class="linenr">16:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_nxt</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_stamp</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>        <span style="color: #008000; font-weight: bold;">TCP_ECN_queue_cwr</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">19:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#36827;&#20837;CWR&#29366;&#24577;.</span>
<span class="linenr">20:  </span>        <span style="color: #008000; font-weight: bold;">tcp_set_ca_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_CA_CWR<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">22:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>      <br/>
      可以看到上面的设置保存了很多值，那么这些值在什么时候使用呢，先来看上面的代码分析中跳过的片段,也就是tcp_try_undo_dsack函数。<br/>
</p>
<p>       <br/>
      这个函数主要是用于检测是否需要从cwnd减小的驱使中恢复，这里判断条件就是undo_marker和undo_retrans.<br/>
      这里undo_retrans为0,则表示没有重传任何数据，或者说重传的数据都已经被DSACK了，从而说明数据都已经安全抵达，那么这个时候自然需要从cwr恢复。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_try_undo_dsack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_marker</span> <span style="color: #8b6508;">&amp;&amp;</span> !tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_retrans</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 6:  </span>        <span style="color: #008000; font-weight: bold;">DBGUNDO</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #8b2252;">"D-SACK"</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#24674;&#22797;&#25317;&#22622;&#31383;&#21475;&#20197;&#21450;slow start&#30340;&#38408;&#20540;&#12290;</span>
<span class="linenr"> 8:  </span>        <span style="color: #008000; font-weight: bold;">tcp_undo_cwr</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008b8b;">true</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 9:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_marker</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>        <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_net</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span> LINUX_MIB_TCPDSACKUNDO<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">11:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">12:  </span><span style="color: #cd2626;">}</span>
</pre>

</p>
<p>      <br/>
      从上面可以看到核心就是tcp_undo_cwr函数。这个函数主要就是用于重置发送拥塞窗口和slow start的阈值.<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff; font-size: 120%;">tcp_undo_cwr</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #228b22;">bool</span> <span style="color: #a0522d;">undo_ssthresh</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 6:  </span>        <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">inet_connection_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">icsk</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_cwnd</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 9:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_cwnd</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>        <span style="color: #a020f0;">else</span>
<span class="linenr">11:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">max</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">&lt;&lt;</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>
<span class="linenr">13:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>undo_ssthresh <span style="color: #8b6508;">&amp;&amp;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">14:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#24674;&#22797;&#21040;&#20808;&#21069;&#20445;&#23384;&#30340;&#38408;&#20540;</span>
<span class="linenr">15:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span><span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>            <span style="color: #008000; font-weight: bold;">TCP_ECN_withdraw_cwr</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">18:  </span>    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>
<span class="linenr">19:  </span>        tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">max</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">21:  </span>    tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_stamp</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>
<span class="linenr">22:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>

      然后来看在recover状态下，如何处理重复/部分确认.<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>    <span style="color: #a020f0;">case</span> TCP_CA_Recovery<span style="color: #8b6508;">:</span>
<span class="linenr"> 2:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#25910;&#21040;&#20102;&#37325;&#22797;&#30830;&#35748;</span>
<span class="linenr"> 3:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_SND_UNA_ADVANCED<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 4:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#22914;&#26524;&#26159;reno&#31639;&#27861;&#65292;&#21017;&#26356;&#26032;sack</span>
<span class="linenr"> 5:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> is_dupack<span style="color: #cd2626;">)</span>
<span class="linenr"> 6:  </span>                <span style="color: #008000; font-weight: bold;">tcp_add_reno_sack</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>        <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span>
<span class="linenr"> 8:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#25509;&#25910;&#21040;&#20102;&#37096;&#20998;&#30830;&#35748;&#65292;&#37027;&#20040;&#27492;&#26102;&#23601;&#38656;&#35201;&#25764;&#38144;&#20808;&#21069;&#30340;&#35774;&#32622;</span>
<span class="linenr"> 9:  </span>            do_lost <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_try_undo_partial</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> pkts_acked<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span>        <span style="color: #a020f0;">break</span><span style="color: #8b6508;">;</span>
</pre>

</p>
<p>              <br/>
      然后来看tcp_try_undo_partial,这个函数就是用来检查是否可以从接受到的部分确认撤销，它的返回值就是是否需要标记一些段为丢失。<br/>
</p>
<p>       <br/>
      这里要注意tcp_may_undo函数，这个函数主要用于判断是否是错误的进入了拥塞状态，如果是那么就返回true，然后接下来就需要从错误的状态撤销.<br/>
      它的判断类似上面的tcp_try_undo_dsack。<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff; font-size: 120%;">tcp_try_undo_partial</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">acked</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span><span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">Partial ACK arrived. Force Hoe's retransmit. </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">failed</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">||</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_fackets_out</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">reordering</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#21028;&#26029;&#26159;&#21542;&#38656;&#35201;&#25764;&#38144;</span>
<span class="linenr"> 7:  </span>    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_may_undo</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 8:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">Plain luck! Hole if filled with delayed</span>
<span class="linenr"> 9:  </span><span style="color: #b22222;">         * packet, rather than with a retransmit.</span>
<span class="linenr">10:  </span><span style="color: #b22222;">         </span><span style="color: #b22222;">*/</span>
<span class="linenr">11:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">tcp_any_retrans_done</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr">12:  </span>            tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">retrans_stamp</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">update&#37325;&#23450;&#24207;&#38271;&#24230;</span>
<span class="linenr">14:  </span>        <span style="color: #008000; font-weight: bold;">tcp_update_reordering</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">tcp_fackets_out</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">+</span> acked<span style="color: #8b6508;">,</span> <span style="color: #ff0000;">1</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>
<span class="linenr">16:  </span>        <span style="color: #008000; font-weight: bold;">DBGUNDO</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #8b2252;">"Hoe"</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#20174;cwr&#25764;&#38144;</span>
<span class="linenr">18:  </span>        <span style="color: #008000; font-weight: bold;">tcp_undo_cwr</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008b8b;">false</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">19:  </span>        <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_net</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span> LINUX_MIB_TCPPARTIALUNDO<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>
<span class="linenr">21:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">So... Do not make Hoe's retransmit yet.</span>
<span class="linenr">22:  </span><span style="color: #b22222;">         * If the first packet was delayed, the rest</span>
<span class="linenr">23:  </span><span style="color: #b22222;">         * ones are most probably delayed as well.</span>
<span class="linenr">24:  </span><span style="color: #b22222;">         </span><span style="color: #b22222;">*/</span>
<span class="linenr">25:  </span>        failed <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">26:  </span>    <span style="color: #cd2626;">}</span>
<span class="linenr">27:  </span>    <span style="color: #a020f0;">return</span> failed<span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span><span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>      <br/>
      然后就是LOSS状态的处理，也就是说在LOSS状态时处理重复以及部分确认.这个状态的处理类似上面的recover状态，因此这里就简要的描述下.<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>    <span style="color: #a020f0;">case</span> TCP_CA_Loss<span style="color: #8b6508;">:</span>
<span class="linenr"> 2:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_DATA_ACKED<span style="color: #cd2626;">)</span>
<span class="linenr"> 3:  </span>            icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_retransmits</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> flag <span style="color: #8b6508;">&amp;</span> FLAG_SND_UNA_ADVANCED<span style="color: #cd2626;">)</span>
<span class="linenr"> 5:  </span>            <span style="color: #008000; font-weight: bold;">tcp_reset_reno_sack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#21028;&#26029;&#26159;&#21542;&#38656;&#35201;&#20174;LOSS&#29366;&#24577;&#25764;&#38144;</span>
<span class="linenr"> 7:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>!<span style="color: #008000; font-weight: bold;">tcp_try_undo_loss</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 8:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#19981;&#38656;&#35201;&#25764;&#38144;&#65292;&#21017;&#35843;&#25972;&#25317;&#22622;&#31383;&#21475;</span>
<span class="linenr"> 9:  </span>            <span style="color: #008000; font-weight: bold;">tcp_moderate_cwnd</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">10:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#37325;&#20256;</span>
<span class="linenr">11:  </span>            <span style="color: #008000; font-weight: bold;">tcp_xmit_retransmit_queue</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>            <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span>        <span style="color: #cd2626;">}</span>
<span class="linenr">14:  </span>        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">!=</span> TCP_CA_Open<span style="color: #cd2626;">)</span>
<span class="linenr">15:  </span>            <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
</pre>


      最后我们来看退出拥塞状态检测的处理，也就是当发送未确认的段大于等于high_seq(拥塞发生时的snd_nxt).当大于high_seq的时候，则说明可能我们需要从拥塞状态退出了，<br/>
      因为此时可能当拥塞状态发生时丢失的段都已经传输完毕。<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span>        <span style="color: #a020f0;">case</span> TCP_CA_Loss<span style="color: #8b6508;">:</span>
<span class="linenr"> 2:  </span>            icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_retransmits</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 3:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#23581;&#35797;&#25764;&#38144;&#25317;&#22622;&#29366;&#24577;</span>
<span class="linenr"> 4:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_try_undo_recovery</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr"> 5:  </span>                <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 6:  </span>            <span style="color: #a020f0;">break</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>        <span style="color: #a020f0;">case</span> TCP_CA_CWR<span style="color: #8b6508;">:</span>
<span class="linenr"> 9:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">CWR is to be held something *above* high_seq</span>
<span class="linenr">10:  </span><span style="color: #b22222;">             * is ACKed for CWR bit to reach receiver. </span><span style="color: #b22222;">*/</span>
<span class="linenr">11:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">!=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>
<span class="linenr">12:  </span>                <span style="color: #008000; font-weight: bold;">tcp_complete_cwr</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">13:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#24674;&#22797;&#21040;open&#29366;&#24577;.</span>
<span class="linenr">14:  </span>                <span style="color: #008000; font-weight: bold;">tcp_set_ca_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_CA_Open<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">15:  </span>            <span style="color: #cd2626;">}</span>
<span class="linenr">16:  </span>            <span style="color: #a020f0;">break</span><span style="color: #8b6508;">;</span>
<span class="linenr">17:  </span>
<span class="linenr">18:  </span>        <span style="color: #a020f0;">case</span> TCP_CA_Recovery<span style="color: #8b6508;">:</span>
<span class="linenr">19:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span>
<span class="linenr">20:  </span>                <span style="color: #008000; font-weight: bold;">tcp_reset_reno_sack</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#23581;&#35797;&#25764;&#38144;&#25317;&#22622;&#29366;&#24577;</span>
<span class="linenr">22:  </span>            <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_try_undo_recovery</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span>
<span class="linenr">23:  </span>                <span style="color: #a020f0;">return</span><span style="color: #8b6508;">;</span>
<span class="linenr">24:  </span><span style="color: #b22222;">//</span><span style="color: #b22222;">&#23436;&#25104;cwr</span>
<span class="linenr">25:  </span>            <span style="color: #008000; font-weight: bold;">tcp_complete_cwr</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">26:  </span>            <span style="color: #a020f0;">break</span><span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>        <span style="color: #cd2626;">}</span>
</pre>

    </div>
</p>
<p>              <br/>
      来看最后一个函数，也就是tcp_try_undo_recovery函数。这个函数主要就是用于撤销拥塞状态。<br/>
    <div style="height:400px;overflow:auto;border-style:solid;border-width:1px">

<pre class="src src-c"><span class="linenr"> 1:  </span>  <span style="color: #a020f0;">static</span> <span style="color: #228b22;">bool</span> <span style="color: #0000ff; font-size: 120%;">tcp_try_undo_recovery</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>
<span class="linenr"> 2:  </span>  <span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>      <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 4:  </span>  <span style="color: #b22222;">//</span><span style="color: #b22222;">&#26159;&#21542;&#38656;&#35201;&#25764;&#38144;</span>
<span class="linenr"> 5:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_may_undo</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr"> 6:  </span>          <span style="color: #228b22;">int</span> <span style="color: #a0522d;">mib_idx</span><span style="color: #8b6508;">;</span>
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>          <span style="color: #b22222;">/* </span><span style="color: #b22222;">Happy end! We did not retransmit anything</span>
<span class="linenr"> 9:  </span><span style="color: #b22222;">           * or our original transmission succeeded.</span>
<span class="linenr">10:  </span><span style="color: #b22222;">           </span><span style="color: #b22222;">*/</span>
<span class="linenr">11:  </span>          <span style="color: #008000; font-weight: bold;">DBGUNDO</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">==</span> TCP_CA_Loss ? <span style="color: #8b2252;">"loss"</span> <span style="color: #8b6508;">:</span> <span style="color: #8b2252;">"retrans"</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">12:  </span>  <span style="color: #b22222;">//</span><span style="color: #b22222;">&#25764;&#38144;&#35774;&#32622;</span>
<span class="linenr">13:  </span>          <span style="color: #008000; font-weight: bold;">tcp_undo_cwr</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008b8b;">true</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">14:  </span>          <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">==</span> TCP_CA_Loss<span style="color: #cd2626;">)</span>
<span class="linenr">15:  </span>              mib_idx <span style="color: #8b6508;">=</span> LINUX_MIB_TCPLOSSUNDO<span style="color: #8b6508;">;</span>
<span class="linenr">16:  </span>          <span style="color: #a020f0;">else</span>
<span class="linenr">17:  </span>              mib_idx <span style="color: #8b6508;">=</span> LINUX_MIB_TCPFULLUNDO<span style="color: #8b6508;">;</span>
<span class="linenr">18:  </span>
<span class="linenr">19:  </span>          <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_net</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span> mib_idx<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">20:  </span>          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_marker</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>
<span class="linenr">21:  </span>      <span style="color: #cd2626;">}</span>
<span class="linenr">22:  </span>      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">==</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">tcp_is_reno</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>
<span class="linenr">23:  </span>          <span style="color: #b22222;">/* </span><span style="color: #b22222;">Hold old state until something *above* high_seq</span>
<span class="linenr">24:  </span><span style="color: #b22222;">           * is ACKed. For Reno it is MUST to prevent false</span>
<span class="linenr">25:  </span><span style="color: #b22222;">           * fast retransmits (RFC2582). SACK TCP is safe. </span><span style="color: #b22222;">*/</span>
<span class="linenr">26:  </span>          <span style="color: #008000; font-weight: bold;">tcp_moderate_cwnd</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">27:  </span>          <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span><span style="color: #8b6508;">;</span>
<span class="linenr">28:  </span>     <span style="color: #cd2626;">}</span>
<span class="linenr">29:  </span>     <span style="color: #b22222;">//</span><span style="color: #b22222;">&#35774;&#32622;&#29366;&#24577;&#20026;open.</span>
<span class="linenr">30:  </span>     <span style="color: #008000; font-weight: bold;">tcp_set_ca_state</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> TCP_CA_Open<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>
<span class="linenr">31:  </span>     <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">false</span><span style="color: #8b6508;">;</span>
<span class="linenr">32:  </span><span style="color: #cd2626;">}</span>      
</pre>

    </div>

</p></div>

</div>

<div id="outline-container-7-8" class="outline-3">
<h3 id="sec-7-8"><span class="section-number-3">7.8</span> 拥塞事件</h3>
<div class="outline-text-3" id="text-7-8">

<p>　　　TCP定义了几个拥塞事件，当这些事件发生时，我们可以通过TCP的拥塞控制算法，调用自定义的处理函数，<br/>
　　　来做一些额外的事情的。也就是说，我们可以很简便的参与到TCP对拥塞事件的处理过程中。<br/>
　　　 <br/>
</p>
</div>

<div id="outline-container-7-8-1" class="outline-4">
<h4 id="sec-7-8-1"><span class="section-number-4">7.8.1</span> TCP的拥塞事件集</h4>
<div class="outline-text-4" id="text-7-8-1">


<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;  <span style="color: #b22222;">/* </span><span style="color: #b22222;">Events passed to congestion control interface </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 2:  </span>&#12288;&#12288;&#12288;    
<span class="linenr"> 3:  </span>&#12288;&#12288;&#12288;  <span style="color: #a020f0;">enum</span> <span style="color: #228b22;">tcp_ca_event</span> <span style="color: #cd2626;">{</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;      CA_EVENT_TX_START<span style="color: #8b6508;">,</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">first transmit when no packets in flight </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;      CA_EVENT_CWND_RESTART<span style="color: #8b6508;">,</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">congestion window restart </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;      CA_EVENT_COMPLETE_CWR<span style="color: #8b6508;">,</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">end of congestion recovery </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;      CA_EVENT_FRTO<span style="color: #8b6508;">,</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">fast recovery timeout </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 8:  </span>&#12288;&#12288;&#12288;      CA_EVENT_LOSS<span style="color: #8b6508;">,</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">loss timeout </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;      CA_EVENT_FAST_ACK<span style="color: #8b6508;">,</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">in sequence ack </span><span style="color: #b22222;">*/</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;      CA_EVENT_SLOW_ACK<span style="color: #8b6508;">,</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">other ack </span><span style="color: #b22222;">*/</span>  
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;   <span style="color: #cd2626;">}</span><span style="color: #8b6508;">;</span>  
</pre>

    　　　 <br/>
</p></div>

</div>

<div id="outline-container-7-8-2" class="outline-4">
<h4 id="sec-7-8-2"><span class="section-number-4">7.8.2</span> 钩子函数定义</h4>
<div class="outline-text-4" id="text-7-8-2">


<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span>&#12288;&#12288;&#12288;   <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_congestion_ops</span> <span style="color: #cd2626;">{</span>  
<span class="linenr">2:  </span>&#12288;&#12288;&#12288;       <span style="color: #8b6508;">...</span>  
<span class="linenr">3:  </span>&#12288;&#12288;&#12288;     
<span class="linenr">4:  </span>&#12288;&#12288;&#12288;       <span style="color: #b22222;">/* </span><span style="color: #b22222;">call when cwnd event occurs (optional) </span><span style="color: #b22222;">*/</span>  
<span class="linenr">5:  </span>&#12288;&#12288;&#12288;       <span style="color: #228b22;">void</span> <span style="color: #cd2626;">(</span><span style="color: #8b6508;">*</span>cwnd_event<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">enum</span> <span style="color: #228b22;">tcp_ca_event</span> <span style="color: #a0522d;">ev</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">6:  </span>&#12288;&#12288;&#12288;     
<span class="linenr">7:  </span>&#12288;&#12288;&#12288;       <span style="color: #8b6508;">...</span>  
<span class="linenr">8:  </span>&#12288;&#12288;&#12288;   <span style="color: #cd2626;">}</span><span style="color: #8b6508;">;</span>  
</pre>

</p></div>

</div>

<div id="outline-container-7-8-3" class="outline-4">
<h4 id="sec-7-8-3"><span class="section-number-4">7.8.3</span> 封装调用</h4>
<div class="outline-text-4" id="text-7-8-3">


<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span>&#12288;&#12288;&#12288;  <span style="color: #a020f0;">static</span> <span style="color: #a020f0;">inline</span> <span style="color: #228b22;">void</span> <span style="color: #008000; font-weight: bold;">tcp_ca_event</span> <span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">enum</span> <span style="color: #228b22;">tcp_ca_event</span> <span style="color: #a0522d;">event</span><span style="color: #cd2626;">)</span>  
<span class="linenr">2:  </span>&#12288;&#12288;&#12288;  <span style="color: #cd2626;">{</span>  
<span class="linenr">3:  </span>&#12288;&#12288;&#12288;      <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">inet_connection_sock</span> <span style="color: #8b6508;">*</span>icsk <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">4:  </span>&#12288;&#12288;&#12288;    
<span class="linenr">5:  </span>&#12288;&#12288;&#12288;      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">cwnd_event</span><span style="color: #cd2626;">)</span>  
<span class="linenr">6:  </span>&#12288;&#12288;&#12288;          icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">cwnd_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> event<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">7:  </span>&#12288;&#12288;&#12288;  <span style="color: #cd2626;">}</span>  
</pre>

　　　 <br/>
</p></div>

</div>

<div id="outline-container-7-8-4" class="outline-4">
<h4 id="sec-7-8-4"><span class="section-number-4">7.8.4</span> CA_EVENT_TX_START</h4>
<div class="outline-text-4" id="text-7-8-4">

<p>　　　当发送一个数据包时，如果网络中无发送且未确认的数据包，则触发此事件。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;  <span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #008000; font-weight: bold;">tcp_transmit_skb</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">clone_it</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">gfp_t</span> <span style="color: #a0522d;">gfp_mask</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 2:  </span>&#12288;&#12288;&#12288;  <span style="color: #cd2626;">{</span>  
<span class="linenr"> 3:  </span>&#12288;&#12288;&#12288;      <span style="color: #8b6508;">...</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;    
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">tcp_packets_in_flight</span><span style="color: #cd2626;">(</span>tp<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">==</span> <span style="color: #ff0000;">0</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;          <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_TX_START<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;          skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ooo_okay</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/*</span><span style="color: #b22222;">&#27492;&#26102;&#21457;&#36865;&#38431;&#21015;&#21487;&#20197;&#25913;&#21464;&#65292;&#22240;&#20026;&#19978;&#38754;&#27809;&#26377;&#25968;&#25454;&#21253; </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 8:  </span>&#12288;&#12288;&#12288;    
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;      <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;           skb<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ooo_okay</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>   
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;       <span style="color: #8b6508;">...</span>  
<span class="linenr">12:  </span>&#12288;&#12288;&#12288;   <span style="color: #cd2626;">}</span>  
</pre>

　　　 <br/>
</p></div>

</div>

<div id="outline-container-7-8-5" class="outline-4">
<h4 id="sec-7-8-5"><span class="section-number-4">7.8.5</span> CA_EVENT_CWND_RESTART</h4>
<div class="outline-text-4" id="text-7-8-5">

<p>　　　发送方在发送数据包时，如果发送的数据包有负载，则会检测拥塞窗口是否超时。<br/>
　　　如果超时，则会使拥塞窗口失效并重新计算拥塞窗口，同时触发CA_EVENT_CWND_RESTART事件。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;  <span style="color: #b22222;">/* </span><span style="color: #b22222;">Congestion state accounting after a packet has been sent. </span><span style="color: #b22222;">*/</span>  &#12288;&#12288;&#12288;       
<span class="linenr"> 2:  </span>&#12288;&#12288;&#12288;  <span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #008000; font-weight: bold;">tcp_event_data_sent</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">tp</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 3:  </span>&#12288;&#12288;&#12288;  <span style="color: #cd2626;">{</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;      <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">inet_connection_sock</span> <span style="color: #8b6508;">*</span>icsk <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;      <span style="color: #a020f0;">const</span> u32 now <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;        
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;      <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>sysctl_tcp_slow_start_after_idle <span style="color: #8b6508;">&amp;&amp;</span>  
<span class="linenr"> 8:  </span><span style="color: #008000; font-weight: bold;">&#12288;&#12288;&#12288;</span>          <span style="color: #cd2626;">(</span>! tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">packets_out</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #cd2626;">(</span>s32<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">(</span>now <span style="color: #8b6508;">-</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lsndtime</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_rto</span><span style="color: #cd2626;">))</span>  
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;           <span style="color: #008000; font-weight: bold;">tcp_cwnd_restart</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">__sk_dst_get</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">))</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37325;&#32622;cwnd </span><span style="color: #b22222;">*/</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;      
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;       tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lsndtime</span> <span style="color: #8b6508;">=</span> now<span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#26368;&#36817;&#21457;&#21253;&#30340;&#26102;&#38388;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">12:  </span>&#12288;&#12288;&#12288;     
<span class="linenr">13:  </span>&#12288;&#12288;&#12288;       <span style="color: #b22222;">/* </span><span style="color: #b22222;">If it is a reply for ato after last received packet, enter pingpong mode. </span><span style="color: #b22222;">*/</span>  
<span class="linenr">14:  </span>&#12288;&#12288;&#12288;       <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>u32<span style="color: #cd2626;">)</span> <span style="color: #cd2626;">(</span>now <span style="color: #8b6508;">-</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">lrcvtime</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&lt;</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">ato</span><span style="color: #cd2626;">)</span>  
<span class="linenr">15:  </span>&#12288;&#12288;&#12288;           icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ack</span><span style="color: #8b6508;">.</span><span style="color: #008000;">pingpong</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>  
<span class="linenr">16:  </span>&#12288;&#12288;&#12288;   <span style="color: #cd2626;">}</span>  
</pre>

　　　 <br/>
　　　tcp_event_data_sent()中，符合三个条件才重置cwnd：<br/>
　　　（1）tcp_slow_start_after_idle选项设置，这个内核默认置为1<br/>
　　　（2）tp-&gt;packets_out == 0，表示网络中没有未确认数据包<br/>
　　　（3）now - tp-&gt;lsndtime &gt; icsk-&gt;icsk_rto，距离上次发送数据包的时间超过了RTO<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;  <span style="color: #b22222;">/* </span><span style="color: #b22222;">RFC2861. Reset CWND after idle period longer than RTO to "restart window". </span>
<span class="linenr"> 2:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288;   * This is the first part of cwnd validation mechanism. </span>
<span class="linenr"> 3:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288;   </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;  <span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #008000; font-weight: bold;">tcp_cwnd_restart</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">dst_entry</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">dst</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;  <span style="color: #cd2626;">{</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;      <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span>tp <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;      s32 delta <span style="color: #8b6508;">=</span> tcp_time_stamp <span style="color: #8b6508;">-</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">lsndtime</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36317;&#31163;&#19978;&#27425;&#21457;&#21253;&#30340;&#26102;&#38388;</span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 8:  </span>&#12288;&#12288;&#12288;      u32 restart_cwnd <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_init_cwnd</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> dst<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;       u32 cwnd <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">;</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;     
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;       <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_CWND_RESTART<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;&#36825;&#37324;&#65281;&#35302;&#21457;&#25317;&#22622;&#31383;&#21475;&#37325;&#32622;&#20107;&#20214;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">12:  </span>&#12288;&#12288;&#12288;       tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20445;&#23384;&#38408;&#20540;&#65292;&#24182;&#27809;&#26377;&#37325;&#32622;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">13:  </span>&#12288;&#12288;&#12288;       restart_cwnd <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">min</span><span style="color: #cd2626;">(</span>restart_cwnd<span style="color: #8b6508;">,</span> cwnd<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">14:  </span>&#12288;&#12288;&#12288;     
<span class="linenr">15:  </span>&#12288;&#12288;&#12288;       <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38386;&#32622;&#26102;&#38388;&#27599;&#36229;&#36807;&#19968;&#20010;RTO&#19988;cwnd&#27604;&#37325;&#32622;&#21518;&#30340;&#22823;&#26102;&#65292;cwnd&#20943;&#21322;&#12290;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">16:  </span>&#12288;&#12288;&#12288;       <span style="color: #a020f0;">while</span><span style="color: #cd2626;">((</span>delta <span style="color: #8b6508;">-=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_rto</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&gt;</span> <span style="color: #ff0000;">0</span> <span style="color: #8b6508;">&amp;&amp;</span> cwnd <span style="color: #8b6508;">&gt;</span> restart_cwnd<span style="color: #cd2626;">)</span>  
<span class="linenr">17:  </span>&#12288;&#12288;&#12288;           cwnd <span style="color: #8b6508;">&gt;&gt;=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>  
<span class="linenr">18:  </span>&#12288;&#12288;&#12288;     
<span class="linenr">19:  </span>&#12288;&#12288;&#12288;       tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">max</span><span style="color: #cd2626;">(</span>cwnd<span style="color: #8b6508;">,</span> restart_cwnd<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">20:  </span>&#12288;&#12288;&#12288;       tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_stamp</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>  
<span class="linenr">21:  </span>&#12288;&#12288;&#12288;       tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_used</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>  
<span class="linenr">22:  </span>&#12288;&#12288;&#12288;   <span style="color: #cd2626;">}</span>  
</pre>

</p></div>

</div>

<div id="outline-container-7-8-6" class="outline-4">
<h4 id="sec-7-8-6"><span class="section-number-4">7.8.6</span> CA_EVENT_COMPLETE_CWR</h4>
<div class="outline-text-4" id="text-7-8-6">

<p>　　　当退出CWR状态，或者退出Recovery状态时，会调用tcp_complete_cwr()来设置拥塞窗口，这个时候<br/>
　　　会触发CA_EVENT_COMPLETE_CWR来通知拥塞控制模块：“我已经停止减小拥塞窗口了！如果你想<br/>
　　　再做点什么补充，就是现在！”<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;  <span style="color: #a020f0;">static</span> <span style="color: #a020f0;">inline</span> <span style="color: #228b22;">void</span> <span style="color: #008000; font-weight: bold;">tcp_complete_cwr</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 2:  </span>&#12288;&#12288;&#12288;  <span style="color: #cd2626;">{</span>
<span class="linenr"> 3:  </span>&#12288;&#12288;&#12288;     <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span>tp <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;   
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;     <span style="color: #b22222;">/* </span><span style="color: #b22222;">Do not moderate cwnd if it's already undone in cwr or recovery. </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">undo_marker</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span>  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">==</span> TCP_CA_CWR<span style="color: #cd2626;">)</span>  
<span class="linenr"> 8:  </span>&#12288;&#12288;&#12288;             tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">min</span><span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">,</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;         <span style="color: #a020f0;">else</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">PRR </span><span style="color: #b22222;">*/</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;              tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span><span style="color: #8b6508;">;</span>  
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;    
<span class="linenr">12:  </span>&#12288;&#12288;&#12288;          tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_stamp</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>  
<span class="linenr">13:  </span>&#12288;&#12288;&#12288;      <span style="color: #cd2626;">}</span>  
<span class="linenr">14:  </span>&#12288;&#12288;&#12288;     
<span class="linenr">15:  </span>&#12288;&#12288;&#12288;      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22312;&#36825;&#37324;&#35774;&#32622;&#25317;&#22622;&#31383;&#21475;&#21644;&#24930;&#21551;&#21160;&#38408;&#20540;&#20250;&#35206;&#30422;&#25481;ssthresh()&#30340;&#35774;&#32622;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">16:  </span>&#12288;&#12288;&#12288;      <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_COMPLETE_CWR<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">17:  </span>&#12288;&#12288;&#12288;  <span style="color: #cd2626;">}</span>  
</pre>

</p></div>

</div>

<div id="outline-container-7-8-7" class="outline-4">
<h4 id="sec-7-8-7"><span class="section-number-4">7.8.7</span> CA_EVENT_FRTO</h4>
<div class="outline-text-4" id="text-7-8-7">

<p>　　　启用F-RTO时，发生超时后，首先会进行F-RTO处理，看看这个超时是不是虚假的，如果不是的话<br/>
　　　再进行传统的超时重传。这时候会减小慢启动阈值，而拥塞窗口暂时保持不变。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;<span style="color: #b22222;">/* </span><span style="color: #b22222;">RTO occurred, but do not yet enter Loss state. Instead, defer RTO recovery a bit and use </span>
<span class="linenr"> 2:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288; * heuristics in tcp_process_frto() to detect if the RTO was spurious. </span>
<span class="linenr"> 3:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288; </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;<span style="color: #228b22;">void</span> <span style="color: #008000; font-weight: bold;">tcp_enter_frto</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;<span style="color: #cd2626;">{</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;    <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">inet_connection_sock</span> <span style="color: #8b6508;">*</span>icsk <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span>tp <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 8:  </span>&#12288;&#12288;&#12288;    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span>skb<span style="color: #8b6508;">;</span>  
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;    
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">((</span>! tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frto_counter</span> <span style="color: #8b6508;">&amp;&amp;</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">&lt;=</span> TCP_CA_Disorder<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">||</span>  
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">==</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span> <span style="color: #8b6508;">||</span>  
<span class="linenr">12:  </span><span style="color: #008000; font-weight: bold;">&#12288;&#12288;&#12288;</span>         <span style="color: #cd2626;">((</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">==</span> TCP_CA_Loss <span style="color: #8b6508;">||</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frto_counter</span><span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span>  
<span class="linenr">13:  </span>&#12288;&#12288;&#12288;          ! icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_retransmits</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>  
<span class="linenr">14:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">15:  </span>&#12288;&#12288;&#12288;         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20445;&#30041;&#26087;&#38408;&#20540;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">16:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">17:  </span>&#12288;&#12288;&#12288;         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">frto_counter</span><span style="color: #cd2626;">)</span> <span style="color: #cd2626;">{</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36825;&#31181;&#24773;&#20917;&#38750;&#24120;&#32597;&#35265;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">18:  </span>&#12288;&#12288;&#12288;             u32 stored_cwnd<span style="color: #8b6508;">;</span>  
<span class="linenr">19:  </span>&#12288;&#12288;&#12288;             stored_cwnd <span style="color: #8b6508;">=</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span><span style="color: #8b6508;">;</span>  
<span class="linenr">20:  </span>&#12288;&#12288;&#12288;             tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">2</span><span style="color: #8b6508;">;</span>  
<span class="linenr">21:  </span>&#12288;&#12288;&#12288;             tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">22:  </span>&#12288;&#12288;&#12288;             tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> stored_cwnd<span style="color: #8b6508;">;</span>  
<span class="linenr">23:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">24:  </span>&#12288;&#12288;&#12288;         <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span>  
<span class="linenr">25:  </span>&#12288;&#12288;&#12288;             tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37325;&#26032;&#35774;&#32622;&#24930;&#21551;&#21160;&#38408;&#20540;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">26:  </span>&#12288;&#12288;&#12288;         <span style="color: #cd2626;">}</span>  
<span class="linenr">27:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">28:  </span>&#12288;&#12288;&#12288;         <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_FRTO<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36825;&#37324;&#35774;&#32622;&#24930;&#21551;&#21160;&#38408;&#20540;&#20250;&#35206;&#30422;&#25481;ssthresh()&#30340;&#35774;&#32622;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">29:  </span>&#12288;&#12288;&#12288;     <span style="color: #cd2626;">}</span>  
<span class="linenr">30:  </span>&#12288;&#12288;&#12288;     <span style="color: #8b6508;">...</span>  
<span class="linenr">31:  </span>&#12288;&#12288;&#12288; <span style="color: #cd2626;">}</span>  
</pre>

</p></div>

</div>

<div id="outline-container-7-8-8" class="outline-4">
<h4 id="sec-7-8-8"><span class="section-number-4">7.8.8</span> CA_EVENT_LOSS</h4>
<div class="outline-text-4" id="text-7-8-8">

<p>　　　上面我们说到，如果超时不是虚假的话，就会进入超时重传，也就是TCP_CA_Loss状态。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;<span style="color: #b22222;">/* </span><span style="color: #b22222;">Enter Loss state. If "how" is not zero, forget all SACK information and reset tags completely, </span>
<span class="linenr"> 2:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288; * otherwise preserve SACKs. If receiver dropped its ofo queue, we will know this due to </span>
<span class="linenr"> 3:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288; * reneging detection. </span>
<span class="linenr"> 4:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288; </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;<span style="color: #228b22;">void</span> <span style="color: #008000; font-weight: bold;">tcp_enter_loss</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">how</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;<span style="color: #cd2626;">{</span>  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;    <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">inet_connection_sock</span> <span style="color: #8b6508;">*</span>icsk <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">inet_csk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 8:  </span>&#12288;&#12288;&#12288;    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">tcp_sock</span> <span style="color: #8b6508;">*</span>tp <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_sk</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;     <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span>skb<span style="color: #8b6508;">;</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;    
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;     <span style="color: #b22222;">/* </span><span style="color: #b22222;">Reduce ssthresh if it has not yet been made inside this window. </span>
<span class="linenr">12:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288;      * &#35201;&#20040;&#26159;&#20174;Open&#25110;Disorder&#29366;&#24577;&#36827;&#20837;Loss&#29366;&#24577;&#65292;&#35201;&#20040;&#26159;&#22312;Loss&#29366;&#24577;&#21448;&#21457;&#29983;&#20102;&#36229;&#26102;&#65306;&#65289; </span>
<span class="linenr">13:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288;      * &#25105;&#20204;&#30693;&#36947;&#22312;CWR&#25110;Recovery&#29366;&#24577;&#20013;&#21487;&#20197;&#20197;&#36827;&#20837;Loss&#65292;&#20294;&#22312;&#37027;&#20004;&#20010;&#29366;&#24577;&#20013;&#38408;&#20540;&#24050;&#32463;&#34987;&#37325;&#32622;&#36807;&#20102;&#12290; </span>
<span class="linenr">14:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288;      </span><span style="color: #b22222;">*/</span>  
<span class="linenr">15:  </span>&#12288;&#12288;&#12288;     <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">&lt;=</span> TCP_CA_Disorder <span style="color: #8b6508;">||</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">==</span> tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">high_seq</span> <span style="color: #8b6508;">||</span>  
<span class="linenr">16:  </span><span style="color: #008000; font-weight: bold;">&#12288;&#12288;&#12288;</span>         <span style="color: #cd2626;">(</span>icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_state</span> <span style="color: #8b6508;">==</span> TCP_CA_Loss <span style="color: #8b6508;">&amp;&amp;</span> ! icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_retransmits</span><span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>  
<span class="linenr">17:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">18:  </span>&#12288;&#12288;&#12288;         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">prior_ssthresh</span> <span style="color: #8b6508;">=</span> <span style="color: #008000; font-weight: bold;">tcp_current_ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20445;&#23384;&#26087;&#38408;&#20540;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">19:  </span>&#12288;&#12288;&#12288;         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_ssthresh</span> <span style="color: #8b6508;">=</span> icsk<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">icsk_ca_ops</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">ssthresh</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37325;&#26032;&#35774;&#32622;&#24930;&#21551;&#21160;&#38408;&#20540;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">20:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">21:  </span>&#12288;&#12288;&#12288;         <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_LOSS<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36825;&#37324;&#35774;&#32622;&#24930;&#21551;&#21160;&#38408;&#20540;&#20250;&#35206;&#30422;&#25481;ssthresh()&#30340;&#35774;&#32622;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">22:  </span>&#12288;&#12288;&#12288;     <span style="color: #cd2626;">}</span>  
<span class="linenr">23:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">24:  </span>&#12288;&#12288;&#12288;     tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">1</span><span style="color: #8b6508;">;</span>  
<span class="linenr">25:  </span>&#12288;&#12288;&#12288;     tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_cnt</span> <span style="color: #8b6508;">=</span> <span style="color: #ff0000;">0</span><span style="color: #8b6508;">;</span>  
<span class="linenr">26:  </span>&#12288;&#12288;&#12288;     tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_cwnd_stamp</span> <span style="color: #8b6508;">=</span> tcp_time_stamp<span style="color: #8b6508;">;</span>  
<span class="linenr">27:  </span>&#12288;&#12288;&#12288;     <span style="color: #8b6508;">...</span>  
<span class="linenr">28:  </span>&#12288;&#12288;&#12288; <span style="color: #cd2626;">}</span>   
</pre>

　　　 <br/>
</p></div>

</div>

<div id="outline-container-7-8-9" class="outline-4">
<h4 id="sec-7-8-9"><span class="section-number-4">7.8.9</span> CA_EVENT_FAST_ACK</h4>
<div class="outline-text-4" id="text-7-8-9">

<p>　　　如果我们收到符合预期的ACK，那么就进入快速路径的处理流程，在tcp_ack()中进行负荷无关的处理，<br/>
　　　同时触发CA_EVENT_FAST_ACK事件。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;<span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #008000; font-weight: bold;">tcp_ack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 2:  </span>&#12288;&#12288;&#12288;<span style="color: #cd2626;">{</span>  
<span class="linenr"> 3:  </span>&#12288;&#12288;&#12288;    <span style="color: #8b6508;">...</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22788;&#20110;&#24555;&#36895;&#36335;&#24452;&#20013;</span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>! <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_SLOWPATH<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">after</span><span style="color: #cd2626;">(</span>ack<span style="color: #8b6508;">,</span> prior_snd_una<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;        <span style="color: #b22222;">/* </span><span style="color: #b22222;">Window is constant, pure forward advance. </span>
<span class="linenr"> 8:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288;         * No more checks are required. </span>
<span class="linenr"> 9:  </span><span style="color: #b22222;">&#12288;&#12288;&#12288;         </span><span style="color: #b22222;">*/</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;         <span style="color: #008000; font-weight: bold;">tcp_update_w1</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> ack_seq<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/*</span><span style="color: #b22222;">&#35760;&#24405;&#26356;&#26032;&#21457;&#36865;&#31383;&#21475;&#30340;ACK&#27573;&#24207;&#21495;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;         tp<span style="color: #008b45;">-&gt;</span><span style="color: #008000;">snd_una</span> <span style="color: #8b6508;">=</span> ack<span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#21457;&#36865;&#31383;&#21475;&#24038;&#31471; </span><span style="color: #b22222;">*/</span>  
<span class="linenr">12:  </span>&#12288;&#12288;&#12288;         flag <span style="color: #8b6508;">|=</span> FLAG_WIN_UPDATE<span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;&#21457;&#36865;&#31383;&#21475;&#26356;&#26032;&#26631;&#24535; </span><span style="color: #b22222;">*/</span>  
<span class="linenr">13:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">14:  </span>&#12288;&#12288;&#12288;         <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_FAST_ACK<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24555;&#36895;&#36335;&#24452;&#25317;&#22622;&#20107;&#20214;&#38057;&#23376;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">15:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">16:  </span>&#12288;&#12288;&#12288;         <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_net</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span> LINUX_MIB_TCPHPACKS<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">17:  </span>&#12288;&#12288;&#12288;     <span style="color: #cd2626;">}</span>  
<span class="linenr">18:  </span>&#12288;&#12288;&#12288;    <span style="color: #8b6508;">...</span>  
<span class="linenr">19:  </span>&#12288;&#12288;&#12288; <span style="color: #cd2626;">}</span>  
</pre>

　　　 <br/>
</p></div>

</div>

<div id="outline-container-7-8-10" class="outline-4">
<h4 id="sec-7-8-10"><span class="section-number-4">7.8.10</span> CA_EVENT_SLOW_ACK</h4>
<div class="outline-text-4" id="text-7-8-10">

<p>　　　如果我们收到不符合预期的ACK，那么就不能走快速路径，而必须经过全面的检查，即进入慢速路径的<br/>
　　　处理流程。同样在tcp_ack()中进行负荷无关的处理，同时触发CA_EVENT_SLOW_ACK事件。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span>&#12288;&#12288;&#12288;<span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #008000; font-weight: bold;">tcp_ack</span><span style="color: #cd2626;">(</span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sock</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">sk</span><span style="color: #8b6508;">,</span> <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">sk_buff</span> <span style="color: #8b6508;">*</span><span style="color: #a0522d;">skb</span><span style="color: #8b6508;">,</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">flag</span><span style="color: #cd2626;">)</span>  
<span class="linenr"> 2:  </span>&#12288;&#12288;&#12288;<span style="color: #cd2626;">{</span>  
<span class="linenr"> 3:  </span>&#12288;&#12288;&#12288;    <span style="color: #8b6508;">...</span>  
<span class="linenr"> 4:  </span>&#12288;&#12288;&#12288;    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#22788;&#20110;&#24555;&#36895;&#36335;&#24452;&#20013;</span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 5:  </span>&#12288;&#12288;&#12288;    <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>! <span style="color: #cd2626;">(</span>flag <span style="color: #8b6508;">&amp;</span> FLAG_SLOWPATH<span style="color: #cd2626;">)</span> <span style="color: #8b6508;">&amp;&amp;</span> <span style="color: #008000; font-weight: bold;">after</span><span style="color: #cd2626;">(</span>ack<span style="color: #8b6508;">,</span> prior_snd_una<span style="color: #cd2626;">))</span> <span style="color: #cd2626;">{</span>  
<span class="linenr"> 6:  </span>&#12288;&#12288;&#12288;        <span style="color: #8b6508;">...</span>  
<span class="linenr"> 7:  </span>&#12288;&#12288;&#12288;  
<span class="linenr"> 8:  </span>&#12288;&#12288;&#12288;    <span style="color: #cd2626;">}</span> <span style="color: #a020f0;">else</span> <span style="color: #cd2626;">{</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36827;&#20837;&#24930;&#36895;&#36335;&#24452; </span><span style="color: #b22222;">*/</span>  
<span class="linenr"> 9:  </span>&#12288;&#12288;&#12288;        <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span>ack_seq <span style="color: #8b6508;">!=</span> <span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">end_seq</span><span style="color: #cd2626;">)</span>  
<span class="linenr">10:  </span>&#12288;&#12288;&#12288;             flag <span style="color: #8b6508;">|=</span> FLAG_DATA<span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#27492;ACK&#25658;&#24102;&#36127;&#33655;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">11:  </span>&#12288;&#12288;&#12288;         <span style="color: #a020f0;">else</span>  
<span class="linenr">12:  </span>&#12288;&#12288;&#12288;             <span style="color: #008000; font-weight: bold;">NET_INC_STATS_BH</span><span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">sock_net</span><span style="color: #cd2626;">(</span>sk<span style="color: #cd2626;">)</span><span style="color: #8b6508;">,</span> LINUX_MIB_TCPPUREACKS<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">13:  </span>&#12288;&#12288;&#12288;   
<span class="linenr">14:  </span>&#12288;&#12288;&#12288;         flag <span style="color: #8b6508;">|=</span> <span style="color: #008000; font-weight: bold;">tcp_ack_update_window</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> ack<span style="color: #8b6508;">,</span> ack_seq<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#21457;&#36865;&#31383;&#21475;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">15:  </span>&#12288;&#12288;&#12288;           
<span class="linenr">16:  </span>&#12288;&#12288;&#12288;          <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26681;&#25454;SACK&#36873;&#39033;&#26631;&#24535;&#37325;&#20256;&#38431;&#21015;&#20013;SKB&#30340;&#35760;&#20998;&#29260;&#29366;&#24577;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">17:  </span>&#12288;&#12288;&#12288;         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_SKB_CB</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)</span><span style="color: #008b45;">-&gt;</span><span style="color: #008000;">sacked</span><span style="color: #cd2626;">)</span>  
<span class="linenr">18:  </span>&#12288;&#12288;&#12288;             flag <span style="color: #8b6508;">|=</span> <span style="color: #008000; font-weight: bold;">tcp_sacktag_write_queue</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> skb<span style="color: #8b6508;">,</span> prior_snd_una<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span>  
<span class="linenr">19:  </span>&#12288;&#12288;&#12288;    
<span class="linenr">20:  </span>&#12288;&#12288;&#12288;         <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26597;&#30475;ACK&#26159;&#21542;&#25658;&#24102;ECE&#26631;&#24535; </span><span style="color: #b22222;">*/</span>  
<span class="linenr">21:  </span>&#12288;&#12288;&#12288;         <span style="color: #a020f0;">if</span> <span style="color: #cd2626;">(</span><span style="color: #008000; font-weight: bold;">TCP_ECN_rcv_ecn_echo</span><span style="color: #cd2626;">(</span>tp<span style="color: #8b6508;">,</span> <span style="color: #008000; font-weight: bold;">tcp_hdr</span><span style="color: #cd2626;">(</span>skb<span style="color: #cd2626;">)))</span>  
<span class="linenr">22:  </span>&#12288;&#12288;&#12288;             flag <span style="color: #8b6508;">|=</span> FLAG_ECE<span style="color: #8b6508;">;</span>  
<span class="linenr">23:  </span>&#12288;&#12288;&#12288;    
<span class="linenr">24:  </span>&#12288;&#12288;&#12288;         <span style="color: #008000; font-weight: bold;">tcp_ca_event</span><span style="color: #cd2626;">(</span>sk<span style="color: #8b6508;">,</span> CA_EVENT_SLOW_ACK<span style="color: #cd2626;">)</span><span style="color: #8b6508;">;</span> <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24930;&#36895;&#36335;&#24452;&#25317;&#22622;&#20107;&#20214;&#38057;&#23376;</span><span style="color: #b22222;">*/</span>  
<span class="linenr">25:  </span>&#12288;&#12288;&#12288;     <span style="color: #cd2626;">}</span>  
<span class="linenr">26:  </span>&#12288;&#12288;&#12288;     <span style="color: #8b6508;">...</span>  
<span class="linenr">27:  </span>&#12288;&#12288;&#12288; <span style="color: #cd2626;">}</span>  
</pre>

　　　 <br/>
</p></div>

</div>

<div id="outline-container-7-8-11" class="outline-4">
<h4 id="sec-7-8-11"><span class="section-number-4">7.8.11</span> 阈值的设置</h4>
<div class="outline-text-4" id="text-7-8-11">

<p>　　　用拥塞算法的ssthresh()来设置慢启动阈值tp-&gt;snd_ssthresh。<br/>
　　　（1）tcp_enter_cwr<br/>
　　　    进入CWR状态时。<br/>
　　　    Set slow start threshold and cwnd not falling to slow start.<br/>
　　　（2）tcp_enter_frto<br/>
　　　    进入FRTO处理时。<br/>
　　　（3）tcp_enter_loss<br/>
　　　     进入Loss状态时。<br/>
　　　（4）tcp_fastretrans_alert<br/>
　　　    进入Recovery状态时。<br/>
　　　可见ssthresh()的调用时机是在进入CWR、FRTO、Loss、Recovery这几个异常状态时。<br/>
　　　 <br/>
　　　tp-&gt;snd_ssthresh的使用：<br/>
　　　（1）在进入CWR、FRTO、Loss、Recovery时调用ssthresh()重新设置，在退出这些状态时，作为慢启动阈值。<br/>
　　　（2）作为tcp_cwnd_min()的返回值，在tcp_cwnd_down()中被调用，而tcp_cwnd_down()在CWR和Recovery<br/>
　　　    状态中被调用。<br/>
　　　（3）退出CWR、Recovery状态时，赋值给tp-&gt;snd_cwnd，避免进入慢启动。<br/>
</p>
<p>        <br/>
</p></div>
</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> 第30章 TCP的输出</h2>
<div class="outline-text-2" id="text-8">


</div>

<div id="outline-container-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> tcp_sendmsg()</h3>
<div class="outline-text-3" id="text-8-1">

<ol>
<li>先计算应该copy的序号与位置，设置skb-&gt;end_seq.<br/>
      TCP_SKB_CB(skb)-&gt;end_seq += copy;<br/>
</li>
<li>通过调用__tcp_push_pending_frames()发送队列的段。<br/>
      __tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH);<br/>
</li>
</ol>


<p>      <br/>
</p>
</div>

<div id="outline-container-8-1-1" class="outline-4">
<h4 id="sec-8-1-1"><span class="section-number-4">8.1.1</span> tcp_write_xmit()</h4>
<div class="outline-text-4" id="text-8-1-1">

<ol>
<li>使用tcp_cwnd_test()检查拥塞窗口是否还有空间。<br/>
</li>
<li>使用tcp_snd_wnd_test()检查滑动窗口是否还有空间。<br/>
</li>
<li>使用tcp_transmit_skb()发送当前skb.<br/>
</li>
<li>使用tcp_event_new_data_sent()递增packets_out.<br/>
</li>
</ol>


<p><br/>
</p><div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn-.1" href="#fnr-.1">1</a></sup> DEFINITION NOT FOUND: 5472<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.2" href="#fnr-.2">2</a></sup> DEFINITION NOT FOUND: 5713<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.3" href="#fnr-.3">3</a></sup> DEFINITION NOT FOUND: 203<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.4" href="#fnr-.4">4</a></sup> DEFINITION NOT FOUND: 1972<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.5" href="#fnr-.5">5</a></sup> DEFINITION NOT FOUND: 4030<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.6" href="#fnr-.6">6</a></sup> DEFINITION NOT FOUND: 5763<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.7" href="#fnr-.7">7</a></sup> DEFINITION NOT FOUND: 5772<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.8" href="#fnr-.8">8</a></sup> DEFINITION NOT FOUND: 504<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.9" href="#fnr-.9">9</a></sup> DEFINITION NOT FOUND: 357<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.10" href="#fnr-.10">10</a></sup> DEFINITION NOT FOUND: 5779<br/>
</p>
<p><br/>
</p>
<p class="footnote"><sup><a class="footnum" name="fn-.11" href="#fnr-.11">11</a></sup> DEFINITION NOT FOUND: 75<br/>
</p>
<p><br/>
</p>
<p><br/>
</p>
<p>      <br/>
</p></div>
</div>
</div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2014-10-20T16:32+0800</p>
<p class="author">Author: mosp</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.3f with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
